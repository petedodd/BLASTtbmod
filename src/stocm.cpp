// Generated by dust (version 0.15.3) - do not edit
#include <cpp11.hpp>

[[cpp11::register]]
cpp11::sexp dust_stocm_gpu_info();
[[cpp11::register]]
SEXP dust_cpu_stocm_alloc(cpp11::list r_pars, bool pars_multi, cpp11::sexp r_time,
                         cpp11::sexp r_n_particles, int n_threads,
                         cpp11::sexp r_seed, bool deterministic,
                         cpp11::sexp gpu_config, cpp11::sexp ode_control);

[[cpp11::register]]
cpp11::sexp dust_cpu_stocm_capabilities();

[[cpp11::register]]
SEXP dust_cpu_stocm_run(SEXP ptr, cpp11::sexp r_time_end);

[[cpp11::register]]
SEXP dust_cpu_stocm_simulate(SEXP ptr, cpp11::sexp time_end);

[[cpp11::register]]
SEXP dust_cpu_stocm_run_adjoint(SEXP ptr);

[[cpp11::register]]
SEXP dust_cpu_stocm_set_index(SEXP ptr, cpp11::sexp r_index);

[[cpp11::register]]
SEXP dust_cpu_stocm_update_state(SEXP ptr, SEXP r_pars, SEXP r_state,
                                           SEXP r_time, SEXP r_set_initial_state,
                                           SEXP index, SEXP reset_step_size);

[[cpp11::register]]
SEXP dust_cpu_stocm_state(SEXP ptr, SEXP r_index);

[[cpp11::register]]
SEXP dust_cpu_stocm_time(SEXP ptr);

[[cpp11::register]]
void dust_cpu_stocm_reorder(SEXP ptr, cpp11::sexp r_index);

[[cpp11::register]]
SEXP dust_cpu_stocm_resample(SEXP ptr, cpp11::doubles r_weights);

[[cpp11::register]]
SEXP dust_cpu_stocm_rng_state(SEXP ptr, bool first_only, bool last_only);

[[cpp11::register]]
SEXP dust_cpu_stocm_set_rng_state(SEXP ptr, cpp11::raws rng_state);

[[cpp11::register]]
SEXP dust_cpu_stocm_set_data(SEXP ptr, cpp11::list data, bool shared);

[[cpp11::register]]
SEXP dust_cpu_stocm_compare_data(SEXP ptr);

[[cpp11::register]]
SEXP dust_cpu_stocm_filter(SEXP ptr, SEXP time_end,
                                     bool save_trajectories,
                                     cpp11::sexp time_snapshot,
                                     cpp11::sexp min_log_likelihood);

[[cpp11::register]]
void dust_cpu_stocm_set_n_threads(SEXP ptr, int n_threads);

[[cpp11::register]]
int dust_cpu_stocm_n_state(SEXP ptr);

[[cpp11::register]]
void dust_cpu_stocm_set_stochastic_schedule(SEXP ptr, SEXP time);

[[cpp11::register]]
SEXP dust_cpu_stocm_ode_statistics(SEXP ptr);
#include <dust/r/dust.hpp>

// Generated by odin.dust (version 0.3.11) - do not edit
template <typename real_type, typename container>
__host__ __device__ real_type odin_sum1(const container x, size_t from, size_t to);
template <typename real_type, typename container>
__host__ __device__ real_type odin_sum2(const container x, int from_i, int to_i, int from_j, int to_j, int dim_x_1);
template <typename real_type, typename container>
__host__ __device__ real_type odin_sum3(const container x, int from_i, int to_i, int from_j, int to_j, int from_k, int to_k, int dim_x_1, int dim_x_12);
// [[dust::class(stocm)]]
// [[dust::time_type(discrete)]]
// [[dust::param(age_dims, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(age_rate, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(agefracs, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(ageMids, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(ari0, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(ART_int, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(beta, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(births_int, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(cdr, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(cdr_SC, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(cfr, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(dt, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(dur, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(epsi, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(Hirr, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(HIV_dims, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(HIV_int, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(initD, has_default = FALSE, default_value = NULL, rank = 2, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(IRR, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(m_in_int, has_default = FALSE, default_value = NULL, rank = 2, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(MM, has_default = FALSE, default_value = NULL, rank = 2, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(mu_ART_int, has_default = FALSE, default_value = NULL, rank = 2, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(mu_HIV_int, has_default = FALSE, default_value = NULL, rank = 2, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(mu_noHIV_int, has_default = FALSE, default_value = NULL, rank = 2, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(patch_dims, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(pDf, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(pDr, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(pDs, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(Pi, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(pLL, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(popinit, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(progress_rate, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(regress_rate, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(sim_length, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(TB_HIV_mod, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(tfr, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(tt, has_default = FALSE, default_value = NULL, rank = 1, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(v, has_default = FALSE, default_value = NULL, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(relinf, has_default = TRUE, default_value = 1L, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
// [[dust::param(t_dur, has_default = TRUE, default_value = 0.5, rank = 0, min = -Inf, max = Inf, integer = FALSE)]]
class stocm {
public:
  using real_type = double;
  using rng_state_type = dust::random::generator<real_type>;
  using data_type = dust::no_data;
  struct shared_type {
    std::vector<real_type> A;
    real_type A0;
    int age_dims;
    std::vector<real_type> age_rate;
    std::vector<real_type> agefracs;
    std::vector<real_type> ageMids;
    real_type ari0;
    std::vector<real_type> ART_int;
    real_type beta;
    std::vector<real_type> births_int;
    real_type cdr;
    real_type cdr_SC;
    real_type cfr;
    int dim_A;
    int dim_age_in_D;
    int dim_age_in_D_1;
    int dim_age_in_D_12;
    int dim_age_in_D_2;
    int dim_age_in_D_3;
    int dim_age_in_LL;
    int dim_age_in_LL_1;
    int dim_age_in_LL_12;
    int dim_age_in_LL_2;
    int dim_age_in_LL_3;
    int dim_age_in_LR;
    int dim_age_in_LR_1;
    int dim_age_in_LR_12;
    int dim_age_in_LR_2;
    int dim_age_in_LR_3;
    int dim_age_in_R;
    int dim_age_in_R_1;
    int dim_age_in_R_12;
    int dim_age_in_R_2;
    int dim_age_in_R_3;
    int dim_age_in_SC;
    int dim_age_in_SC_1;
    int dim_age_in_SC_12;
    int dim_age_in_SC_2;
    int dim_age_in_SC_3;
    int dim_age_in_Tr;
    int dim_age_in_Tr_1;
    int dim_age_in_Tr_12;
    int dim_age_in_Tr_2;
    int dim_age_in_Tr_3;
    int dim_age_in_U;
    int dim_age_in_U_1;
    int dim_age_in_U_12;
    int dim_age_in_U_2;
    int dim_age_in_U_3;
    int dim_age_out_D;
    int dim_age_out_D_1;
    int dim_age_out_D_12;
    int dim_age_out_D_2;
    int dim_age_out_D_3;
    int dim_age_out_LL;
    int dim_age_out_LL_1;
    int dim_age_out_LL_12;
    int dim_age_out_LL_2;
    int dim_age_out_LL_3;
    int dim_age_out_LR;
    int dim_age_out_LR_1;
    int dim_age_out_LR_12;
    int dim_age_out_LR_2;
    int dim_age_out_LR_3;
    int dim_age_out_R;
    int dim_age_out_R_1;
    int dim_age_out_R_12;
    int dim_age_out_R_2;
    int dim_age_out_R_3;
    int dim_age_out_SC;
    int dim_age_out_SC_1;
    int dim_age_out_SC_12;
    int dim_age_out_SC_2;
    int dim_age_out_SC_3;
    int dim_age_out_Tr;
    int dim_age_out_Tr_1;
    int dim_age_out_Tr_12;
    int dim_age_out_Tr_2;
    int dim_age_out_Tr_3;
    int dim_age_out_U;
    int dim_age_out_U_1;
    int dim_age_out_U_12;
    int dim_age_out_U_2;
    int dim_age_out_U_3;
    int dim_age_rate;
    int dim_agefracs;
    int dim_ageMids;
    int dim_ART_int;
    int dim_ART_rate_yr;
    int dim_bg_deaths;
    int dim_bg_deaths_1;
    int dim_bg_deaths_12;
    int dim_bg_deaths_2;
    int dim_bg_deaths_3;
    int dim_births;
    int dim_births_1;
    int dim_births_12;
    int dim_births_2;
    int dim_births_3;
    int dim_births_int;
    int dim_cum_inf_flux;
    int dim_cum_inf_flux_1;
    int dim_cum_inf_flux_2;
    int dim_cum_note_flux;
    int dim_cum_note_flux_1;
    int dim_cum_note_flux_2;
    int dim_D;
    int dim_D_1;
    int dim_D_12;
    int dim_D_2;
    int dim_D_3;
    int dim_D_inmigr;
    int dim_D_inmigr_1;
    int dim_D_inmigr_12;
    int dim_D_inmigr_2;
    int dim_D_inmigr_3;
    int dim_Ddeaths;
    int dim_Ddeaths_1;
    int dim_Ddeaths_12;
    int dim_Ddeaths_2;
    int dim_Ddeaths_3;
    int dim_detection;
    int dim_detection_1;
    int dim_detection_12;
    int dim_detection_2;
    int dim_detection_3;
    int dim_detection_SC;
    int dim_detection_SC_1;
    int dim_detection_SC_12;
    int dim_detection_SC_2;
    int dim_detection_SC_3;
    int dim_elli;
    int dim_ellij;
    int dim_ellij_1;
    int dim_ellij_2;
    int dim_foi;
    int dim_foitemp;
    int dim_foitemp_1;
    int dim_foitemp_2;
    int dim_Hirr;
    int dim_HIV_in_D;
    int dim_HIV_in_D_1;
    int dim_HIV_in_D_12;
    int dim_HIV_in_D_2;
    int dim_HIV_in_D_3;
    int dim_HIV_in_LL;
    int dim_HIV_in_LL_1;
    int dim_HIV_in_LL_12;
    int dim_HIV_in_LL_2;
    int dim_HIV_in_LL_3;
    int dim_HIV_in_LR;
    int dim_HIV_in_LR_1;
    int dim_HIV_in_LR_12;
    int dim_HIV_in_LR_2;
    int dim_HIV_in_LR_3;
    int dim_HIV_in_R;
    int dim_HIV_in_R_1;
    int dim_HIV_in_R_12;
    int dim_HIV_in_R_2;
    int dim_HIV_in_R_3;
    int dim_HIV_in_SC;
    int dim_HIV_in_SC_1;
    int dim_HIV_in_SC_12;
    int dim_HIV_in_SC_2;
    int dim_HIV_in_SC_3;
    int dim_HIV_in_Tr;
    int dim_HIV_in_Tr_1;
    int dim_HIV_in_Tr_12;
    int dim_HIV_in_Tr_2;
    int dim_HIV_in_Tr_3;
    int dim_HIV_in_U;
    int dim_HIV_in_U_1;
    int dim_HIV_in_U_12;
    int dim_HIV_in_U_2;
    int dim_HIV_in_U_3;
    int dim_HIV_int;
    int dim_HIV_out_D;
    int dim_HIV_out_D_1;
    int dim_HIV_out_D_12;
    int dim_HIV_out_D_2;
    int dim_HIV_out_D_3;
    int dim_HIV_out_LL;
    int dim_HIV_out_LL_1;
    int dim_HIV_out_LL_12;
    int dim_HIV_out_LL_2;
    int dim_HIV_out_LL_3;
    int dim_HIV_out_LR;
    int dim_HIV_out_LR_1;
    int dim_HIV_out_LR_12;
    int dim_HIV_out_LR_2;
    int dim_HIV_out_LR_3;
    int dim_HIV_out_R;
    int dim_HIV_out_R_1;
    int dim_HIV_out_R_12;
    int dim_HIV_out_R_2;
    int dim_HIV_out_R_3;
    int dim_HIV_out_SC;
    int dim_HIV_out_SC_1;
    int dim_HIV_out_SC_12;
    int dim_HIV_out_SC_2;
    int dim_HIV_out_SC_3;
    int dim_HIV_out_Tr;
    int dim_HIV_out_Tr_1;
    int dim_HIV_out_Tr_12;
    int dim_HIV_out_Tr_2;
    int dim_HIV_out_Tr_3;
    int dim_HIV_out_U;
    int dim_HIV_out_U_1;
    int dim_HIV_out_U_12;
    int dim_HIV_out_U_2;
    int dim_HIV_out_U_3;
    int dim_HIV_rate_yr;
    int dim_incidence;
    int dim_incidence_1;
    int dim_incidence_12;
    int dim_incidence_2;
    int dim_incidence_3;
    int dim_InfsByPatch;
    int dim_InfsByPatchPatch;
    int dim_InfsByPatchPatch_1;
    int dim_InfsByPatchPatch_2;
    int dim_init_D;
    int dim_init_D_1;
    int dim_init_D_2;
    int dim_init_LL;
    int dim_init_LL_1;
    int dim_init_LL_2;
    int dim_init_LR;
    int dim_init_LR_1;
    int dim_init_LR_2;
    int dim_init_R;
    int dim_init_R_1;
    int dim_init_R_2;
    int dim_init_SC;
    int dim_init_SC_1;
    int dim_init_SC_2;
    int dim_init_Tr;
    int dim_init_Tr_1;
    int dim_init_Tr_2;
    int dim_init_U;
    int dim_init_U_1;
    int dim_init_U_2;
    int dim_initD;
    int dim_initD_1;
    int dim_initD_2;
    int dim_initDenom;
    int dim_initDenom_1;
    int dim_initDenom_2;
    int dim_initF;
    int dim_initF_1;
    int dim_initF_2;
    int dim_initLL;
    int dim_initLL_1;
    int dim_initLL_2;
    int dim_initPrev;
    int dim_initPrev_1;
    int dim_initPrev_2;
    int dim_IRR;
    int dim_LL;
    int dim_LL_1;
    int dim_LL_12;
    int dim_LL_2;
    int dim_LL_3;
    int dim_LL_inmigr;
    int dim_LL_inmigr_1;
    int dim_LL_inmigr_12;
    int dim_LL_inmigr_2;
    int dim_LL_inmigr_3;
    int dim_LLdeaths;
    int dim_LLdeaths_1;
    int dim_LLdeaths_12;
    int dim_LLdeaths_2;
    int dim_LLdeaths_3;
    int dim_LLinfs;
    int dim_LLinfs_1;
    int dim_LLinfs_12;
    int dim_LLinfs_2;
    int dim_LLinfs_3;
    int dim_LR;
    int dim_LR_1;
    int dim_LR_12;
    int dim_LR_2;
    int dim_LR_3;
    int dim_LR_inmigr;
    int dim_LR_inmigr_1;
    int dim_LR_inmigr_12;
    int dim_LR_inmigr_2;
    int dim_LR_inmigr_3;
    int dim_LRdeaths;
    int dim_LRdeaths_1;
    int dim_LRdeaths_12;
    int dim_LRdeaths_2;
    int dim_LRdeaths_3;
    int dim_m_in_int;
    int dim_m_in_int_1;
    int dim_m_in_int_2;
    int dim_m_in_t;
    int dim_MM;
    int dim_MM_1;
    int dim_MM_2;
    int dim_mu_ART_int;
    int dim_mu_ART_int_1;
    int dim_mu_ART_int_2;
    int dim_mu_ART_t;
    int dim_mu_HIV_int;
    int dim_mu_HIV_int_1;
    int dim_mu_HIV_int_2;
    int dim_mu_HIV_t;
    int dim_mu_noHIV_int;
    int dim_mu_noHIV_int_1;
    int dim_mu_noHIV_int_2;
    int dim_mu_noHIV_t;
    int dim_N;
    int dim_N_1;
    int dim_N_12;
    int dim_N_2;
    int dim_N_3;
    int dim_Nevents_D;
    int dim_Nevents_D_1;
    int dim_Nevents_D_12;
    int dim_Nevents_D_2;
    int dim_Nevents_D_3;
    int dim_Nevents_LL;
    int dim_Nevents_LL_1;
    int dim_Nevents_LL_12;
    int dim_Nevents_LL_2;
    int dim_Nevents_LL_3;
    int dim_Nevents_LR;
    int dim_Nevents_LR_1;
    int dim_Nevents_LR_12;
    int dim_Nevents_LR_2;
    int dim_Nevents_LR_3;
    int dim_Nevents_R;
    int dim_Nevents_R_1;
    int dim_Nevents_R_12;
    int dim_Nevents_R_2;
    int dim_Nevents_R_3;
    int dim_Nevents_SC;
    int dim_Nevents_SC_1;
    int dim_Nevents_SC_12;
    int dim_Nevents_SC_2;
    int dim_Nevents_SC_3;
    int dim_Nevents_Tr;
    int dim_Nevents_Tr_1;
    int dim_Nevents_Tr_12;
    int dim_Nevents_Tr_2;
    int dim_Nevents_Tr_3;
    int dim_Nevents_U;
    int dim_Nevents_U_1;
    int dim_Nevents_U_12;
    int dim_Nevents_U_2;
    int dim_Nevents_U_3;
    int dim_notes;
    int dim_notes_1;
    int dim_notes_12;
    int dim_notes_2;
    int dim_notes_3;
    int dim_NotesByPatch;
    int dim_NotesByPatchPatch;
    int dim_NotesByPatchPatch_1;
    int dim_NotesByPatchPatch_2;
    int dim_notifrate;
    int dim_notifrate_1;
    int dim_notifrate_12;
    int dim_notifrate_2;
    int dim_notifrate_3;
    int dim_p_Dage;
    int dim_p_Dage_1;
    int dim_p_Dage_12;
    int dim_p_Dage_2;
    int dim_p_Dage_3;
    int dim_p_detect;
    int dim_p_detect_1;
    int dim_p_detect_12;
    int dim_p_detect_2;
    int dim_p_detect_3;
    int dim_p_detect_SC;
    int dim_p_detect_SC_1;
    int dim_p_detect_SC_12;
    int dim_p_detect_SC_2;
    int dim_p_detect_SC_3;
    int dim_p_DHIV;
    int dim_p_DHIV_1;
    int dim_p_DHIV_12;
    int dim_p_DHIV_2;
    int dim_p_DHIV_3;
    int dim_p_LLage;
    int dim_p_LLage_1;
    int dim_p_LLage_12;
    int dim_p_LLage_2;
    int dim_p_LLage_3;
    int dim_p_LLHIV;
    int dim_p_LLHIV_1;
    int dim_p_LLHIV_12;
    int dim_p_LLHIV_2;
    int dim_p_LLHIV_3;
    int dim_p_LLinfs;
    int dim_p_LLinfs_1;
    int dim_p_LLinfs_12;
    int dim_p_LLinfs_2;
    int dim_p_LLinfs_3;
    int dim_p_LRage;
    int dim_p_LRage_1;
    int dim_p_LRage_12;
    int dim_p_LRage_2;
    int dim_p_LRage_3;
    int dim_p_LRHIV;
    int dim_p_LRHIV_1;
    int dim_p_LRHIV_12;
    int dim_p_LRHIV_2;
    int dim_p_LRHIV_3;
    int dim_p_progFast;
    int dim_p_progFast_1;
    int dim_p_progFast_12;
    int dim_p_progFast_2;
    int dim_p_progFast_3;
    int dim_p_progress;
    int dim_p_progress_1;
    int dim_p_progress_12;
    int dim_p_progress_2;
    int dim_p_progress_3;
    int dim_p_progSlow;
    int dim_p_progSlow_1;
    int dim_p_progSlow_12;
    int dim_p_progSlow_2;
    int dim_p_progSlow_3;
    int dim_p_Rage;
    int dim_p_Rage_1;
    int dim_p_Rage_12;
    int dim_p_Rage_2;
    int dim_p_Rage_3;
    int dim_p_regress;
    int dim_p_regress_1;
    int dim_p_regress_12;
    int dim_p_regress_2;
    int dim_p_regress_3;
    int dim_p_relapse;
    int dim_p_relapse_1;
    int dim_p_relapse_12;
    int dim_p_relapse_2;
    int dim_p_relapse_3;
    int dim_p_RHIV;
    int dim_p_RHIV_1;
    int dim_p_RHIV_12;
    int dim_p_RHIV_2;
    int dim_p_RHIV_3;
    int dim_p_Rinfs;
    int dim_p_Rinfs_1;
    int dim_p_Rinfs_12;
    int dim_p_Rinfs_2;
    int dim_p_Rinfs_3;
    int dim_p_SCage;
    int dim_p_SCage_1;
    int dim_p_SCage_12;
    int dim_p_SCage_2;
    int dim_p_SCage_3;
    int dim_p_SCHIV;
    int dim_p_SCHIV_1;
    int dim_p_SCHIV_12;
    int dim_p_SCHIV_2;
    int dim_p_SCHIV_3;
    int dim_p_selfcr;
    int dim_p_selfcr_1;
    int dim_p_selfcr_12;
    int dim_p_selfcr_2;
    int dim_p_selfcr_3;
    int dim_p_selfcr_SC;
    int dim_p_selfcr_SC_1;
    int dim_p_selfcr_SC_12;
    int dim_p_selfcr_SC_2;
    int dim_p_selfcr_SC_3;
    int dim_p_stabilise;
    int dim_p_stabilise_1;
    int dim_p_stabilise_12;
    int dim_p_stabilise_2;
    int dim_p_stabilise_3;
    int dim_p_TBdeaths;
    int dim_p_TBdeaths_1;
    int dim_p_TBdeaths_12;
    int dim_p_TBdeaths_2;
    int dim_p_TBdeaths_3;
    int dim_p_TBdeaths_SC;
    int dim_p_TBdeaths_SC_1;
    int dim_p_TBdeaths_SC_12;
    int dim_p_TBdeaths_SC_2;
    int dim_p_TBdeaths_SC_3;
    int dim_p_Trage;
    int dim_p_Trage_1;
    int dim_p_Trage_12;
    int dim_p_Trage_2;
    int dim_p_Trage_3;
    int dim_p_TrHIV;
    int dim_p_TrHIV_1;
    int dim_p_TrHIV_12;
    int dim_p_TrHIV_2;
    int dim_p_TrHIV_3;
    int dim_p_Trsuccess;
    int dim_p_Trsuccess_1;
    int dim_p_Trsuccess_12;
    int dim_p_Trsuccess_2;
    int dim_p_Trsuccess_3;
    int dim_p_Trxdeaths;
    int dim_p_Trxdeaths_1;
    int dim_p_Trxdeaths_12;
    int dim_p_Trxdeaths_2;
    int dim_p_Trxdeaths_3;
    int dim_p_Uage;
    int dim_p_Uage_1;
    int dim_p_Uage_12;
    int dim_p_Uage_2;
    int dim_p_Uage_3;
    int dim_p_UHIV;
    int dim_p_UHIV_1;
    int dim_p_UHIV_12;
    int dim_p_UHIV_2;
    int dim_p_UHIV_3;
    int dim_p_Uinf;
    int dim_p_Uinf_1;
    int dim_p_Uinf_12;
    int dim_p_Uinf_2;
    int dim_p_Uinf_3;
    int dim_pD_inmigr;
    int dim_pD_inmigr_1;
    int dim_pD_inmigr_12;
    int dim_pD_inmigr_2;
    int dim_pD_inmigr_3;
    int dim_Pellij;
    int dim_Pellij_1;
    int dim_Pellij_2;
    int dim_pLL_inmigr;
    int dim_pLL_inmigr_1;
    int dim_pLL_inmigr_12;
    int dim_pLL_inmigr_2;
    int dim_pLL_inmigr_3;
    int dim_pLR_inmigr;
    int dim_pLR_inmigr_1;
    int dim_pLR_inmigr_12;
    int dim_pLR_inmigr_2;
    int dim_pLR_inmigr_3;
    int dim_popinit;
    int dim_popinit_byage;
    int dim_popinit_byage_1;
    int dim_popinit_byage_2;
    int dim_pR_inmigr;
    int dim_pR_inmigr_1;
    int dim_pR_inmigr_12;
    int dim_pR_inmigr_2;
    int dim_pR_inmigr_3;
    int dim_progFast;
    int dim_progFast_1;
    int dim_progFast_12;
    int dim_progFast_2;
    int dim_progFast_3;
    int dim_progress;
    int dim_progress_1;
    int dim_progress_12;
    int dim_progress_2;
    int dim_progress_3;
    int dim_progSlow;
    int dim_progSlow_1;
    int dim_progSlow_12;
    int dim_progSlow_2;
    int dim_progSlow_3;
    int dim_pSC_inmigr;
    int dim_pSC_inmigr_1;
    int dim_pSC_inmigr_12;
    int dim_pSC_inmigr_2;
    int dim_pSC_inmigr_3;
    int dim_pTr_inmigr;
    int dim_pTr_inmigr_1;
    int dim_pTr_inmigr_12;
    int dim_pTr_inmigr_2;
    int dim_pTr_inmigr_3;
    int dim_pU_inmigr;
    int dim_pU_inmigr_1;
    int dim_pU_inmigr_12;
    int dim_pU_inmigr_2;
    int dim_pU_inmigr_3;
    int dim_R;
    int dim_R_1;
    int dim_R_12;
    int dim_R_2;
    int dim_R_3;
    int dim_R_inmigr;
    int dim_R_inmigr_1;
    int dim_R_inmigr_12;
    int dim_R_inmigr_2;
    int dim_R_inmigr_3;
    int dim_rate_D;
    int dim_rate_D_1;
    int dim_rate_D_12;
    int dim_rate_D_2;
    int dim_rate_D_3;
    int dim_rate_LL;
    int dim_rate_LL_1;
    int dim_rate_LL_12;
    int dim_rate_LL_2;
    int dim_rate_LL_3;
    int dim_rate_LR;
    int dim_rate_LR_1;
    int dim_rate_LR_12;
    int dim_rate_LR_2;
    int dim_rate_LR_3;
    int dim_rate_R;
    int dim_rate_R_1;
    int dim_rate_R_12;
    int dim_rate_R_2;
    int dim_rate_R_3;
    int dim_rate_SC;
    int dim_rate_SC_1;
    int dim_rate_SC_12;
    int dim_rate_SC_2;
    int dim_rate_SC_3;
    int dim_rate_Tr;
    int dim_rate_Tr_1;
    int dim_rate_Tr_12;
    int dim_rate_Tr_2;
    int dim_rate_Tr_3;
    int dim_rate_U;
    int dim_rate_U_1;
    int dim_rate_U_12;
    int dim_rate_U_2;
    int dim_rate_U_3;
    int dim_Rdeaths;
    int dim_Rdeaths_1;
    int dim_Rdeaths_12;
    int dim_Rdeaths_2;
    int dim_Rdeaths_3;
    int dim_regress;
    int dim_regress_1;
    int dim_regress_12;
    int dim_regress_2;
    int dim_regress_3;
    int dim_relapse;
    int dim_relapse_1;
    int dim_relapse_12;
    int dim_relapse_2;
    int dim_relapse_3;
    int dim_Rinfs;
    int dim_Rinfs_1;
    int dim_Rinfs_12;
    int dim_Rinfs_2;
    int dim_Rinfs_3;
    int dim_SC;
    int dim_SC_1;
    int dim_SC_12;
    int dim_SC_2;
    int dim_SC_3;
    int dim_SC_inmigr;
    int dim_SC_inmigr_1;
    int dim_SC_inmigr_12;
    int dim_SC_inmigr_2;
    int dim_SC_inmigr_3;
    int dim_SCdeaths;
    int dim_SCdeaths_1;
    int dim_SCdeaths_12;
    int dim_SCdeaths_2;
    int dim_SCdeaths_3;
    int dim_selfcure;
    int dim_selfcure_1;
    int dim_selfcure_12;
    int dim_selfcure_2;
    int dim_selfcure_3;
    int dim_selfcure_SC;
    int dim_selfcure_SC_1;
    int dim_selfcure_SC_12;
    int dim_selfcure_SC_2;
    int dim_selfcure_SC_3;
    int dim_Sij;
    int dim_Sij_1;
    int dim_Sij_2;
    int dim_stabilisations;
    int dim_stabilisations_1;
    int dim_stabilisations_12;
    int dim_stabilisations_2;
    int dim_stabilisations_3;
    int dim_TB_deaths;
    int dim_TB_deaths_1;
    int dim_TB_deaths_12;
    int dim_TB_deaths_2;
    int dim_TB_deaths_3;
    int dim_TB_HIV_mod;
    int dim_TBdeaths;
    int dim_TBdeaths_1;
    int dim_TBdeaths_12;
    int dim_TBdeaths_2;
    int dim_TBdeaths_3;
    int dim_TBdeaths_SC;
    int dim_TBdeaths_SC_1;
    int dim_TBdeaths_SC_12;
    int dim_TBdeaths_SC_2;
    int dim_TBdeaths_SC_3;
    int dim_tbi_D;
    int dim_tbi_D_1;
    int dim_tbi_D_2;
    int dim_tbi_LL;
    int dim_tbi_LL_1;
    int dim_tbi_LL_2;
    int dim_tbi_LR;
    int dim_tbi_LR_1;
    int dim_tbi_LR_2;
    int dim_tbi_R;
    int dim_tbi_R_1;
    int dim_tbi_R_2;
    int dim_tbi_SC;
    int dim_tbi_SC_1;
    int dim_tbi_SC_2;
    int dim_tbi_Tr;
    int dim_tbi_Tr_1;
    int dim_tbi_Tr_2;
    int dim_tbi_U;
    int dim_tbi_U_1;
    int dim_tbi_U_2;
    int dim_Tijk;
    int dim_Tijk_1;
    int dim_Tijk_12;
    int dim_Tijk_2;
    int dim_Tijk_3;
    int dim_Tr;
    int dim_Tr_1;
    int dim_Tr_12;
    int dim_Tr_2;
    int dim_Tr_3;
    int dim_Tr_inmigr;
    int dim_Tr_inmigr_1;
    int dim_Tr_inmigr_12;
    int dim_Tr_inmigr_2;
    int dim_Tr_inmigr_3;
    int dim_Trdeaths;
    int dim_Trdeaths_1;
    int dim_Trdeaths_12;
    int dim_Trdeaths_2;
    int dim_Trdeaths_3;
    int dim_Trsuccess;
    int dim_Trsuccess_1;
    int dim_Trsuccess_12;
    int dim_Trsuccess_2;
    int dim_Trsuccess_3;
    int dim_Trxdeaths;
    int dim_Trxdeaths_1;
    int dim_Trxdeaths_12;
    int dim_Trxdeaths_2;
    int dim_Trxdeaths_3;
    int dim_tt;
    int dim_U;
    int dim_U_1;
    int dim_U_12;
    int dim_U_2;
    int dim_U_3;
    int dim_U_inmigr;
    int dim_U_inmigr_1;
    int dim_U_inmigr_12;
    int dim_U_inmigr_2;
    int dim_U_inmigr_3;
    int dim_Udeaths;
    int dim_Udeaths_1;
    int dim_Udeaths_12;
    int dim_Udeaths_2;
    int dim_Udeaths_3;
    int dim_Uinfs;
    int dim_Uinfs_1;
    int dim_Uinfs_12;
    int dim_Uinfs_2;
    int dim_Uinfs_3;
    int dim_zk;
    real_type dt;
    real_type dtct_rate;
    real_type dtct_rate_SC;
    real_type dur;
    real_type epsi;
    std::vector<real_type> Hirr;
    int HIV_dims;
    std::vector<real_type> HIV_int;
    std::vector<real_type> initD;
    std::vector<real_type> initDenom;
    std::vector<real_type> initF;
    real_type initial_beta_test;
    std::vector<real_type> initial_bg_deaths;
    std::vector<real_type> initial_cum_inf_flux;
    std::vector<real_type> initial_cum_note_flux;
    std::vector<real_type> initial_incidence;
    std::vector<real_type> initial_notes;
    std::vector<real_type> initial_notifrate;
    std::vector<real_type> initial_Sij;
    std::vector<real_type> initial_TB_deaths;
    std::vector<real_type> initial_Tijk;
    real_type initial_tot_incidence;
    std::vector<real_type> initLL;
    std::vector<real_type> initPrev;
    std::vector<real_type> IRR;
    std::vector<real_type> m_in_int;
    std::vector<real_type> MM;
    std::vector<real_type> mu_ART_int;
    std::vector<real_type> mu_HIV_int;
    std::vector<real_type> mu_noHIV_int;
    int offset_variable_bg_deaths;
    int offset_variable_cum_note_flux;
    int offset_variable_D;
    int offset_variable_incidence;
    int offset_variable_LL;
    int offset_variable_LR;
    int offset_variable_N;
    int offset_variable_notes;
    int offset_variable_notifrate;
    int offset_variable_R;
    int offset_variable_SC;
    int offset_variable_Sij;
    int offset_variable_TB_deaths;
    int offset_variable_Tijk;
    int offset_variable_Tr;
    int offset_variable_U;
    real_type Palpha;
    int patch_dims;
    real_type Pdelta;
    real_type pDf;
    real_type pDr;
    real_type pDs;
    real_type Pepsilon;
    real_type Pgamma;
    real_type Pi;
    real_type pLL;
    real_type Pmu;
    real_type Pomega;
    std::vector<real_type> popinit;
    real_type ppB;
    real_type ppC;
    real_type ppF;
    real_type ppG;
    real_type ppH;
    real_type ppJ;
    real_type ppK;
    real_type Prho;
    real_type progress_rate;
    real_type Psigma;
    real_type Ptau;
    real_type regress_rate;
    real_type relinf;
    int sim_length;
    real_type slfcr_rate;
    real_type t_dur;
    std::vector<real_type> TB_HIV_mod;
    real_type TBd_rate;
    std::vector<real_type> tbi_D;
    std::vector<real_type> tbi_LL;
    std::vector<real_type> tbi_LR;
    std::vector<real_type> tbi_R;
    std::vector<real_type> tbi_SC;
    std::vector<real_type> tbi_Tr;
    std::vector<real_type> tbi_U;
    real_type tfr;
    real_type tol;
    real_type Trsucc_rate;
    real_type Trxd_rate;
    std::vector<real_type> tt;
    real_type v;
    std::vector<real_type> zk;
  };
  struct internal_type {
    std::vector<real_type> age_in_D;
    std::vector<real_type> age_in_LL;
    std::vector<real_type> age_in_LR;
    std::vector<real_type> age_in_R;
    std::vector<real_type> age_in_SC;
    std::vector<real_type> age_in_Tr;
    std::vector<real_type> age_in_U;
    std::vector<real_type> age_out_D;
    std::vector<real_type> age_out_LL;
    std::vector<real_type> age_out_LR;
    std::vector<real_type> age_out_R;
    std::vector<real_type> age_out_SC;
    std::vector<real_type> age_out_Tr;
    std::vector<real_type> age_out_U;
    std::vector<real_type> ART_rate_yr;
    std::vector<real_type> births;
    std::vector<real_type> D_inmigr;
    std::vector<real_type> Ddeaths;
    std::vector<real_type> detection;
    std::vector<real_type> detection_SC;
    std::vector<real_type> elli;
    std::vector<real_type> ellij;
    std::vector<real_type> foi;
    std::vector<real_type> foitemp;
    std::vector<real_type> HIV_in_D;
    std::vector<real_type> HIV_in_LL;
    std::vector<real_type> HIV_in_LR;
    std::vector<real_type> HIV_in_R;
    std::vector<real_type> HIV_in_SC;
    std::vector<real_type> HIV_in_Tr;
    std::vector<real_type> HIV_in_U;
    std::vector<real_type> HIV_out_D;
    std::vector<real_type> HIV_out_LL;
    std::vector<real_type> HIV_out_LR;
    std::vector<real_type> HIV_out_R;
    std::vector<real_type> HIV_out_SC;
    std::vector<real_type> HIV_out_Tr;
    std::vector<real_type> HIV_out_U;
    std::vector<real_type> HIV_rate_yr;
    std::vector<real_type> InfsByPatch;
    std::vector<real_type> InfsByPatchPatch;
    std::vector<real_type> init_D;
    std::vector<real_type> init_LL;
    std::vector<real_type> init_LR;
    std::vector<real_type> init_R;
    std::vector<real_type> init_SC;
    std::vector<real_type> init_Tr;
    std::vector<real_type> init_U;
    std::vector<real_type> initial_D;
    std::vector<real_type> initial_LL;
    std::vector<real_type> initial_LR;
    std::vector<real_type> initial_N;
    std::vector<real_type> initial_R;
    std::vector<real_type> initial_SC;
    std::vector<real_type> initial_Tr;
    std::vector<real_type> initial_U;
    std::vector<real_type> LL_inmigr;
    std::vector<real_type> LLdeaths;
    std::vector<real_type> LLinfs;
    std::vector<real_type> LR_inmigr;
    std::vector<real_type> LRdeaths;
    std::vector<real_type> m_in_t;
    std::vector<real_type> mu_ART_t;
    std::vector<real_type> mu_HIV_t;
    std::vector<real_type> mu_noHIV_t;
    std::vector<real_type> Nevents_D;
    std::vector<real_type> Nevents_LL;
    std::vector<real_type> Nevents_LR;
    std::vector<real_type> Nevents_R;
    std::vector<real_type> Nevents_SC;
    std::vector<real_type> Nevents_Tr;
    std::vector<real_type> Nevents_U;
    std::vector<real_type> NotesByPatch;
    std::vector<real_type> NotesByPatchPatch;
    std::vector<real_type> p_Dage;
    std::vector<real_type> p_detect;
    std::vector<real_type> p_detect_SC;
    std::vector<real_type> p_DHIV;
    std::vector<real_type> p_LLage;
    std::vector<real_type> p_LLHIV;
    std::vector<real_type> p_LLinfs;
    std::vector<real_type> p_LRage;
    std::vector<real_type> p_LRHIV;
    std::vector<real_type> p_progFast;
    std::vector<real_type> p_progress;
    std::vector<real_type> p_progSlow;
    std::vector<real_type> p_Rage;
    std::vector<real_type> p_regress;
    std::vector<real_type> p_relapse;
    std::vector<real_type> p_RHIV;
    std::vector<real_type> p_Rinfs;
    std::vector<real_type> p_SCage;
    std::vector<real_type> p_SCHIV;
    std::vector<real_type> p_selfcr;
    std::vector<real_type> p_selfcr_SC;
    std::vector<real_type> p_stabilise;
    std::vector<real_type> p_TBdeaths;
    std::vector<real_type> p_TBdeaths_SC;
    std::vector<real_type> p_Trage;
    std::vector<real_type> p_TrHIV;
    std::vector<real_type> p_Trsuccess;
    std::vector<real_type> p_Trxdeaths;
    std::vector<real_type> p_Uage;
    std::vector<real_type> p_UHIV;
    std::vector<real_type> p_Uinf;
    std::vector<real_type> pD_inmigr;
    std::vector<real_type> Pellij;
    std::vector<real_type> pLL_inmigr;
    std::vector<real_type> pLR_inmigr;
    std::vector<real_type> popinit_byage;
    std::vector<real_type> pR_inmigr;
    std::vector<real_type> progFast;
    std::vector<real_type> progress;
    std::vector<real_type> progSlow;
    std::vector<real_type> pSC_inmigr;
    std::vector<real_type> pTr_inmigr;
    std::vector<real_type> pU_inmigr;
    std::vector<real_type> R_inmigr;
    std::vector<real_type> rate_D;
    std::vector<real_type> rate_LL;
    std::vector<real_type> rate_LR;
    std::vector<real_type> rate_R;
    std::vector<real_type> rate_SC;
    std::vector<real_type> rate_Tr;
    std::vector<real_type> rate_U;
    std::vector<real_type> Rdeaths;
    std::vector<real_type> regress;
    std::vector<real_type> relapse;
    std::vector<real_type> Rinfs;
    std::vector<real_type> SC_inmigr;
    std::vector<real_type> SCdeaths;
    std::vector<real_type> selfcure;
    std::vector<real_type> selfcure_SC;
    std::vector<real_type> stabilisations;
    std::vector<real_type> TBdeaths;
    std::vector<real_type> TBdeaths_SC;
    std::vector<real_type> Tr_inmigr;
    std::vector<real_type> Trdeaths;
    std::vector<real_type> Trsuccess;
    std::vector<real_type> Trxdeaths;
    std::vector<real_type> U_inmigr;
    std::vector<real_type> Udeaths;
    std::vector<real_type> Uinfs;
  };
  stocm(const dust::pars_type<stocm>& pars) :
    shared(pars.shared), internal(pars.internal) {
  }
  size_t size() const {
    return shared->dim_bg_deaths + shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_incidence + shared->dim_LL + shared->dim_LR + shared->dim_N + shared->dim_notes + shared->dim_notifrate + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_TB_deaths + shared->dim_Tijk + shared->dim_Tr + shared->dim_U + 2;
  }
  std::vector<real_type> initial(size_t step, rng_state_type& rng_state) {
    std::vector<real_type> state(shared->dim_bg_deaths + shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_incidence + shared->dim_LL + shared->dim_LR + shared->dim_N + shared->dim_notes + shared->dim_notifrate + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_TB_deaths + shared->dim_Tijk + shared->dim_Tr + shared->dim_U + 2);
    for (int i = 1; i <= shared->dim_popinit_byage_1; ++i) {
      for (int j = 1; j <= shared->dim_popinit_byage_2; ++j) {
        internal.popinit_byage[i - 1 + shared->dim_popinit_byage_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, dust::math::floor(shared->popinit[i - 1]), shared->agefracs[j - 1] / (real_type) (odin_sum1<real_type>(shared->agefracs.data(), 0, shared->dim_agefracs) + static_cast<real_type>(1e-10)));
      }
    }
    for (int i = 1; i <= shared->dim_init_D_1; ++i) {
      for (int j = 1; j <= shared->dim_init_D_2; ++j) {
        internal.init_D[i - 1 + shared->dim_init_D_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.popinit_byage[shared->dim_popinit_byage_1 * (j - 1) + i - 1], shared->tbi_D[shared->dim_tbi_D_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_init_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_init_LL_2; ++j) {
        internal.init_LL[i - 1 + shared->dim_init_LL_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.popinit_byage[shared->dim_popinit_byage_1 * (j - 1) + i - 1], shared->tbi_LL[shared->dim_tbi_LL_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_init_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_init_LR_2; ++j) {
        internal.init_LR[i - 1 + shared->dim_init_LR_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.popinit_byage[shared->dim_popinit_byage_1 * (j - 1) + i - 1], shared->tbi_LR[shared->dim_tbi_LR_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_init_R_1; ++i) {
      for (int j = 1; j <= shared->dim_init_R_2; ++j) {
        internal.init_R[i - 1 + shared->dim_init_R_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.popinit_byage[shared->dim_popinit_byage_1 * (j - 1) + i - 1], shared->tbi_R[shared->dim_tbi_R_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_init_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_init_SC_2; ++j) {
        internal.init_SC[i - 1 + shared->dim_init_SC_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.popinit_byage[shared->dim_popinit_byage_1 * (j - 1) + i - 1], shared->tbi_SC[shared->dim_tbi_SC_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_init_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_init_Tr_2; ++j) {
        internal.init_Tr[i - 1 + shared->dim_init_Tr_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.popinit_byage[shared->dim_popinit_byage_1 * (j - 1) + i - 1], shared->tbi_Tr[shared->dim_tbi_Tr_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_init_U_1; ++i) {
      for (int j = 1; j <= shared->dim_init_U_2; ++j) {
        internal.init_U[i - 1 + shared->dim_init_U_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.popinit_byage[shared->dim_popinit_byage_1 * (j - 1) + i - 1], shared->tbi_U[shared->dim_tbi_U_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_D_1; ++i) {
      for (int j = 1; j <= shared->dim_D_2; ++j) {
        int k = 1;
        internal.initial_D[i - 1 + shared->dim_D_1 * (j - 1) + shared->dim_D_12 * (k - 1)] = internal.init_D[shared->dim_init_D_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_D_1; ++i) {
      for (int j = 1; j <= shared->dim_D_2; ++j) {
        for (int k = 2; k <= 3; ++k) {
          internal.initial_D[i - 1 + shared->dim_D_1 * (j - 1) + shared->dim_D_12 * (k - 1)] = 0;
        }
      }
    }
    for (int i = 1; i <= shared->dim_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_LL_2; ++j) {
        int k = 1;
        internal.initial_LL[i - 1 + shared->dim_LL_1 * (j - 1) + shared->dim_LL_12 * (k - 1)] = internal.init_LL[shared->dim_init_LL_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_LL_2; ++j) {
        for (int k = 2; k <= 3; ++k) {
          internal.initial_LL[i - 1 + shared->dim_LL_1 * (j - 1) + shared->dim_LL_12 * (k - 1)] = 0;
        }
      }
    }
    for (int i = 1; i <= shared->dim_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_LR_2; ++j) {
        int k = 1;
        internal.initial_LR[i - 1 + shared->dim_LR_1 * (j - 1) + shared->dim_LR_12 * (k - 1)] = internal.init_LR[shared->dim_init_LR_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_LR_2; ++j) {
        for (int k = 2; k <= 3; ++k) {
          internal.initial_LR[i - 1 + shared->dim_LR_1 * (j - 1) + shared->dim_LR_12 * (k - 1)] = 0;
        }
      }
    }
    for (int i = 1; i <= shared->dim_N_1; ++i) {
      for (int j = 1; j <= shared->dim_N_2; ++j) {
        int k = 1;
        internal.initial_N[i - 1 + shared->dim_N_1 * (j - 1) + shared->dim_N_12 * (k - 1)] = internal.init_U[shared->dim_init_U_1 * (j - 1) + i - 1] + internal.init_LR[shared->dim_init_LR_1 * (j - 1) + i - 1] + internal.init_LL[shared->dim_init_LL_1 * (j - 1) + i - 1] + internal.init_D[shared->dim_init_D_1 * (j - 1) + i - 1] + internal.init_SC[shared->dim_init_SC_1 * (j - 1) + i - 1] + internal.init_Tr[shared->dim_init_Tr_1 * (j - 1) + i - 1] + internal.init_R[shared->dim_init_R_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_N_1; ++i) {
      for (int j = 1; j <= shared->dim_N_2; ++j) {
        for (int k = 2; k <= 3; ++k) {
          internal.initial_N[i - 1 + shared->dim_N_1 * (j - 1) + shared->dim_N_12 * (k - 1)] = 0;
        }
      }
    }
    for (int i = 1; i <= shared->dim_R_1; ++i) {
      for (int j = 1; j <= shared->dim_R_2; ++j) {
        int k = 1;
        internal.initial_R[i - 1 + shared->dim_R_1 * (j - 1) + shared->dim_R_12 * (k - 1)] = internal.init_R[shared->dim_init_R_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_R_1; ++i) {
      for (int j = 1; j <= shared->dim_R_2; ++j) {
        for (int k = 2; k <= 3; ++k) {
          internal.initial_R[i - 1 + shared->dim_R_1 * (j - 1) + shared->dim_R_12 * (k - 1)] = 0;
        }
      }
    }
    for (int i = 1; i <= shared->dim_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_SC_2; ++j) {
        int k = 1;
        internal.initial_SC[i - 1 + shared->dim_SC_1 * (j - 1) + shared->dim_SC_12 * (k - 1)] = internal.init_SC[shared->dim_init_SC_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_SC_2; ++j) {
        for (int k = 2; k <= 3; ++k) {
          internal.initial_SC[i - 1 + shared->dim_SC_1 * (j - 1) + shared->dim_SC_12 * (k - 1)] = 0;
        }
      }
    }
    for (int i = 1; i <= shared->dim_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_Tr_2; ++j) {
        int k = 1;
        internal.initial_Tr[i - 1 + shared->dim_Tr_1 * (j - 1) + shared->dim_Tr_12 * (k - 1)] = internal.init_Tr[shared->dim_init_Tr_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_Tr_2; ++j) {
        for (int k = 2; k <= 3; ++k) {
          internal.initial_Tr[i - 1 + shared->dim_Tr_1 * (j - 1) + shared->dim_Tr_12 * (k - 1)] = 0;
        }
      }
    }
    for (int i = 1; i <= shared->dim_U_1; ++i) {
      for (int j = 1; j <= shared->dim_U_2; ++j) {
        int k = 1;
        internal.initial_U[i - 1 + shared->dim_U_1 * (j - 1) + shared->dim_U_12 * (k - 1)] = internal.init_U[shared->dim_init_U_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_U_1; ++i) {
      for (int j = 1; j <= shared->dim_U_2; ++j) {
        for (int k = 2; k <= 3; ++k) {
          internal.initial_U[i - 1 + shared->dim_U_1 * (j - 1) + shared->dim_U_12 * (k - 1)] = 0;
        }
      }
    }
    state[0] = shared->initial_tot_incidence;
    state[1] = shared->initial_beta_test;
    std::copy(shared->initial_cum_inf_flux.begin(), shared->initial_cum_inf_flux.end(), state.begin() + 2);
    std::copy(shared->initial_cum_note_flux.begin(), shared->initial_cum_note_flux.end(), state.begin() + shared->offset_variable_cum_note_flux);
    std::copy(shared->initial_Sij.begin(), shared->initial_Sij.end(), state.begin() + shared->offset_variable_Sij);
    std::copy(internal.initial_U.begin(), internal.initial_U.end(), state.begin() + shared->offset_variable_U);
    std::copy(internal.initial_LR.begin(), internal.initial_LR.end(), state.begin() + shared->offset_variable_LR);
    std::copy(internal.initial_LL.begin(), internal.initial_LL.end(), state.begin() + shared->offset_variable_LL);
    std::copy(internal.initial_D.begin(), internal.initial_D.end(), state.begin() + shared->offset_variable_D);
    std::copy(internal.initial_SC.begin(), internal.initial_SC.end(), state.begin() + shared->offset_variable_SC);
    std::copy(internal.initial_Tr.begin(), internal.initial_Tr.end(), state.begin() + shared->offset_variable_Tr);
    std::copy(internal.initial_R.begin(), internal.initial_R.end(), state.begin() + shared->offset_variable_R);
    std::copy(internal.initial_N.begin(), internal.initial_N.end(), state.begin() + shared->offset_variable_N);
    std::copy(shared->initial_TB_deaths.begin(), shared->initial_TB_deaths.end(), state.begin() + shared->offset_variable_TB_deaths);
    std::copy(shared->initial_notifrate.begin(), shared->initial_notifrate.end(), state.begin() + shared->offset_variable_notifrate);
    std::copy(shared->initial_notes.begin(), shared->initial_notes.end(), state.begin() + shared->offset_variable_notes);
    std::copy(shared->initial_bg_deaths.begin(), shared->initial_bg_deaths.end(), state.begin() + shared->offset_variable_bg_deaths);
    std::copy(shared->initial_incidence.begin(), shared->initial_incidence.end(), state.begin() + shared->offset_variable_incidence);
    std::copy(shared->initial_Tijk.begin(), shared->initial_Tijk.end(), state.begin() + shared->offset_variable_Tijk);
    return state;
  }
  void update(size_t step, const real_type * state, rng_state_type& rng_state, real_type * state_next) {
    const real_type * U = state + shared->offset_variable_U;
    const real_type * cum_inf_flux = state + 2;
    const real_type * cum_note_flux = state + shared->offset_variable_cum_note_flux;
    const real_type * LR = state + shared->offset_variable_LR;
    const real_type * LL = state + shared->offset_variable_LL;
    const real_type * SC = state + shared->offset_variable_SC;
    const real_type * D = state + shared->offset_variable_D;
    const real_type * Tr = state + shared->offset_variable_Tr;
    const real_type * R = state + shared->offset_variable_R;
    const real_type * notes = state + shared->offset_variable_notes;
    const real_type * N = state + shared->offset_variable_N;
    const real_type beta_test = state[1];
    const real_type * Tijk = state + shared->offset_variable_Tijk;
    const real_type * Sij = state + shared->offset_variable_Sij;
    real_type ART_t = (static_cast<int>(step) < shared->sim_length ? shared->ART_int[step + 1 - 1] : shared->ART_int[shared->sim_length - 1]);
    real_type HIV_t = (static_cast<int>(step) < shared->sim_length ? shared->HIV_int[step + 1 - 1] : shared->HIV_int[shared->sim_length - 1]);
    state_next[1] = beta_test;
    real_type births_t = (static_cast<int>(step) < shared->dim_births_int ? shared->births_int[step + 1 - 1] : shared->births_int[shared->dim_births_int - 1]);
    {
       int i = 1;
       internal.ART_rate_yr[i - 1] = 0;
    }
    for (int i = 2; i <= 3; ++i) {
      internal.ART_rate_yr[i - 1] = ART_t;
    }
    real_type beta_seas = shared->beta * (1 + shared->epsi * (dust::math::sin(2 * shared->Pi * shared->tt[step - 1] / (real_type) 12)));
    real_type birth_rate_yr = births_t / (real_type) 1000;
    {
       int i = 1;
       internal.HIV_rate_yr[i - 1] = 0;
    }
    {
       int i = 2;
       internal.HIV_rate_yr[i - 1] = HIV_t / (real_type) 1000;
    }
    {
       int i = 3;
       internal.HIV_rate_yr[i - 1] = 0;
    }
    for (int i = 1; i <= shared->dim_m_in_t; ++i) {
      internal.m_in_t[i - 1] = (static_cast<int>(step) < shared->sim_length ? shared->m_in_int[shared->dim_m_in_int_1 * (step + 1 - 1) + i - 1] : shared->m_in_int[shared->dim_m_in_int_1 * (shared->sim_length - 1) + i - 1]);
    }
    for (int i = 1; i <= shared->dim_mu_ART_t; ++i) {
      internal.mu_ART_t[i - 1] = (static_cast<int>(step) < shared->sim_length ? shared->mu_ART_int[shared->dim_mu_ART_int_1 * (step + 1 - 1) + i - 1] : shared->mu_ART_int[shared->dim_mu_ART_int_1 * (shared->sim_length - 1) + i - 1]);
    }
    for (int i = 1; i <= shared->dim_mu_HIV_t; ++i) {
      internal.mu_HIV_t[i - 1] = (static_cast<int>(step) < shared->sim_length ? shared->mu_HIV_int[shared->dim_mu_HIV_int_1 * (step + 1 - 1) + i - 1] : shared->mu_HIV_int[shared->dim_mu_HIV_int_1 * (shared->sim_length - 1) + i - 1]);
    }
    for (int i = 1; i <= shared->dim_mu_noHIV_t; ++i) {
      internal.mu_noHIV_t[i - 1] = (static_cast<int>(step) < shared->sim_length ? shared->mu_noHIV_int[shared->dim_mu_noHIV_int_1 * (step + 1 - 1) + i - 1] : shared->mu_noHIV_int[shared->dim_mu_noHIV_int_1 * (shared->sim_length - 1) + i - 1]);
    }
    for (int i = 1; i <= shared->dim_NotesByPatch; ++i) {
      internal.NotesByPatch[i - 1] = odin_sum3<real_type>(notes, i - 1, i, 0, shared->dim_notes_2, 0, shared->dim_notes_3, shared->dim_notes_1, shared->dim_notes_12);
    }
    for (int i = 1; i <= shared->dim_N_1; ++i) {
      for (int j = 1; j <= shared->dim_N_2; ++j) {
        for (int k = 1; k <= shared->dim_N_3; ++k) {
          state_next[shared->offset_variable_N + i - 1 + shared->dim_N_1 * (j - 1) + shared->dim_N_12 * (k - 1)] = U[shared->dim_U_12 * (k - 1) + shared->dim_U_1 * (j - 1) + i - 1] + LR[shared->dim_LR_12 * (k - 1) + shared->dim_LR_1 * (j - 1) + i - 1] + LL[shared->dim_LL_12 * (k - 1) + shared->dim_LL_1 * (j - 1) + i - 1] + D[shared->dim_D_12 * (k - 1) + shared->dim_D_1 * (j - 1) + i - 1] + SC[shared->dim_SC_12 * (k - 1) + shared->dim_SC_1 * (j - 1) + i - 1] + Tr[shared->dim_Tr_12 * (k - 1) + shared->dim_Tr_1 * (j - 1) + i - 1] + R[shared->dim_R_12 * (k - 1) + shared->dim_R_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->patch_dims; ++i) {
      int j = 1;
      int k = 1;
      internal.births[i - 1 + shared->dim_births_1 * (j - 1) + shared->dim_births_12 * (k - 1)] = dust::random::poisson<real_type>(rng_state, birth_rate_yr * odin_sum3<real_type>(N, i - 1, i, 0, shared->dim_N_2, 0, shared->dim_N_3, shared->dim_N_1, shared->dim_N_12) * shared->dt);
    }
    for (int i = 1; i <= shared->patch_dims; ++i) {
      for (int j = 2; j <= shared->age_dims; ++j) {
        for (int k = 2; k <= shared->HIV_dims; ++k) {
          internal.births[i - 1 + shared->dim_births_1 * (j - 1) + shared->dim_births_12 * (k - 1)] = 0;
        }
      }
    }
    for (int i = 1; i <= shared->dim_foitemp_1; ++i) {
      for (int j = 1; j <= shared->dim_foitemp_2; ++j) {
        internal.foitemp[i - 1 + shared->dim_foitemp_1 * (j - 1)] = beta_seas * shared->MM[shared->dim_MM_1 * (j - 1) + i - 1] * (odin_sum3<real_type>(D, j - 1, j, 0, shared->dim_D_2, 0, shared->dim_D_3, shared->dim_D_1, shared->dim_D_12) + shared->relinf * odin_sum3<real_type>(SC, j - 1, j, 0, shared->dim_SC_2, 0, shared->dim_SC_3, shared->dim_SC_1, shared->dim_SC_12)) / (real_type) (odin_sum3<real_type>(N, j - 1, j, 0, shared->dim_N_2, 0, shared->dim_N_3, shared->dim_N_1, shared->dim_N_12) + static_cast<real_type>(1.0000000000000001e-15));
      }
    }
    for (int i = 1; i <= shared->dim_p_detect_1; ++i) {
      for (int j = 1; j <= shared->dim_p_detect_2; ++j) {
        int k = 1;
        internal.p_detect[i - 1 + shared->dim_p_detect_1 * (j - 1) + shared->dim_p_detect_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate > shared->tol ? shared->dtct_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_detect_1; ++i) {
      for (int j = 1; j <= shared->dim_p_detect_2; ++j) {
        int k = 2;
        internal.p_detect[i - 1 + shared->dim_p_detect_1 * (j - 1) + shared->dim_p_detect_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate > shared->tol ? shared->dtct_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_detect_1; ++i) {
      for (int j = 1; j <= shared->dim_p_detect_2; ++j) {
        int k = 3;
        internal.p_detect[i - 1 + shared->dim_p_detect_1 * (j - 1) + shared->dim_p_detect_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate > shared->tol ? shared->dtct_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_detect_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_detect_SC_2; ++j) {
        int k = 1;
        internal.p_detect_SC[i - 1 + shared->dim_p_detect_SC_1 * (j - 1) + shared->dim_p_detect_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate > shared->tol ? shared->dtct_rate_SC / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_detect_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_detect_SC_2; ++j) {
        int k = 2;
        internal.p_detect_SC[i - 1 + shared->dim_p_detect_SC_1 * (j - 1) + shared->dim_p_detect_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate > shared->tol ? shared->dtct_rate_SC / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_detect_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_detect_SC_2; ++j) {
        int k = 3;
        internal.p_detect_SC[i - 1 + shared->dim_p_detect_SC_1 * (j - 1) + shared->dim_p_detect_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate > shared->tol ? shared->dtct_rate_SC / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_DHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_DHIV_2; ++j) {
        int k = 1;
        internal.p_DHIV[i - 1 + shared->dim_p_DHIV_1 * (j - 1) + shared->dim_p_DHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate + internal.HIV_rate_yr[j - 1] > shared->tol ? internal.HIV_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate + internal.HIV_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_DHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_DHIV_2; ++j) {
        int k = 2;
        internal.p_DHIV[i - 1 + shared->dim_p_DHIV_1 * (j - 1) + shared->dim_p_DHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate + internal.ART_rate_yr[j - 1] > shared->tol ? internal.ART_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate + internal.ART_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_DHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_DHIV_2; ++j) {
        int k = 3;
        internal.p_DHIV[i - 1 + shared->dim_p_DHIV_1 * (j - 1) + shared->dim_p_DHIV_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_p_LRHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LRHIV_2; ++j) {
        int k = 1;
        internal.p_LRHIV[i - 1 + shared->dim_p_LRHIV_1 * (j - 1) + shared->dim_p_LRHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[0] + shared->pLL + internal.HIV_rate_yr[j - 1] > shared->tol ? internal.HIV_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[0] + shared->pLL + internal.HIV_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_LRHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LRHIV_2; ++j) {
        int k = 2;
        internal.p_LRHIV[i - 1 + shared->dim_p_LRHIV_1 * (j - 1) + shared->dim_p_LRHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[1] + shared->pLL + internal.ART_rate_yr[j - 1] > shared->tol ? internal.ART_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[1] + shared->pLL + internal.ART_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_LRHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LRHIV_2; ++j) {
        int k = 3;
        internal.p_LRHIV[i - 1 + shared->dim_p_LRHIV_1 * (j - 1) + shared->dim_p_LRHIV_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_p_progFast_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progFast_2; ++j) {
        int k = 1;
        internal.p_progFast[i - 1 + shared->dim_p_progFast_1 * (j - 1) + shared->dim_p_progFast_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[0] + shared->pLL > shared->tol ? shared->IRR[i - 1] * shared->pDf * shared->Hirr[0] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[0] + shared->pLL) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_progFast_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progFast_2; ++j) {
        int k = 2;
        internal.p_progFast[i - 1 + shared->dim_p_progFast_1 * (j - 1) + shared->dim_p_progFast_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[1] + shared->pLL > shared->tol ? shared->IRR[i - 1] * shared->pDf * shared->Hirr[1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[1] + shared->pLL) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_progFast_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progFast_2; ++j) {
        int k = 3;
        internal.p_progFast[i - 1 + shared->dim_p_progFast_1 * (j - 1) + shared->dim_p_progFast_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[2] + shared->pLL > shared->tol ? shared->IRR[i - 1] * shared->pDf * shared->Hirr[2] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[2] + shared->pLL) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_progress_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progress_2; ++j) {
        int k = 1;
        internal.p_progress[i - 1 + shared->dim_p_progress_1 * (j - 1) + shared->dim_p_progress_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->progress_rate > shared->tol ? shared->progress_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_progress_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progress_2; ++j) {
        int k = 2;
        internal.p_progress[i - 1 + shared->dim_p_progress_1 * (j - 1) + shared->dim_p_progress_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->progress_rate > shared->tol ? shared->progress_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_progress_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progress_2; ++j) {
        int k = 3;
        internal.p_progress[i - 1 + shared->dim_p_progress_1 * (j - 1) + shared->dim_p_progress_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->progress_rate > shared->tol ? shared->progress_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_regress_1; ++i) {
      for (int j = 1; j <= shared->dim_p_regress_2; ++j) {
        int k = 1;
        internal.p_regress[i - 1 + shared->dim_p_regress_1 * (j - 1) + shared->dim_p_regress_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->regress_rate > shared->tol ? shared->regress_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_regress_1; ++i) {
      for (int j = 1; j <= shared->dim_p_regress_2; ++j) {
        int k = 2;
        internal.p_regress[i - 1 + shared->dim_p_regress_1 * (j - 1) + shared->dim_p_regress_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->regress_rate > shared->tol ? shared->regress_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_regress_1; ++i) {
      for (int j = 1; j <= shared->dim_p_regress_2; ++j) {
        int k = 3;
        internal.p_regress[i - 1 + shared->dim_p_regress_1 * (j - 1) + shared->dim_p_regress_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->regress_rate > shared->tol ? shared->regress_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_relapse_1; ++i) {
      for (int j = 1; j <= shared->dim_p_relapse_2; ++j) {
        int k = 1;
        internal.p_relapse[i - 1 + shared->dim_p_relapse_1 * (j - 1) + shared->dim_p_relapse_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[0] > shared->tol ? shared->IRR[i - 1] * shared->pDr * shared->Hirr[0] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[0]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_relapse_1; ++i) {
      for (int j = 1; j <= shared->dim_p_relapse_2; ++j) {
        int k = 2;
        internal.p_relapse[i - 1 + shared->dim_p_relapse_1 * (j - 1) + shared->dim_p_relapse_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[1] > shared->tol ? shared->IRR[i - 1] * shared->pDr * shared->Hirr[1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_relapse_1; ++i) {
      for (int j = 1; j <= shared->dim_p_relapse_2; ++j) {
        int k = 3;
        internal.p_relapse[i - 1 + shared->dim_p_relapse_1 * (j - 1) + shared->dim_p_relapse_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[2] > shared->tol ? shared->IRR[i - 1] * shared->pDr * shared->Hirr[2] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[2]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_SCHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_SCHIV_2; ++j) {
        int k = 1;
        internal.p_SCHIV[i - 1 + shared->dim_p_SCHIV_1 * (j - 1) + shared->dim_p_SCHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate + internal.HIV_rate_yr[j - 1] > shared->tol ? internal.HIV_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate + internal.HIV_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_SCHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_SCHIV_2; ++j) {
        int k = 2;
        internal.p_SCHIV[i - 1 + shared->dim_p_SCHIV_1 * (j - 1) + shared->dim_p_SCHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate + internal.ART_rate_yr[j - 1] > shared->tol ? internal.ART_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate + internal.ART_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_SCHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_SCHIV_2; ++j) {
        int k = 3;
        internal.p_SCHIV[i - 1 + shared->dim_p_SCHIV_1 * (j - 1) + shared->dim_p_SCHIV_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_p_selfcr_1; ++i) {
      for (int j = 1; j <= shared->dim_p_selfcr_2; ++j) {
        int k = 1;
        internal.p_selfcr[i - 1 + shared->dim_p_selfcr_1 * (j - 1) + shared->dim_p_selfcr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->regress_rate > shared->tol ? shared->slfcr_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_selfcr_1; ++i) {
      for (int j = 1; j <= shared->dim_p_selfcr_2; ++j) {
        int k = 2;
        internal.p_selfcr[i - 1 + shared->dim_p_selfcr_1 * (j - 1) + shared->dim_p_selfcr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->regress_rate > shared->tol ? shared->slfcr_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_selfcr_1; ++i) {
      for (int j = 1; j <= shared->dim_p_selfcr_2; ++j) {
        int k = 3;
        internal.p_selfcr[i - 1 + shared->dim_p_selfcr_1 * (j - 1) + shared->dim_p_selfcr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->regress_rate > shared->tol ? shared->slfcr_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->regress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_selfcr_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_selfcr_SC_2; ++j) {
        int k = 1;
        internal.p_selfcr_SC[i - 1 + shared->dim_p_selfcr_SC_1 * (j - 1) + shared->dim_p_selfcr_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->progress_rate > shared->tol ? shared->slfcr_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_selfcr_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_selfcr_SC_2; ++j) {
        int k = 2;
        internal.p_selfcr_SC[i - 1 + shared->dim_p_selfcr_SC_1 * (j - 1) + shared->dim_p_selfcr_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->progress_rate > shared->tol ? shared->slfcr_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_selfcr_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_selfcr_SC_2; ++j) {
        int k = 3;
        internal.p_selfcr_SC[i - 1 + shared->dim_p_selfcr_SC_1 * (j - 1) + shared->dim_p_selfcr_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->progress_rate > shared->tol ? shared->slfcr_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->slfcr_rate + shared->progress_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_stabilise_1; ++i) {
      for (int j = 1; j <= shared->dim_p_stabilise_2; ++j) {
        int k = 1;
        internal.p_stabilise[i - 1 + shared->dim_p_stabilise_1 * (j - 1) + shared->dim_p_stabilise_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pLL > shared->tol ? shared->pLL / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pLL) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_stabilise_1; ++i) {
      for (int j = 1; j <= shared->dim_p_stabilise_2; ++j) {
        int k = 2;
        internal.p_stabilise[i - 1 + shared->dim_p_stabilise_1 * (j - 1) + shared->dim_p_stabilise_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pLL > shared->tol ? shared->pLL / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pLL) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_stabilise_1; ++i) {
      for (int j = 1; j <= shared->dim_p_stabilise_2; ++j) {
        int k = 3;
        internal.p_stabilise[i - 1 + shared->dim_p_stabilise_1 * (j - 1) + shared->dim_p_stabilise_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->pLL > shared->tol ? shared->pLL / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->pLL) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TBdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TBdeaths_2; ++j) {
        int k = 1;
        internal.p_TBdeaths[i - 1 + shared->dim_p_TBdeaths_1 * (j - 1) + shared->dim_p_TBdeaths_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate > shared->tol ? shared->TBd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TBdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TBdeaths_2; ++j) {
        int k = 2;
        internal.p_TBdeaths[i - 1 + shared->dim_p_TBdeaths_1 * (j - 1) + shared->dim_p_TBdeaths_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate > shared->tol ? shared->TBd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TBdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TBdeaths_2; ++j) {
        int k = 3;
        internal.p_TBdeaths[i - 1 + shared->dim_p_TBdeaths_1 * (j - 1) + shared->dim_p_TBdeaths_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate > shared->tol ? shared->TBd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TBdeaths_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TBdeaths_SC_2; ++j) {
        int k = 1;
        internal.p_TBdeaths_SC[i - 1 + shared->dim_p_TBdeaths_SC_1 * (j - 1) + shared->dim_p_TBdeaths_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate > shared->tol ? shared->TBd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TBdeaths_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TBdeaths_SC_2; ++j) {
        int k = 2;
        internal.p_TBdeaths_SC[i - 1 + shared->dim_p_TBdeaths_SC_1 * (j - 1) + shared->dim_p_TBdeaths_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate > shared->tol ? shared->TBd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TBdeaths_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TBdeaths_SC_2; ++j) {
        int k = 3;
        internal.p_TBdeaths_SC[i - 1 + shared->dim_p_TBdeaths_SC_1 * (j - 1) + shared->dim_p_TBdeaths_SC_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate > shared->tol ? shared->TBd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TrHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TrHIV_2; ++j) {
        int k = 1;
        internal.p_TrHIV[i - 1 + shared->dim_p_TrHIV_1 * (j - 1) + shared->dim_p_TrHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate + internal.HIV_rate_yr[j - 1] > shared->tol ? internal.HIV_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate + internal.HIV_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TrHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TrHIV_2; ++j) {
        int k = 2;
        internal.p_TrHIV[i - 1 + shared->dim_p_TrHIV_1 * (j - 1) + shared->dim_p_TrHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate + internal.ART_rate_yr[j - 1] > shared->tol ? internal.ART_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate + internal.ART_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_TrHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_TrHIV_2; ++j) {
        int k = 3;
        internal.p_TrHIV[i - 1 + shared->dim_p_TrHIV_1 * (j - 1) + shared->dim_p_TrHIV_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_p_Trsuccess_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Trsuccess_2; ++j) {
        int k = 1;
        internal.p_Trsuccess[i - 1 + shared->dim_p_Trsuccess_1 * (j - 1) + shared->dim_p_Trsuccess_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate > shared->tol ? shared->Trsucc_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Trsuccess_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Trsuccess_2; ++j) {
        int k = 2;
        internal.p_Trsuccess[i - 1 + shared->dim_p_Trsuccess_1 * (j - 1) + shared->dim_p_Trsuccess_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate > shared->tol ? shared->Trsucc_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Trsuccess_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Trsuccess_2; ++j) {
        int k = 3;
        internal.p_Trsuccess[i - 1 + shared->dim_p_Trsuccess_1 * (j - 1) + shared->dim_p_Trsuccess_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate > shared->tol ? shared->Trsucc_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Trxdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Trxdeaths_2; ++j) {
        int k = 1;
        internal.p_Trxdeaths[i - 1 + shared->dim_p_Trxdeaths_1 * (j - 1) + shared->dim_p_Trxdeaths_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->Trxd_rate > shared->tol ? shared->Trxd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->Trxd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Trxdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Trxdeaths_2; ++j) {
        int k = 2;
        internal.p_Trxdeaths[i - 1 + shared->dim_p_Trxdeaths_1 * (j - 1) + shared->dim_p_Trxdeaths_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->Trxd_rate > shared->tol ? shared->Trxd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->Trxd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Trxdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Trxdeaths_2; ++j) {
        int k = 3;
        internal.p_Trxdeaths[i - 1 + shared->dim_p_Trxdeaths_1 * (j - 1) + shared->dim_p_Trxdeaths_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->Trxd_rate > shared->tol ? shared->Trxd_rate / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->Trxd_rate) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pD_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pD_inmigr_2; ++j) {
        int k = 1;
        internal.pD_inmigr[i - 1 + shared->dim_pD_inmigr_1 * (j - 1) + shared->dim_pD_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pD_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pD_inmigr_2; ++j) {
        int k = 2;
        internal.pD_inmigr[i - 1 + shared->dim_pD_inmigr_1 * (j - 1) + shared->dim_pD_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pD_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pD_inmigr_2; ++j) {
        int k = 3;
        internal.pD_inmigr[i - 1 + shared->dim_pD_inmigr_1 * (j - 1) + shared->dim_pD_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pLL_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pLL_inmigr_2; ++j) {
        int k = 1;
        internal.pLL_inmigr[i - 1 + shared->dim_pLL_inmigr_1 * (j - 1) + shared->dim_pLL_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pLL_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pLL_inmigr_2; ++j) {
        int k = 2;
        internal.pLL_inmigr[i - 1 + shared->dim_pLL_inmigr_1 * (j - 1) + shared->dim_pLL_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pLL_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pLL_inmigr_2; ++j) {
        int k = 3;
        internal.pLL_inmigr[i - 1 + shared->dim_pLL_inmigr_1 * (j - 1) + shared->dim_pLL_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pLR_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pLR_inmigr_2; ++j) {
        int k = 1;
        internal.pLR_inmigr[i - 1 + shared->dim_pLR_inmigr_1 * (j - 1) + shared->dim_pLR_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pLR_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pLR_inmigr_2; ++j) {
        int k = 2;
        internal.pLR_inmigr[i - 1 + shared->dim_pLR_inmigr_1 * (j - 1) + shared->dim_pLR_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pLR_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pLR_inmigr_2; ++j) {
        int k = 3;
        internal.pLR_inmigr[i - 1 + shared->dim_pLR_inmigr_1 * (j - 1) + shared->dim_pLR_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pR_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pR_inmigr_2; ++j) {
        int k = 1;
        internal.pR_inmigr[i - 1 + shared->dim_pR_inmigr_1 * (j - 1) + shared->dim_pR_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pR_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pR_inmigr_2; ++j) {
        int k = 2;
        internal.pR_inmigr[i - 1 + shared->dim_pR_inmigr_1 * (j - 1) + shared->dim_pR_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pR_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pR_inmigr_2; ++j) {
        int k = 3;
        internal.pR_inmigr[i - 1 + shared->dim_pR_inmigr_1 * (j - 1) + shared->dim_pR_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pSC_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pSC_inmigr_2; ++j) {
        int k = 1;
        internal.pSC_inmigr[i - 1 + shared->dim_pSC_inmigr_1 * (j - 1) + shared->dim_pSC_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pSC_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pSC_inmigr_2; ++j) {
        int k = 2;
        internal.pSC_inmigr[i - 1 + shared->dim_pSC_inmigr_1 * (j - 1) + shared->dim_pSC_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pSC_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pSC_inmigr_2; ++j) {
        int k = 3;
        internal.pSC_inmigr[i - 1 + shared->dim_pSC_inmigr_1 * (j - 1) + shared->dim_pSC_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pTr_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pTr_inmigr_2; ++j) {
        int k = 1;
        internal.pTr_inmigr[i - 1 + shared->dim_pTr_inmigr_1 * (j - 1) + shared->dim_pTr_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pTr_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pTr_inmigr_2; ++j) {
        int k = 2;
        internal.pTr_inmigr[i - 1 + shared->dim_pTr_inmigr_1 * (j - 1) + shared->dim_pTr_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pTr_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pTr_inmigr_2; ++j) {
        int k = 3;
        internal.pTr_inmigr[i - 1 + shared->dim_pTr_inmigr_1 * (j - 1) + shared->dim_pTr_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pU_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pU_inmigr_2; ++j) {
        int k = 1;
        internal.pU_inmigr[i - 1 + shared->dim_pU_inmigr_1 * (j - 1) + shared->dim_pU_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pU_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pU_inmigr_2; ++j) {
        int k = 2;
        internal.pU_inmigr[i - 1 + shared->dim_pU_inmigr_1 * (j - 1) + shared->dim_pU_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_pU_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_pU_inmigr_2; ++j) {
        int k = 3;
        internal.pU_inmigr[i - 1 + shared->dim_pU_inmigr_1 * (j - 1) + shared->dim_pU_inmigr_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] > shared->tol ? internal.m_in_t[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_rate_D_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_D_2; ++j) {
        int k = 1;
        internal.rate_D[i - 1 + shared->dim_rate_D_1 * (j - 1) + shared->dim_rate_D_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate + shared->age_rate[j - 1] + internal.HIV_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_D_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_D_2; ++j) {
        int k = 2;
        internal.rate_D[i - 1 + shared->dim_rate_D_1 * (j - 1) + shared->dim_rate_D_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate + shared->age_rate[j - 1] + internal.ART_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_D_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_D_2; ++j) {
        int k = 3;
        internal.rate_D[i - 1 + shared->dim_rate_D_1 * (j - 1) + shared->dim_rate_D_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->dtct_rate + shared->slfcr_rate + shared->regress_rate + shared->age_rate[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_LR_2; ++j) {
        int k = 1;
        internal.rate_LR[i - 1 + shared->dim_rate_LR_1 * (j - 1) + shared->dim_rate_LR_12 * (k - 1)] = internal.mu_noHIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[0] + shared->pLL + shared->age_rate[j - 1] + internal.HIV_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_LR_2; ++j) {
        int k = 2;
        internal.rate_LR[i - 1 + shared->dim_rate_LR_1 * (j - 1) + shared->dim_rate_LR_12 * (k - 1)] = internal.mu_HIV_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[1] + shared->pLL + shared->age_rate[j - 1] + internal.ART_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_LR_2; ++j) {
        int k = 3;
        internal.rate_LR[i - 1 + shared->dim_rate_LR_1 * (j - 1) + shared->dim_rate_LR_12 * (k - 1)] = internal.mu_ART_t[j - 1] + shared->pDf * shared->IRR[i - 1] * shared->Hirr[2] + shared->pLL + shared->age_rate[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_SC_2; ++j) {
        int k = 1;
        internal.rate_SC[i - 1 + shared->dim_rate_SC_1 * (j - 1) + shared->dim_rate_SC_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate + shared->age_rate[j - 1] + internal.HIV_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_SC_2; ++j) {
        int k = 2;
        internal.rate_SC[i - 1 + shared->dim_rate_SC_1 * (j - 1) + shared->dim_rate_SC_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate + shared->age_rate[j - 1] + internal.ART_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_SC_2; ++j) {
        int k = 3;
        internal.rate_SC[i - 1 + shared->dim_rate_SC_1 * (j - 1) + shared->dim_rate_SC_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->TBd_rate + shared->dtct_rate_SC + shared->slfcr_rate + shared->progress_rate + shared->age_rate[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_Tr_2; ++j) {
        int k = 1;
        internal.rate_Tr[i - 1 + shared->dim_rate_Tr_1 * (j - 1) + shared->dim_rate_Tr_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate + shared->age_rate[j - 1] + internal.HIV_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_Tr_2; ++j) {
        int k = 2;
        internal.rate_Tr[i - 1 + shared->dim_rate_Tr_1 * (j - 1) + shared->dim_rate_Tr_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate + shared->age_rate[j - 1] + internal.ART_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_Tr_2; ++j) {
        int k = 3;
        internal.rate_Tr[i - 1 + shared->dim_rate_Tr_1 * (j - 1) + shared->dim_rate_Tr_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->Trsucc_rate + shared->Trxd_rate + shared->age_rate[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_Sij_1; ++i) {
      for (int j = 1; j <= shared->dim_Sij_2; ++j) {
        state_next[shared->offset_variable_Sij + i - 1 + shared->dim_Sij_1 * (j - 1)] = dust::math::exp(- shared->zk[0]) * (Tijk[shared->dim_Tijk_12 * 0 + shared->dim_Tijk_1 * (j - 1) + i - 1] + Sij[shared->dim_Sij_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_foi; ++i) {
      internal.foi[i - 1] = odin_sum2<real_type>(internal.foitemp.data(), i - 1, i, 0, shared->dim_foitemp_2, shared->dim_foitemp_1);
    }
    for (int i = 1; i <= shared->dim_Nevents_D_1; ++i) {
      for (int j = 1; j <= shared->dim_Nevents_D_2; ++j) {
        for (int k = 1; k <= shared->dim_Nevents_D_3; ++k) {
          internal.Nevents_D[i - 1 + shared->dim_Nevents_D_1 * (j - 1) + shared->dim_Nevents_D_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, D[shared->dim_D_12 * (k - 1) + shared->dim_D_1 * (j - 1) + i - 1], 1 - dust::math::exp(- internal.rate_D[shared->dim_rate_D_12 * (k - 1) + shared->dim_rate_D_1 * (j - 1) + i - 1] * shared->dt));
        }
      }
    }
    for (int i = 1; i <= shared->dim_Nevents_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_Nevents_LR_2; ++j) {
        for (int k = 1; k <= shared->dim_Nevents_LR_3; ++k) {
          internal.Nevents_LR[i - 1 + shared->dim_Nevents_LR_1 * (j - 1) + shared->dim_Nevents_LR_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, LR[shared->dim_LR_12 * (k - 1) + shared->dim_LR_1 * (j - 1) + i - 1], 1 - dust::math::exp(- internal.rate_LR[shared->dim_rate_LR_12 * (k - 1) + shared->dim_rate_LR_1 * (j - 1) + i - 1] * shared->dt));
        }
      }
    }
    for (int i = 1; i <= shared->dim_Nevents_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_Nevents_SC_2; ++j) {
        for (int k = 1; k <= shared->dim_Nevents_SC_3; ++k) {
          internal.Nevents_SC[i - 1 + shared->dim_Nevents_SC_1 * (j - 1) + shared->dim_Nevents_SC_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, SC[shared->dim_SC_12 * (k - 1) + shared->dim_SC_1 * (j - 1) + i - 1], 1 - dust::math::exp(- internal.rate_SC[shared->dim_rate_SC_12 * (k - 1) + shared->dim_rate_SC_1 * (j - 1) + i - 1] * shared->dt));
        }
      }
    }
    for (int i = 1; i <= shared->dim_Nevents_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_Nevents_Tr_2; ++j) {
        for (int k = 1; k <= shared->dim_Nevents_Tr_3; ++k) {
          internal.Nevents_Tr[i - 1 + shared->dim_Nevents_Tr_1 * (j - 1) + shared->dim_Nevents_Tr_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, Tr[shared->dim_Tr_12 * (k - 1) + shared->dim_Tr_1 * (j - 1) + i - 1], 1 - dust::math::exp(- internal.rate_Tr[shared->dim_rate_Tr_12 * (k - 1) + shared->dim_rate_Tr_1 * (j - 1) + i - 1] * shared->dt));
        }
      }
    }
    for (int i = 1; i <= shared->dim_p_Dage_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Dage_2; ++j) {
        for (int k = 1; k <= shared->dim_p_Dage_3; ++k) {
          internal.p_Dage[i - 1 + shared->dim_p_Dage_1 * (j - 1) + shared->dim_p_Dage_12 * (k - 1)] = (internal.rate_D[shared->dim_rate_D_12 * (k - 1) + shared->dim_rate_D_1 * (j - 1) + i - 1] > shared->tol ? shared->age_rate[j - 1] / (real_type) internal.rate_D[shared->dim_rate_D_12 * (k - 1) + shared->dim_rate_D_1 * (j - 1) + i - 1] : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_p_LRage_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LRage_2; ++j) {
        for (int k = 1; k <= shared->dim_p_LRage_3; ++k) {
          internal.p_LRage[i - 1 + shared->dim_p_LRage_1 * (j - 1) + shared->dim_p_LRage_12 * (k - 1)] = (internal.rate_LR[shared->dim_rate_LR_12 * (k - 1) + shared->dim_rate_LR_1 * (j - 1) + i - 1] > shared->tol ? shared->age_rate[j - 1] / (real_type) internal.rate_LR[shared->dim_rate_LR_12 * (k - 1) + shared->dim_rate_LR_1 * (j - 1) + i - 1] : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_p_SCage_1; ++i) {
      for (int j = 1; j <= shared->dim_p_SCage_2; ++j) {
        for (int k = 1; k <= shared->dim_p_SCage_3; ++k) {
          internal.p_SCage[i - 1 + shared->dim_p_SCage_1 * (j - 1) + shared->dim_p_SCage_12 * (k - 1)] = (internal.rate_SC[shared->dim_rate_SC_12 * (k - 1) + shared->dim_rate_SC_1 * (j - 1) + i - 1] > shared->tol ? shared->age_rate[j - 1] / (real_type) internal.rate_SC[shared->dim_rate_SC_12 * (k - 1) + shared->dim_rate_SC_1 * (j - 1) + i - 1] : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_p_Trage_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Trage_2; ++j) {
        for (int k = 1; k <= shared->dim_p_Trage_3; ++k) {
          internal.p_Trage[i - 1 + shared->dim_p_Trage_1 * (j - 1) + shared->dim_p_Trage_12 * (k - 1)] = (internal.rate_Tr[shared->dim_rate_Tr_12 * (k - 1) + shared->dim_rate_Tr_1 * (j - 1) + i - 1] > shared->tol ? shared->age_rate[j - 1] / (real_type) internal.rate_Tr[shared->dim_rate_Tr_12 * (k - 1) + shared->dim_rate_Tr_1 * (j - 1) + i - 1] : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_out_D_1; ++i) {
      for (int j = 1; j <= shared->dim_age_out_D_2; ++j) {
        for (int k = 1; k <= shared->dim_age_out_D_3; ++k) {
          internal.age_out_D[i - 1 + shared->dim_age_out_D_1 * (j - 1) + shared->dim_age_out_D_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1], internal.p_Dage[shared->dim_p_Dage_12 * (k - 1) + shared->dim_p_Dage_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_out_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_age_out_LR_2; ++j) {
        for (int k = 1; k <= shared->dim_age_out_LR_3; ++k) {
          internal.age_out_LR[i - 1 + shared->dim_age_out_LR_1 * (j - 1) + shared->dim_age_out_LR_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_LR[shared->dim_Nevents_LR_12 * (k - 1) + shared->dim_Nevents_LR_1 * (j - 1) + i - 1], internal.p_LRage[shared->dim_p_LRage_12 * (k - 1) + shared->dim_p_LRage_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_out_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_age_out_SC_2; ++j) {
        for (int k = 1; k <= shared->dim_age_out_SC_3; ++k) {
          internal.age_out_SC[i - 1 + shared->dim_age_out_SC_1 * (j - 1) + shared->dim_age_out_SC_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1], internal.p_SCage[shared->dim_p_SCage_12 * (k - 1) + shared->dim_p_SCage_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_out_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_age_out_Tr_2; ++j) {
        for (int k = 1; k <= shared->dim_age_out_Tr_3; ++k) {
          internal.age_out_Tr[i - 1 + shared->dim_age_out_Tr_1 * (j - 1) + shared->dim_age_out_Tr_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_Tr[shared->dim_Nevents_Tr_12 * (k - 1) + shared->dim_Nevents_Tr_1 * (j - 1) + i - 1], internal.p_Trage[shared->dim_p_Trage_12 * (k - 1) + shared->dim_p_Trage_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_p_LLHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LLHIV_2; ++j) {
        int k = 1;
        internal.p_LLHIV[i - 1 + shared->dim_p_LLHIV_1 * (j - 1) + shared->dim_p_LLHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[0] + internal.HIV_rate_yr[j - 1] > shared->tol ? internal.HIV_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[0] + internal.HIV_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_LLHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LLHIV_2; ++j) {
        int k = 2;
        internal.p_LLHIV[i - 1 + shared->dim_p_LLHIV_1 * (j - 1) + shared->dim_p_LLHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[1] + internal.ART_rate_yr[j - 1] > shared->tol ? internal.ART_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[1] + internal.ART_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_LLHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LLHIV_2; ++j) {
        int k = 3;
        internal.p_LLHIV[i - 1 + shared->dim_p_LLHIV_1 * (j - 1) + shared->dim_p_LLHIV_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_p_LLinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LLinfs_2; ++j) {
        int k = 1;
        internal.p_LLinfs[i - 1 + shared->dim_p_LLinfs_1 * (j - 1) + shared->dim_p_LLinfs_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[0] > shared->tol ? shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[0]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_LLinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LLinfs_2; ++j) {
        int k = 2;
        internal.p_LLinfs[i - 1 + shared->dim_p_LLinfs_1 * (j - 1) + shared->dim_p_LLinfs_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[1] > shared->tol ? shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_LLinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LLinfs_2; ++j) {
        int k = 3;
        internal.p_LLinfs[i - 1 + shared->dim_p_LLinfs_1 * (j - 1) + shared->dim_p_LLinfs_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[2] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[2] > shared->tol ? shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[2] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[2] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[2]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_progSlow_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progSlow_2; ++j) {
        int k = 1;
        internal.p_progSlow[i - 1 + shared->dim_p_progSlow_1 * (j - 1) + shared->dim_p_progSlow_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[0] > shared->tol ? shared->IRR[i - 1] * shared->pDs * shared->Hirr[0] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[0]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_progSlow_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progSlow_2; ++j) {
        int k = 2;
        internal.p_progSlow[i - 1 + shared->dim_p_progSlow_1 * (j - 1) + shared->dim_p_progSlow_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[1] > shared->tol ? shared->IRR[i - 1] * shared->pDs * shared->Hirr[1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_progSlow_1; ++i) {
      for (int j = 1; j <= shared->dim_p_progSlow_2; ++j) {
        int k = 3;
        internal.p_progSlow[i - 1 + shared->dim_p_progSlow_1 * (j - 1) + shared->dim_p_progSlow_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[2] > shared->tol ? shared->IRR[i - 1] * shared->pDs * shared->Hirr[2] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[2] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[2]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_RHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_RHIV_2; ++j) {
        int k = 1;
        internal.p_RHIV[i - 1 + shared->dim_p_RHIV_1 * (j - 1) + shared->dim_p_RHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[0] + internal.HIV_rate_yr[j - 1] > shared->tol ? internal.HIV_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[0] + internal.HIV_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_RHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_RHIV_2; ++j) {
        int k = 2;
        internal.p_RHIV[i - 1 + shared->dim_p_RHIV_1 * (j - 1) + shared->dim_p_RHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[1] + internal.ART_rate_yr[j - 1] > shared->tol ? internal.ART_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[1] + internal.ART_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_RHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_RHIV_2; ++j) {
        int k = 3;
        internal.p_RHIV[i - 1 + shared->dim_p_RHIV_1 * (j - 1) + shared->dim_p_RHIV_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_p_Rinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Rinfs_2; ++j) {
        int k = 1;
        internal.p_Rinfs[i - 1 + shared->dim_p_Rinfs_1 * (j - 1) + shared->dim_p_Rinfs_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[0] > shared->tol ? shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[0]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Rinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Rinfs_2; ++j) {
        int k = 2;
        internal.p_Rinfs[i - 1 + shared->dim_p_Rinfs_1 * (j - 1) + shared->dim_p_Rinfs_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[1] > shared->tol ? shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Rinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Rinfs_2; ++j) {
        int k = 3;
        internal.p_Rinfs[i - 1 + shared->dim_p_Rinfs_1 * (j - 1) + shared->dim_p_Rinfs_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[2] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[2] > shared->tol ? shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[2] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[2]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_UHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_UHIV_2; ++j) {
        int k = 1;
        internal.p_UHIV[i - 1 + shared->dim_p_UHIV_1 * (j - 1) + shared->dim_p_UHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[0] + internal.HIV_rate_yr[j - 1] > shared->tol ? internal.HIV_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[0] + internal.HIV_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_UHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_UHIV_2; ++j) {
        int k = 2;
        internal.p_UHIV[i - 1 + shared->dim_p_UHIV_1 * (j - 1) + shared->dim_p_UHIV_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[1] + internal.ART_rate_yr[j - 1] > shared->tol ? internal.ART_rate_yr[j - 1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[1] + internal.ART_rate_yr[j - 1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_UHIV_1; ++i) {
      for (int j = 1; j <= shared->dim_p_UHIV_2; ++j) {
        int k = 3;
        internal.p_UHIV[i - 1 + shared->dim_p_UHIV_1 * (j - 1) + shared->dim_p_UHIV_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_p_Uinf_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Uinf_2; ++j) {
        int k = 1;
        internal.p_Uinf[i - 1 + shared->dim_p_Uinf_1 * (j - 1) + shared->dim_p_Uinf_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[0] > shared->tol ? internal.foi[i - 1] * shared->TB_HIV_mod[0] / (real_type) (internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[0]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Uinf_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Uinf_2; ++j) {
        int k = 2;
        internal.p_Uinf[i - 1 + shared->dim_p_Uinf_1 * (j - 1) + shared->dim_p_Uinf_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[1] > shared->tol ? internal.foi[i - 1] * shared->TB_HIV_mod[1] / (real_type) (internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[1]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_p_Uinf_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Uinf_2; ++j) {
        int k = 3;
        internal.p_Uinf[i - 1 + shared->dim_p_Uinf_1 * (j - 1) + shared->dim_p_Uinf_12 * (k - 1)] = (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[2] > shared->tol ? internal.foi[i - 1] * shared->TB_HIV_mod[2] / (real_type) (internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[2]) : 0);
      }
    }
    for (int i = 1; i <= shared->dim_Pellij_1; ++i) {
      for (int j = 1; j <= shared->dim_Pellij_2; ++j) {
        internal.Pellij[i - 1 + shared->dim_Pellij_1 * (j - 1)] = internal.foitemp[shared->dim_foitemp_1 * (j - 1) + i - 1] / (real_type) (internal.foi[i - 1] + shared->tol);
      }
    }
    for (int i = 1; i <= shared->dim_rate_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_LL_2; ++j) {
        int k = 1;
        internal.rate_LL[i - 1 + shared->dim_rate_LL_1 * (j - 1) + shared->dim_rate_LL_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[0] + shared->age_rate[j - 1] + internal.HIV_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_LL_2; ++j) {
        int k = 2;
        internal.rate_LL[i - 1 + shared->dim_rate_LL_1 * (j - 1) + shared->dim_rate_LL_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[1] + shared->age_rate[j - 1] + internal.ART_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_LL_2; ++j) {
        int k = 3;
        internal.rate_LL[i - 1 + shared->dim_rate_LL_1 * (j - 1) + shared->dim_rate_LL_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[2] + shared->pDs * shared->IRR[i - 1] * shared->Hirr[2] + shared->age_rate[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_R_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_R_2; ++j) {
        int k = 1;
        internal.rate_R[i - 1 + shared->dim_rate_R_1 * (j - 1) + shared->dim_rate_R_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[0] + shared->age_rate[j - 1] + internal.HIV_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_R_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_R_2; ++j) {
        int k = 2;
        internal.rate_R[i - 1 + shared->dim_rate_R_1 * (j - 1) + shared->dim_rate_R_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[1] + shared->age_rate[j - 1] + internal.ART_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_R_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_R_2; ++j) {
        int k = 3;
        internal.rate_R[i - 1 + shared->dim_rate_R_1 * (j - 1) + shared->dim_rate_R_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + shared->v * internal.foi[i - 1] * shared->TB_HIV_mod[2] + shared->pDr * shared->IRR[i - 1] * shared->Hirr[2] + shared->age_rate[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_U_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_U_2; ++j) {
        int k = 1;
        internal.rate_U[i - 1 + shared->dim_rate_U_1 * (j - 1) + shared->dim_rate_U_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_noHIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[0] + shared->age_rate[j - 1] + internal.HIV_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_U_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_U_2; ++j) {
        int k = 2;
        internal.rate_U[i - 1 + shared->dim_rate_U_1 * (j - 1) + shared->dim_rate_U_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_HIV_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[1] + shared->age_rate[j - 1] + internal.ART_rate_yr[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_rate_U_1; ++i) {
      for (int j = 1; j <= shared->dim_rate_U_2; ++j) {
        int k = 3;
        internal.rate_U[i - 1 + shared->dim_rate_U_1 * (j - 1) + shared->dim_rate_U_12 * (k - 1)] = internal.m_in_t[j - 1] + internal.mu_ART_t[j - 1] + internal.foi[i - 1] * shared->TB_HIV_mod[2] + shared->age_rate[j - 1];
      }
    }
    for (int i = 1; i <= shared->dim_age_in_D_1; ++i) {
      for (int j = 2; j <= shared->age_dims; ++j) {
        for (int k = 1; k <= shared->dim_age_in_D_3; ++k) {
          internal.age_in_D[i - 1 + shared->dim_age_in_D_1 * (j - 1) + shared->dim_age_in_D_12 * (k - 1)] = internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1 - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_in_D_1; ++i) {
      int j = 1;
      for (int k = 1; k <= shared->dim_age_in_D_3; ++k) {
        internal.age_in_D[i - 1 + shared->dim_age_in_D_1 * (j - 1) + shared->dim_age_in_D_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_age_in_LR_1; ++i) {
      for (int j = 2; j <= shared->age_dims; ++j) {
        for (int k = 1; k <= shared->dim_age_in_LR_3; ++k) {
          internal.age_in_LR[i - 1 + shared->dim_age_in_LR_1 * (j - 1) + shared->dim_age_in_LR_12 * (k - 1)] = internal.age_out_LR[shared->dim_age_out_LR_12 * (k - 1) + shared->dim_age_out_LR_1 * (j - 1 - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_in_LR_1; ++i) {
      int j = 1;
      for (int k = 1; k <= shared->dim_age_in_LR_3; ++k) {
        internal.age_in_LR[i - 1 + shared->dim_age_in_LR_1 * (j - 1) + shared->dim_age_in_LR_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_age_in_SC_1; ++i) {
      for (int j = 2; j <= shared->age_dims; ++j) {
        for (int k = 1; k <= shared->dim_age_in_SC_3; ++k) {
          internal.age_in_SC[i - 1 + shared->dim_age_in_SC_1 * (j - 1) + shared->dim_age_in_SC_12 * (k - 1)] = internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1 - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_in_SC_1; ++i) {
      int j = 1;
      for (int k = 1; k <= shared->dim_age_in_SC_3; ++k) {
        internal.age_in_SC[i - 1 + shared->dim_age_in_SC_1 * (j - 1) + shared->dim_age_in_SC_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_age_in_Tr_1; ++i) {
      for (int j = 2; j <= shared->age_dims; ++j) {
        for (int k = 1; k <= shared->dim_age_in_Tr_3; ++k) {
          internal.age_in_Tr[i - 1 + shared->dim_age_in_Tr_1 * (j - 1) + shared->dim_age_in_Tr_12 * (k - 1)] = internal.age_out_Tr[shared->dim_age_out_Tr_12 * (k - 1) + shared->dim_age_out_Tr_1 * (j - 1 - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_in_Tr_1; ++i) {
      int j = 1;
      for (int k = 1; k <= shared->dim_age_in_Tr_3; ++k) {
        internal.age_in_Tr[i - 1 + shared->dim_age_in_Tr_1 * (j - 1) + shared->dim_age_in_Tr_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_HIV_out_D_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_out_D_2; ++j) {
        for (int k = 1; k <= shared->dim_HIV_out_D_3; ++k) {
          internal.HIV_out_D[i - 1 + shared->dim_HIV_out_D_1 * (j - 1) + shared->dim_HIV_out_D_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1], internal.p_DHIV[shared->dim_p_DHIV_12 * (k - 1) + shared->dim_p_DHIV_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_out_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_out_LR_2; ++j) {
        for (int k = 1; k <= shared->dim_HIV_out_LR_3; ++k) {
          internal.HIV_out_LR[i - 1 + shared->dim_HIV_out_LR_1 * (j - 1) + shared->dim_HIV_out_LR_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_LR[shared->dim_Nevents_LR_12 * (k - 1) + shared->dim_Nevents_LR_1 * (j - 1) + i - 1] - internal.age_out_LR[shared->dim_age_out_LR_12 * (k - 1) + shared->dim_age_out_LR_1 * (j - 1) + i - 1], internal.p_LRHIV[shared->dim_p_LRHIV_12 * (k - 1) + shared->dim_p_LRHIV_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_out_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_out_SC_2; ++j) {
        for (int k = 1; k <= shared->dim_HIV_out_SC_3; ++k) {
          internal.HIV_out_SC[i - 1 + shared->dim_HIV_out_SC_1 * (j - 1) + shared->dim_HIV_out_SC_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1], internal.p_SCHIV[shared->dim_p_SCHIV_12 * (k - 1) + shared->dim_p_SCHIV_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_out_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_out_Tr_2; ++j) {
        for (int k = 1; k <= shared->dim_HIV_out_Tr_3; ++k) {
          internal.HIV_out_Tr[i - 1 + shared->dim_HIV_out_Tr_1 * (j - 1) + shared->dim_HIV_out_Tr_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_Tr[shared->dim_Nevents_Tr_12 * (k - 1) + shared->dim_Nevents_Tr_1 * (j - 1) + i - 1] - internal.age_out_Tr[shared->dim_age_out_Tr_12 * (k - 1) + shared->dim_age_out_Tr_1 * (j - 1) + i - 1], internal.p_TrHIV[shared->dim_p_TrHIV_12 * (k - 1) + shared->dim_p_TrHIV_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_Nevents_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_Nevents_LL_2; ++j) {
        for (int k = 1; k <= shared->dim_Nevents_LL_3; ++k) {
          internal.Nevents_LL[i - 1 + shared->dim_Nevents_LL_1 * (j - 1) + shared->dim_Nevents_LL_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, LL[shared->dim_LL_12 * (k - 1) + shared->dim_LL_1 * (j - 1) + i - 1], 1 - dust::math::exp(- internal.rate_LL[shared->dim_rate_LL_12 * (k - 1) + shared->dim_rate_LL_1 * (j - 1) + i - 1] * shared->dt));
        }
      }
    }
    for (int i = 1; i <= shared->dim_Nevents_R_1; ++i) {
      for (int j = 1; j <= shared->dim_Nevents_R_2; ++j) {
        for (int k = 1; k <= shared->dim_Nevents_R_3; ++k) {
          internal.Nevents_R[i - 1 + shared->dim_Nevents_R_1 * (j - 1) + shared->dim_Nevents_R_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, R[shared->dim_R_12 * (k - 1) + shared->dim_R_1 * (j - 1) + i - 1], 1 - dust::math::exp(- internal.rate_R[shared->dim_rate_R_12 * (k - 1) + shared->dim_rate_R_1 * (j - 1) + i - 1] * shared->dt));
        }
      }
    }
    for (int i = 1; i <= shared->dim_Nevents_U_1; ++i) {
      for (int j = 1; j <= shared->dim_Nevents_U_2; ++j) {
        for (int k = 1; k <= shared->dim_Nevents_U_3; ++k) {
          internal.Nevents_U[i - 1 + shared->dim_Nevents_U_1 * (j - 1) + shared->dim_Nevents_U_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, U[shared->dim_U_12 * (k - 1) + shared->dim_U_1 * (j - 1) + i - 1], 1 - dust::math::exp(- internal.rate_U[shared->dim_rate_U_12 * (k - 1) + shared->dim_rate_U_1 * (j - 1) + i - 1] * shared->dt));
        }
      }
    }
    for (int i = 1; i <= shared->dim_NotesByPatchPatch_1; ++i) {
      for (int j = 1; j <= shared->dim_NotesByPatchPatch_2; ++j) {
        internal.NotesByPatchPatch[i - 1 + shared->dim_NotesByPatchPatch_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.NotesByPatch[i - 1], internal.Pellij[shared->dim_Pellij_1 * (j - 1) + i - 1]);
      }
    }
    for (int i = 1; i <= shared->dim_p_LLage_1; ++i) {
      for (int j = 1; j <= shared->dim_p_LLage_2; ++j) {
        for (int k = 1; k <= shared->dim_p_LLage_3; ++k) {
          internal.p_LLage[i - 1 + shared->dim_p_LLage_1 * (j - 1) + shared->dim_p_LLage_12 * (k - 1)] = (internal.rate_LL[shared->dim_rate_LL_12 * (k - 1) + shared->dim_rate_LL_1 * (j - 1) + i - 1] > shared->tol ? shared->age_rate[j - 1] / (real_type) internal.rate_LL[shared->dim_rate_LL_12 * (k - 1) + shared->dim_rate_LL_1 * (j - 1) + i - 1] : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_p_Rage_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Rage_2; ++j) {
        for (int k = 1; k <= shared->dim_p_Rage_3; ++k) {
          internal.p_Rage[i - 1 + shared->dim_p_Rage_1 * (j - 1) + shared->dim_p_Rage_12 * (k - 1)] = (internal.rate_R[shared->dim_rate_R_12 * (k - 1) + shared->dim_rate_R_1 * (j - 1) + i - 1] > shared->tol ? shared->age_rate[j - 1] / (real_type) internal.rate_R[shared->dim_rate_R_12 * (k - 1) + shared->dim_rate_R_1 * (j - 1) + i - 1] : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_p_Uage_1; ++i) {
      for (int j = 1; j <= shared->dim_p_Uage_2; ++j) {
        for (int k = 1; k <= shared->dim_p_Uage_3; ++k) {
          internal.p_Uage[i - 1 + shared->dim_p_Uage_1 * (j - 1) + shared->dim_p_Uage_12 * (k - 1)] = (internal.rate_U[shared->dim_rate_U_12 * (k - 1) + shared->dim_rate_U_1 * (j - 1) + i - 1] > shared->tol ? shared->age_rate[j - 1] / (real_type) internal.rate_U[shared->dim_rate_U_12 * (k - 1) + shared->dim_rate_U_1 * (j - 1) + i - 1] : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_out_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_age_out_LL_2; ++j) {
        for (int k = 1; k <= shared->dim_age_out_LL_3; ++k) {
          internal.age_out_LL[i - 1 + shared->dim_age_out_LL_1 * (j - 1) + shared->dim_age_out_LL_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_LL[shared->dim_Nevents_LL_12 * (k - 1) + shared->dim_Nevents_LL_1 * (j - 1) + i - 1], internal.p_LLage[shared->dim_p_LLage_12 * (k - 1) + shared->dim_p_LLage_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_out_R_1; ++i) {
      for (int j = 1; j <= shared->dim_age_out_R_2; ++j) {
        for (int k = 1; k <= shared->dim_age_out_R_3; ++k) {
          internal.age_out_R[i - 1 + shared->dim_age_out_R_1 * (j - 1) + shared->dim_age_out_R_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_R[shared->dim_Nevents_R_12 * (k - 1) + shared->dim_Nevents_R_1 * (j - 1) + i - 1], internal.p_Rage[shared->dim_p_Rage_12 * (k - 1) + shared->dim_p_Rage_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_out_U_1; ++i) {
      for (int j = 1; j <= shared->dim_age_out_U_2; ++j) {
        for (int k = 1; k <= shared->dim_age_out_U_3; ++k) {
          internal.age_out_U[i - 1 + shared->dim_age_out_U_1 * (j - 1) + shared->dim_age_out_U_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_U[shared->dim_Nevents_U_12 * (k - 1) + shared->dim_Nevents_U_1 * (j - 1) + i - 1], internal.p_Uage[shared->dim_p_Uage_12 * (k - 1) + shared->dim_p_Uage_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_detection_1; ++i) {
      for (int j = 1; j <= shared->dim_detection_2; ++j) {
        for (int k = 1; k <= shared->dim_detection_3; ++k) {
          internal.detection[i - 1 + shared->dim_detection_1 * (j - 1) + shared->dim_detection_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1] - internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1], internal.p_detect[shared->dim_p_detect_12 * (k - 1) + shared->dim_p_detect_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_detection_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_detection_SC_2; ++j) {
        for (int k = 1; k <= shared->dim_detection_SC_3; ++k) {
          internal.detection_SC[i - 1 + shared->dim_detection_SC_1 * (j - 1) + shared->dim_detection_SC_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1] - internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1], internal.p_detect_SC[shared->dim_p_detect_SC_12 * (k - 1) + shared->dim_p_detect_SC_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_D_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_D_2; ++j) {
        for (int k = 2; k <= shared->HIV_dims; ++k) {
          internal.HIV_in_D[i - 1 + shared->dim_HIV_in_D_1 * (j - 1) + shared->dim_HIV_in_D_12 * (k - 1)] = internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1 - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_D_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_D_2; ++j) {
        int k = 1;
        internal.HIV_in_D[i - 1 + shared->dim_HIV_in_D_1 * (j - 1) + shared->dim_HIV_in_D_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_LR_2; ++j) {
        for (int k = 2; k <= shared->HIV_dims; ++k) {
          internal.HIV_in_LR[i - 1 + shared->dim_HIV_in_LR_1 * (j - 1) + shared->dim_HIV_in_LR_12 * (k - 1)] = internal.HIV_out_LR[shared->dim_HIV_out_LR_12 * (k - 1 - 1) + shared->dim_HIV_out_LR_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_LR_2; ++j) {
        int k = 1;
        internal.HIV_in_LR[i - 1 + shared->dim_HIV_in_LR_1 * (j - 1) + shared->dim_HIV_in_LR_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_SC_2; ++j) {
        for (int k = 2; k <= shared->HIV_dims; ++k) {
          internal.HIV_in_SC[i - 1 + shared->dim_HIV_in_SC_1 * (j - 1) + shared->dim_HIV_in_SC_12 * (k - 1)] = internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1 - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_SC_2; ++j) {
        int k = 1;
        internal.HIV_in_SC[i - 1 + shared->dim_HIV_in_SC_1 * (j - 1) + shared->dim_HIV_in_SC_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_Tr_2; ++j) {
        for (int k = 2; k <= shared->HIV_dims; ++k) {
          internal.HIV_in_Tr[i - 1 + shared->dim_HIV_in_Tr_1 * (j - 1) + shared->dim_HIV_in_Tr_12 * (k - 1)] = internal.HIV_out_Tr[shared->dim_HIV_out_Tr_12 * (k - 1 - 1) + shared->dim_HIV_out_Tr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_Tr_2; ++j) {
        int k = 1;
        internal.HIV_in_Tr[i - 1 + shared->dim_HIV_in_Tr_1 * (j - 1) + shared->dim_HIV_in_Tr_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_progFast_1; ++i) {
      for (int j = 1; j <= shared->dim_progFast_2; ++j) {
        for (int k = 1; k <= shared->dim_progFast_3; ++k) {
          internal.progFast[i - 1 + shared->dim_progFast_1 * (j - 1) + shared->dim_progFast_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_LR[shared->dim_Nevents_LR_12 * (k - 1) + shared->dim_Nevents_LR_1 * (j - 1) + i - 1] - internal.age_out_LR[shared->dim_age_out_LR_12 * (k - 1) + shared->dim_age_out_LR_1 * (j - 1) + i - 1] - internal.HIV_out_LR[shared->dim_HIV_out_LR_12 * (k - 1) + shared->dim_HIV_out_LR_1 * (j - 1) + i - 1], internal.p_progFast[shared->dim_p_progFast_12 * (k - 1) + shared->dim_p_progFast_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_Trsuccess_1; ++i) {
      for (int j = 1; j <= shared->dim_Trsuccess_2; ++j) {
        for (int k = 1; k <= shared->dim_Trsuccess_3; ++k) {
          internal.Trsuccess[i - 1 + shared->dim_Trsuccess_1 * (j - 1) + shared->dim_Trsuccess_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_Tr[shared->dim_Nevents_Tr_12 * (k - 1) + shared->dim_Nevents_Tr_1 * (j - 1) + i - 1] - internal.age_out_Tr[shared->dim_age_out_Tr_12 * (k - 1) + shared->dim_age_out_Tr_1 * (j - 1) + i - 1] - internal.HIV_out_Tr[shared->dim_HIV_out_Tr_12 * (k - 1) + shared->dim_HIV_out_Tr_1 * (j - 1) + i - 1], internal.p_Trsuccess[shared->dim_p_Trsuccess_12 * (k - 1) + shared->dim_p_Trsuccess_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_cum_note_flux_1; ++i) {
      for (int j = 1; j <= shared->dim_cum_note_flux_2; ++j) {
        state_next[shared->offset_variable_cum_note_flux + i - 1 + shared->dim_cum_note_flux_1 * (j - 1)] = cum_note_flux[shared->dim_cum_note_flux_1 * (j - 1) + i - 1] + internal.NotesByPatchPatch[shared->dim_NotesByPatchPatch_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_age_in_LL_1; ++i) {
      for (int j = 2; j <= shared->age_dims; ++j) {
        for (int k = 1; k <= shared->dim_age_in_LL_3; ++k) {
          internal.age_in_LL[i - 1 + shared->dim_age_in_LL_1 * (j - 1) + shared->dim_age_in_LL_12 * (k - 1)] = internal.age_out_LL[shared->dim_age_out_LL_12 * (k - 1) + shared->dim_age_out_LL_1 * (j - 1 - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_in_LL_1; ++i) {
      int j = 1;
      for (int k = 1; k <= shared->dim_age_in_LL_3; ++k) {
        internal.age_in_LL[i - 1 + shared->dim_age_in_LL_1 * (j - 1) + shared->dim_age_in_LL_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_age_in_R_1; ++i) {
      for (int j = 2; j <= shared->age_dims; ++j) {
        for (int k = 1; k <= shared->dim_age_in_R_3; ++k) {
          internal.age_in_R[i - 1 + shared->dim_age_in_R_1 * (j - 1) + shared->dim_age_in_R_12 * (k - 1)] = internal.age_out_R[shared->dim_age_out_R_12 * (k - 1) + shared->dim_age_out_R_1 * (j - 1 - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_in_R_1; ++i) {
      int j = 1;
      for (int k = 1; k <= shared->dim_age_in_R_3; ++k) {
        internal.age_in_R[i - 1 + shared->dim_age_in_R_1 * (j - 1) + shared->dim_age_in_R_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_age_in_U_1; ++i) {
      for (int j = 2; j <= shared->age_dims; ++j) {
        for (int k = 1; k <= shared->dim_age_in_U_3; ++k) {
          internal.age_in_U[i - 1 + shared->dim_age_in_U_1 * (j - 1) + shared->dim_age_in_U_12 * (k - 1)] = internal.age_out_U[shared->dim_age_out_U_12 * (k - 1) + shared->dim_age_out_U_1 * (j - 1 - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_age_in_U_1; ++i) {
      int j = 1;
      for (int k = 1; k <= shared->dim_age_in_U_3; ++k) {
        internal.age_in_U[i - 1 + shared->dim_age_in_U_1 * (j - 1) + shared->dim_age_in_U_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_HIV_out_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_out_LL_2; ++j) {
        for (int k = 1; k <= shared->dim_HIV_out_LL_3; ++k) {
          internal.HIV_out_LL[i - 1 + shared->dim_HIV_out_LL_1 * (j - 1) + shared->dim_HIV_out_LL_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_LL[shared->dim_Nevents_LL_12 * (k - 1) + shared->dim_Nevents_LL_1 * (j - 1) + i - 1] - internal.age_out_LL[shared->dim_age_out_LL_12 * (k - 1) + shared->dim_age_out_LL_1 * (j - 1) + i - 1], internal.p_LLHIV[shared->dim_p_LLHIV_12 * (k - 1) + shared->dim_p_LLHIV_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_out_R_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_out_R_2; ++j) {
        for (int k = 1; k <= shared->dim_HIV_out_R_3; ++k) {
          internal.HIV_out_R[i - 1 + shared->dim_HIV_out_R_1 * (j - 1) + shared->dim_HIV_out_R_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_R[shared->dim_Nevents_R_12 * (k - 1) + shared->dim_Nevents_R_1 * (j - 1) + i - 1] - internal.age_out_R[shared->dim_age_out_R_12 * (k - 1) + shared->dim_age_out_R_1 * (j - 1) + i - 1], internal.p_RHIV[shared->dim_p_RHIV_12 * (k - 1) + shared->dim_p_RHIV_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_out_U_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_out_U_2; ++j) {
        for (int k = 1; k <= shared->dim_HIV_out_U_3; ++k) {
          internal.HIV_out_U[i - 1 + shared->dim_HIV_out_U_1 * (j - 1) + shared->dim_HIV_out_U_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_U[shared->dim_Nevents_U_12 * (k - 1) + shared->dim_Nevents_U_1 * (j - 1) + i - 1] - internal.age_out_U[shared->dim_age_out_U_12 * (k - 1) + shared->dim_age_out_U_1 * (j - 1) + i - 1], internal.p_UHIV[shared->dim_p_UHIV_12 * (k - 1) + shared->dim_p_UHIV_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_selfcure_1; ++i) {
      for (int j = 1; j <= shared->dim_selfcure_2; ++j) {
        for (int k = 1; k <= shared->dim_selfcure_3; ++k) {
          internal.selfcure[i - 1 + shared->dim_selfcure_1 * (j - 1) + shared->dim_selfcure_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1] - internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1] - internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1], internal.p_selfcr[shared->dim_p_selfcr_12 * (k - 1) + shared->dim_p_selfcr_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_selfcure_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_selfcure_SC_2; ++j) {
        for (int k = 1; k <= shared->dim_selfcure_SC_3; ++k) {
          internal.selfcure_SC[i - 1 + shared->dim_selfcure_SC_1 * (j - 1) + shared->dim_selfcure_SC_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1] - internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1] - internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1], internal.p_selfcr_SC[shared->dim_p_selfcr_SC_12 * (k - 1) + shared->dim_p_selfcr_SC_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_stabilisations_1; ++i) {
      for (int j = 1; j <= shared->dim_stabilisations_2; ++j) {
        for (int k = 1; k <= shared->dim_stabilisations_3; ++k) {
          internal.stabilisations[i - 1 + shared->dim_stabilisations_1 * (j - 1) + shared->dim_stabilisations_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_LR[shared->dim_Nevents_LR_12 * (k - 1) + shared->dim_Nevents_LR_1 * (j - 1) + i - 1] - internal.age_out_LR[shared->dim_age_out_LR_12 * (k - 1) + shared->dim_age_out_LR_1 * (j - 1) + i - 1] - internal.HIV_out_LR[shared->dim_HIV_out_LR_12 * (k - 1) + shared->dim_HIV_out_LR_1 * (j - 1) + i - 1] - internal.progFast[shared->dim_progFast_12 * (k - 1) + shared->dim_progFast_1 * (j - 1) + i - 1], internal.p_stabilise[shared->dim_p_stabilise_12 * (k - 1) + shared->dim_p_stabilise_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_Trxdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_Trxdeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_Trxdeaths_3; ++k) {
          internal.Trxdeaths[i - 1 + shared->dim_Trxdeaths_1 * (j - 1) + shared->dim_Trxdeaths_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_Tr[shared->dim_Nevents_Tr_12 * (k - 1) + shared->dim_Nevents_Tr_1 * (j - 1) + i - 1] - internal.age_out_Tr[shared->dim_age_out_Tr_12 * (k - 1) + shared->dim_age_out_Tr_1 * (j - 1) + i - 1] - internal.HIV_out_Tr[shared->dim_HIV_out_Tr_12 * (k - 1) + shared->dim_HIV_out_Tr_1 * (j - 1) + i - 1] - internal.Trsuccess[shared->dim_Trsuccess_12 * (k - 1) + shared->dim_Trsuccess_1 * (j - 1) + i - 1], internal.p_Trxdeaths[shared->dim_p_Trxdeaths_12 * (k - 1) + shared->dim_p_Trxdeaths_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_notes_1; ++i) {
      for (int j = 1; j <= shared->dim_notes_2; ++j) {
        for (int k = 1; k <= shared->dim_notes_3; ++k) {
          state_next[shared->offset_variable_notes + i - 1 + shared->dim_notes_1 * (j - 1) + shared->dim_notes_12 * (k - 1)] = internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] + internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_notifrate_1; ++i) {
      for (int j = 1; j <= shared->dim_notifrate_2; ++j) {
        for (int k = 1; k <= shared->dim_notifrate_3; ++k) {
          state_next[shared->offset_variable_notifrate + i - 1 + shared->dim_notifrate_1 * (j - 1) + shared->dim_notifrate_12 * (k - 1)] = 100000 * (internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] + internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1]) / (real_type) (N[shared->dim_N_12 * (k - 1) + shared->dim_N_1 * (j - 1) + i - 1] + static_cast<real_type>(1e-10));
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_LL_2; ++j) {
        for (int k = 2; k <= shared->HIV_dims; ++k) {
          internal.HIV_in_LL[i - 1 + shared->dim_HIV_in_LL_1 * (j - 1) + shared->dim_HIV_in_LL_12 * (k - 1)] = internal.HIV_out_LL[shared->dim_HIV_out_LL_12 * (k - 1 - 1) + shared->dim_HIV_out_LL_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_LL_2; ++j) {
        int k = 1;
        internal.HIV_in_LL[i - 1 + shared->dim_HIV_in_LL_1 * (j - 1) + shared->dim_HIV_in_LL_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_R_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_R_2; ++j) {
        for (int k = 2; k <= shared->HIV_dims; ++k) {
          internal.HIV_in_R[i - 1 + shared->dim_HIV_in_R_1 * (j - 1) + shared->dim_HIV_in_R_12 * (k - 1)] = internal.HIV_out_R[shared->dim_HIV_out_R_12 * (k - 1 - 1) + shared->dim_HIV_out_R_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_R_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_R_2; ++j) {
        int k = 1;
        internal.HIV_in_R[i - 1 + shared->dim_HIV_in_R_1 * (j - 1) + shared->dim_HIV_in_R_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_U_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_U_2; ++j) {
        for (int k = 2; k <= shared->HIV_dims; ++k) {
          internal.HIV_in_U[i - 1 + shared->dim_HIV_in_U_1 * (j - 1) + shared->dim_HIV_in_U_12 * (k - 1)] = internal.HIV_out_U[shared->dim_HIV_out_U_12 * (k - 1 - 1) + shared->dim_HIV_out_U_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_HIV_in_U_1; ++i) {
      for (int j = 1; j <= shared->dim_HIV_in_U_2; ++j) {
        int k = 1;
        internal.HIV_in_U[i - 1 + shared->dim_HIV_in_U_1 * (j - 1) + shared->dim_HIV_in_U_12 * (k - 1)] = 0;
      }
    }
    for (int i = 1; i <= shared->dim_LLinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_LLinfs_2; ++j) {
        for (int k = 1; k <= shared->dim_LLinfs_3; ++k) {
          internal.LLinfs[i - 1 + shared->dim_LLinfs_1 * (j - 1) + shared->dim_LLinfs_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_LL[shared->dim_Nevents_LL_12 * (k - 1) + shared->dim_Nevents_LL_1 * (j - 1) + i - 1] - internal.age_out_LL[shared->dim_age_out_LL_12 * (k - 1) + shared->dim_age_out_LL_1 * (j - 1) + i - 1] - internal.HIV_out_LL[shared->dim_HIV_out_LL_12 * (k - 1) + shared->dim_HIV_out_LL_1 * (j - 1) + i - 1], internal.p_LLinfs[shared->dim_p_LLinfs_12 * (k - 1) + shared->dim_p_LLinfs_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_LR_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_LR_inmigr_2; ++j) {
        for (int k = 1; k <= shared->dim_LR_inmigr_3; ++k) {
          internal.LR_inmigr[i - 1 + shared->dim_LR_inmigr_1 * (j - 1) + shared->dim_LR_inmigr_12 * (k - 1)] = (internal.pLR_inmigr[shared->dim_pLR_inmigr_12 * (k - 1) + shared->dim_pLR_inmigr_1 * (j - 1) + i - 1] > 0 && internal.Nevents_LR[shared->dim_Nevents_LR_12 * (k - 1) + shared->dim_Nevents_LR_1 * (j - 1) + i - 1] - internal.age_out_LR[shared->dim_age_out_LR_12 * (k - 1) + shared->dim_age_out_LR_1 * (j - 1) + i - 1] - internal.HIV_out_LR[shared->dim_HIV_out_LR_12 * (k - 1) + shared->dim_HIV_out_LR_1 * (j - 1) + i - 1] - internal.progFast[shared->dim_progFast_12 * (k - 1) + shared->dim_progFast_1 * (j - 1) + i - 1] - internal.stabilisations[shared->dim_stabilisations_12 * (k - 1) + shared->dim_stabilisations_1 * (j - 1) + i - 1] > 0 ? dust::random::binomial<real_type>(rng_state, internal.Nevents_LR[shared->dim_Nevents_LR_12 * (k - 1) + shared->dim_Nevents_LR_1 * (j - 1) + i - 1] - internal.age_out_LR[shared->dim_age_out_LR_12 * (k - 1) + shared->dim_age_out_LR_1 * (j - 1) + i - 1] - internal.HIV_out_LR[shared->dim_HIV_out_LR_12 * (k - 1) + shared->dim_HIV_out_LR_1 * (j - 1) + i - 1] - internal.progFast[shared->dim_progFast_12 * (k - 1) + shared->dim_progFast_1 * (j - 1) + i - 1] - internal.stabilisations[shared->dim_stabilisations_12 * (k - 1) + shared->dim_stabilisations_1 * (j - 1) + i - 1], internal.pLR_inmigr[shared->dim_pLR_inmigr_12 * (k - 1) + shared->dim_pLR_inmigr_1 * (j - 1) + i - 1]) : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_progress_1; ++i) {
      for (int j = 1; j <= shared->dim_progress_2; ++j) {
        for (int k = 1; k <= shared->dim_progress_3; ++k) {
          internal.progress[i - 1 + shared->dim_progress_1 * (j - 1) + shared->dim_progress_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1] - internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1] - internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1] - internal.selfcure_SC[shared->dim_selfcure_SC_12 * (k - 1) + shared->dim_selfcure_SC_1 * (j - 1) + i - 1], internal.p_progress[shared->dim_p_progress_12 * (k - 1) + shared->dim_p_progress_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_regress_1; ++i) {
      for (int j = 1; j <= shared->dim_regress_2; ++j) {
        for (int k = 1; k <= shared->dim_regress_3; ++k) {
          internal.regress[i - 1 + shared->dim_regress_1 * (j - 1) + shared->dim_regress_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1] - internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1] - internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] - internal.selfcure[shared->dim_selfcure_12 * (k - 1) + shared->dim_selfcure_1 * (j - 1) + i - 1], internal.p_regress[shared->dim_p_regress_12 * (k - 1) + shared->dim_p_regress_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_Rinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_Rinfs_2; ++j) {
        for (int k = 1; k <= shared->dim_Rinfs_3; ++k) {
          internal.Rinfs[i - 1 + shared->dim_Rinfs_1 * (j - 1) + shared->dim_Rinfs_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_R[shared->dim_Nevents_R_12 * (k - 1) + shared->dim_Nevents_R_1 * (j - 1) + i - 1] - internal.age_out_R[shared->dim_age_out_R_12 * (k - 1) + shared->dim_age_out_R_1 * (j - 1) + i - 1] - internal.HIV_out_R[shared->dim_HIV_out_R_12 * (k - 1) + shared->dim_HIV_out_R_1 * (j - 1) + i - 1], internal.p_Rinfs[shared->dim_p_Rinfs_12 * (k - 1) + shared->dim_p_Rinfs_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_Tr_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_Tr_inmigr_2; ++j) {
        for (int k = 1; k <= shared->dim_Tr_inmigr_3; ++k) {
          internal.Tr_inmigr[i - 1 + shared->dim_Tr_inmigr_1 * (j - 1) + shared->dim_Tr_inmigr_12 * (k - 1)] = (internal.pTr_inmigr[shared->dim_pTr_inmigr_12 * (k - 1) + shared->dim_pTr_inmigr_1 * (j - 1) + i - 1] > 0 && internal.Nevents_Tr[shared->dim_Nevents_Tr_12 * (k - 1) + shared->dim_Nevents_Tr_1 * (j - 1) + i - 1] - internal.age_out_Tr[shared->dim_age_out_Tr_12 * (k - 1) + shared->dim_age_out_Tr_1 * (j - 1) + i - 1] - internal.HIV_out_Tr[shared->dim_HIV_out_Tr_12 * (k - 1) + shared->dim_HIV_out_Tr_1 * (j - 1) + i - 1] - internal.Trsuccess[shared->dim_Trsuccess_12 * (k - 1) + shared->dim_Trsuccess_1 * (j - 1) + i - 1] - internal.Trxdeaths[shared->dim_Trxdeaths_12 * (k - 1) + shared->dim_Trxdeaths_1 * (j - 1) + i - 1] > 0 ? dust::random::binomial<real_type>(rng_state, internal.Nevents_Tr[shared->dim_Nevents_Tr_12 * (k - 1) + shared->dim_Nevents_Tr_1 * (j - 1) + i - 1] - internal.age_out_Tr[shared->dim_age_out_Tr_12 * (k - 1) + shared->dim_age_out_Tr_1 * (j - 1) + i - 1] - internal.HIV_out_Tr[shared->dim_HIV_out_Tr_12 * (k - 1) + shared->dim_HIV_out_Tr_1 * (j - 1) + i - 1] - internal.Trsuccess[shared->dim_Trsuccess_12 * (k - 1) + shared->dim_Trsuccess_1 * (j - 1) + i - 1] - internal.Trxdeaths[shared->dim_Trxdeaths_12 * (k - 1) + shared->dim_Trxdeaths_1 * (j - 1) + i - 1], internal.pTr_inmigr[shared->dim_pTr_inmigr_12 * (k - 1) + shared->dim_pTr_inmigr_1 * (j - 1) + i - 1]) : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_Uinfs_1; ++i) {
      for (int j = 1; j <= shared->dim_Uinfs_2; ++j) {
        for (int k = 1; k <= shared->dim_Uinfs_3; ++k) {
          internal.Uinfs[i - 1 + shared->dim_Uinfs_1 * (j - 1) + shared->dim_Uinfs_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_U[shared->dim_Nevents_U_12 * (k - 1) + shared->dim_Nevents_U_1 * (j - 1) + i - 1] - internal.age_out_U[shared->dim_age_out_U_12 * (k - 1) + shared->dim_age_out_U_1 * (j - 1) + i - 1] - internal.HIV_out_U[shared->dim_HIV_out_U_12 * (k - 1) + shared->dim_HIV_out_U_1 * (j - 1) + i - 1], internal.p_Uinf[shared->dim_p_Uinf_12 * (k - 1) + shared->dim_p_Uinf_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_InfsByPatch; ++i) {
      internal.InfsByPatch[i - 1] = odin_sum3<real_type>(internal.Uinfs.data(), i - 1, i, 0, shared->dim_Uinfs_2, 0, shared->dim_Uinfs_3, shared->dim_Uinfs_1, shared->dim_Uinfs_12);
    }
    for (int i = 1; i <= shared->dim_LRdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_LRdeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_LRdeaths_3; ++k) {
          internal.LRdeaths[i - 1 + shared->dim_LRdeaths_1 * (j - 1) + shared->dim_LRdeaths_12 * (k - 1)] = internal.Nevents_LR[shared->dim_Nevents_LR_12 * (k - 1) + shared->dim_Nevents_LR_1 * (j - 1) + i - 1] - internal.age_out_LR[shared->dim_age_out_LR_12 * (k - 1) + shared->dim_age_out_LR_1 * (j - 1) + i - 1] - internal.HIV_out_LR[shared->dim_HIV_out_LR_12 * (k - 1) + shared->dim_HIV_out_LR_1 * (j - 1) + i - 1] - internal.progFast[shared->dim_progFast_12 * (k - 1) + shared->dim_progFast_1 * (j - 1) + i - 1] - internal.stabilisations[shared->dim_stabilisations_12 * (k - 1) + shared->dim_stabilisations_1 * (j - 1) + i - 1] - internal.LR_inmigr[shared->dim_LR_inmigr_12 * (k - 1) + shared->dim_LR_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_progSlow_1; ++i) {
      for (int j = 1; j <= shared->dim_progSlow_2; ++j) {
        for (int k = 1; k <= shared->dim_progSlow_3; ++k) {
          internal.progSlow[i - 1 + shared->dim_progSlow_1 * (j - 1) + shared->dim_progSlow_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_LL[shared->dim_Nevents_LL_12 * (k - 1) + shared->dim_Nevents_LL_1 * (j - 1) + i - 1] - internal.age_out_LL[shared->dim_age_out_LL_12 * (k - 1) + shared->dim_age_out_LL_1 * (j - 1) + i - 1] - internal.HIV_out_LL[shared->dim_HIV_out_LL_12 * (k - 1) + shared->dim_HIV_out_LL_1 * (j - 1) + i - 1] - internal.LLinfs[shared->dim_LLinfs_12 * (k - 1) + shared->dim_LLinfs_1 * (j - 1) + i - 1], internal.p_progSlow[shared->dim_p_progSlow_12 * (k - 1) + shared->dim_p_progSlow_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_relapse_1; ++i) {
      for (int j = 1; j <= shared->dim_relapse_2; ++j) {
        for (int k = 1; k <= shared->dim_relapse_3; ++k) {
          internal.relapse[i - 1 + shared->dim_relapse_1 * (j - 1) + shared->dim_relapse_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_R[shared->dim_Nevents_R_12 * (k - 1) + shared->dim_Nevents_R_1 * (j - 1) + i - 1] - internal.age_out_R[shared->dim_age_out_R_12 * (k - 1) + shared->dim_age_out_R_1 * (j - 1) + i - 1] - internal.HIV_out_R[shared->dim_HIV_out_R_12 * (k - 1) + shared->dim_HIV_out_R_1 * (j - 1) + i - 1] - internal.Rinfs[shared->dim_Rinfs_12 * (k - 1) + shared->dim_Rinfs_1 * (j - 1) + i - 1], internal.p_relapse[shared->dim_p_relapse_12 * (k - 1) + shared->dim_p_relapse_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_TBdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_TBdeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_TBdeaths_3; ++k) {
          internal.TBdeaths[i - 1 + shared->dim_TBdeaths_1 * (j - 1) + shared->dim_TBdeaths_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1] - internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1] - internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] - internal.selfcure[shared->dim_selfcure_12 * (k - 1) + shared->dim_selfcure_1 * (j - 1) + i - 1] - internal.regress[shared->dim_regress_12 * (k - 1) + shared->dim_regress_1 * (j - 1) + i - 1], internal.p_TBdeaths[shared->dim_p_TBdeaths_12 * (k - 1) + shared->dim_p_TBdeaths_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_TBdeaths_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_TBdeaths_SC_2; ++j) {
        for (int k = 1; k <= shared->dim_TBdeaths_SC_3; ++k) {
          internal.TBdeaths_SC[i - 1 + shared->dim_TBdeaths_SC_1 * (j - 1) + shared->dim_TBdeaths_SC_12 * (k - 1)] = dust::random::binomial<real_type>(rng_state, internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1] - internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1] - internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1] - internal.selfcure_SC[shared->dim_selfcure_SC_12 * (k - 1) + shared->dim_selfcure_SC_1 * (j - 1) + i - 1] - internal.progress[shared->dim_progress_12 * (k - 1) + shared->dim_progress_1 * (j - 1) + i - 1], internal.p_TBdeaths_SC[shared->dim_p_TBdeaths_SC_12 * (k - 1) + shared->dim_p_TBdeaths_SC_1 * (j - 1) + i - 1]);
        }
      }
    }
    for (int i = 1; i <= shared->dim_Trdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_Trdeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_Trdeaths_3; ++k) {
          internal.Trdeaths[i - 1 + shared->dim_Trdeaths_1 * (j - 1) + shared->dim_Trdeaths_12 * (k - 1)] = internal.Nevents_Tr[shared->dim_Nevents_Tr_12 * (k - 1) + shared->dim_Nevents_Tr_1 * (j - 1) + i - 1] - internal.age_out_Tr[shared->dim_age_out_Tr_12 * (k - 1) + shared->dim_age_out_Tr_1 * (j - 1) + i - 1] - internal.HIV_out_Tr[shared->dim_HIV_out_Tr_12 * (k - 1) + shared->dim_HIV_out_Tr_1 * (j - 1) + i - 1] - internal.Trsuccess[shared->dim_Trsuccess_12 * (k - 1) + shared->dim_Trsuccess_1 * (j - 1) + i - 1] - internal.Trxdeaths[shared->dim_Trxdeaths_12 * (k - 1) + shared->dim_Trxdeaths_1 * (j - 1) + i - 1] - internal.Tr_inmigr[shared->dim_Tr_inmigr_12 * (k - 1) + shared->dim_Tr_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_U_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_U_inmigr_2; ++j) {
        for (int k = 1; k <= shared->dim_U_inmigr_3; ++k) {
          internal.U_inmigr[i - 1 + shared->dim_U_inmigr_1 * (j - 1) + shared->dim_U_inmigr_12 * (k - 1)] = (internal.pU_inmigr[shared->dim_pU_inmigr_12 * (k - 1) + shared->dim_pU_inmigr_1 * (j - 1) + i - 1] > 0 && internal.Nevents_U[shared->dim_Nevents_U_12 * (k - 1) + shared->dim_Nevents_U_1 * (j - 1) + i - 1] - internal.age_out_U[shared->dim_age_out_U_12 * (k - 1) + shared->dim_age_out_U_1 * (j - 1) + i - 1] - internal.HIV_out_U[shared->dim_HIV_out_U_12 * (k - 1) + shared->dim_HIV_out_U_1 * (j - 1) + i - 1] - internal.Uinfs[shared->dim_Uinfs_12 * (k - 1) + shared->dim_Uinfs_1 * (j - 1) + i - 1] > 0 ? dust::random::binomial<real_type>(rng_state, internal.Nevents_U[shared->dim_Nevents_U_12 * (k - 1) + shared->dim_Nevents_U_1 * (j - 1) + i - 1] - internal.age_out_U[shared->dim_age_out_U_12 * (k - 1) + shared->dim_age_out_U_1 * (j - 1) + i - 1] - internal.HIV_out_U[shared->dim_HIV_out_U_12 * (k - 1) + shared->dim_HIV_out_U_1 * (j - 1) + i - 1] - internal.Uinfs[shared->dim_Uinfs_12 * (k - 1) + shared->dim_Uinfs_1 * (j - 1) + i - 1], internal.pU_inmigr[shared->dim_pU_inmigr_12 * (k - 1) + shared->dim_pU_inmigr_1 * (j - 1) + i - 1]) : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_D_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_D_inmigr_2; ++j) {
        for (int k = 1; k <= shared->dim_D_inmigr_3; ++k) {
          internal.D_inmigr[i - 1 + shared->dim_D_inmigr_1 * (j - 1) + shared->dim_D_inmigr_12 * (k - 1)] = (internal.pD_inmigr[shared->dim_pD_inmigr_12 * (k - 1) + shared->dim_pD_inmigr_1 * (j - 1) + i - 1] > 0 && internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1] - internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1] - internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] - internal.selfcure[shared->dim_selfcure_12 * (k - 1) + shared->dim_selfcure_1 * (j - 1) + i - 1] - internal.regress[shared->dim_regress_12 * (k - 1) + shared->dim_regress_1 * (j - 1) + i - 1] - internal.TBdeaths[shared->dim_TBdeaths_12 * (k - 1) + shared->dim_TBdeaths_1 * (j - 1) + i - 1] > 0 ? dust::random::binomial<real_type>(rng_state, internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1] - internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1] - internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] - internal.selfcure[shared->dim_selfcure_12 * (k - 1) + shared->dim_selfcure_1 * (j - 1) + i - 1] - internal.regress[shared->dim_regress_12 * (k - 1) + shared->dim_regress_1 * (j - 1) + i - 1] - internal.TBdeaths[shared->dim_TBdeaths_12 * (k - 1) + shared->dim_TBdeaths_1 * (j - 1) + i - 1], internal.pD_inmigr[shared->dim_pD_inmigr_12 * (k - 1) + shared->dim_pD_inmigr_1 * (j - 1) + i - 1]) : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_InfsByPatchPatch_1; ++i) {
      for (int j = 1; j <= shared->dim_InfsByPatchPatch_2; ++j) {
        internal.InfsByPatchPatch[i - 1 + shared->dim_InfsByPatchPatch_1 * (j - 1)] = dust::random::binomial<real_type>(rng_state, internal.InfsByPatch[i - 1], internal.foitemp[shared->dim_foitemp_1 * (j - 1) + i - 1] / (real_type) (internal.foi[i - 1] + shared->tol));
      }
    }
    for (int i = 1; i <= shared->dim_LL_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_LL_inmigr_2; ++j) {
        for (int k = 1; k <= shared->dim_LL_inmigr_3; ++k) {
          internal.LL_inmigr[i - 1 + shared->dim_LL_inmigr_1 * (j - 1) + shared->dim_LL_inmigr_12 * (k - 1)] = (internal.pLL_inmigr[shared->dim_pLL_inmigr_12 * (k - 1) + shared->dim_pLL_inmigr_1 * (j - 1) + i - 1] > 0 && internal.Nevents_LL[shared->dim_Nevents_LL_12 * (k - 1) + shared->dim_Nevents_LL_1 * (j - 1) + i - 1] - internal.age_out_LL[shared->dim_age_out_LL_12 * (k - 1) + shared->dim_age_out_LL_1 * (j - 1) + i - 1] - internal.HIV_out_LL[shared->dim_HIV_out_LL_12 * (k - 1) + shared->dim_HIV_out_LL_1 * (j - 1) + i - 1] - internal.LLinfs[shared->dim_LLinfs_12 * (k - 1) + shared->dim_LLinfs_1 * (j - 1) + i - 1] - internal.progSlow[shared->dim_progSlow_12 * (k - 1) + shared->dim_progSlow_1 * (i - 1) + i - 1] > 0 ? dust::random::binomial<real_type>(rng_state, internal.Nevents_LL[shared->dim_Nevents_LL_12 * (k - 1) + shared->dim_Nevents_LL_1 * (j - 1) + i - 1] - internal.age_out_LL[shared->dim_age_out_LL_12 * (k - 1) + shared->dim_age_out_LL_1 * (j - 1) + i - 1] - internal.HIV_out_LL[shared->dim_HIV_out_LL_12 * (k - 1) + shared->dim_HIV_out_LL_1 * (j - 1) + i - 1] - internal.LLinfs[shared->dim_LLinfs_12 * (k - 1) + shared->dim_LLinfs_1 * (j - 1) + i - 1] - internal.progSlow[shared->dim_progSlow_12 * (k - 1) + shared->dim_progSlow_1 * (i - 1) + i - 1], internal.pLL_inmigr[shared->dim_pLL_inmigr_12 * (k - 1) + shared->dim_pLL_inmigr_1 * (j - 1) + i - 1]) : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_R_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_R_inmigr_2; ++j) {
        for (int k = 1; k <= shared->dim_R_inmigr_3; ++k) {
          internal.R_inmigr[i - 1 + shared->dim_R_inmigr_1 * (j - 1) + shared->dim_R_inmigr_12 * (k - 1)] = (internal.pR_inmigr[shared->dim_pR_inmigr_12 * (k - 1) + shared->dim_pR_inmigr_1 * (j - 1) + i - 1] > 0 && internal.Nevents_R[shared->dim_Nevents_R_12 * (k - 1) + shared->dim_Nevents_R_1 * (j - 1) + i - 1] - internal.age_out_R[shared->dim_age_out_R_12 * (k - 1) + shared->dim_age_out_R_1 * (j - 1) + i - 1] - internal.HIV_out_R[shared->dim_HIV_out_R_12 * (k - 1) + shared->dim_HIV_out_R_1 * (j - 1) + i - 1] - internal.Rinfs[shared->dim_Rinfs_12 * (k - 1) + shared->dim_Rinfs_1 * (j - 1) + i - 1] - internal.relapse[shared->dim_relapse_12 * (k - 1) + shared->dim_relapse_1 * (j - 1) + i - 1] > 0 ? dust::random::binomial<real_type>(rng_state, internal.Nevents_R[shared->dim_Nevents_R_12 * (k - 1) + shared->dim_Nevents_R_1 * (j - 1) + i - 1] - internal.age_out_R[shared->dim_age_out_R_12 * (k - 1) + shared->dim_age_out_R_1 * (j - 1) + i - 1] - internal.HIV_out_R[shared->dim_HIV_out_R_12 * (k - 1) + shared->dim_HIV_out_R_1 * (j - 1) + i - 1] - internal.Rinfs[shared->dim_Rinfs_12 * (k - 1) + shared->dim_Rinfs_1 * (j - 1) + i - 1] - internal.relapse[shared->dim_relapse_12 * (k - 1) + shared->dim_relapse_1 * (j - 1) + i - 1], internal.pR_inmigr[shared->dim_pR_inmigr_12 * (k - 1) + shared->dim_pR_inmigr_1 * (j - 1) + i - 1]) : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_SC_inmigr_1; ++i) {
      for (int j = 1; j <= shared->dim_SC_inmigr_2; ++j) {
        for (int k = 1; k <= shared->dim_SC_inmigr_3; ++k) {
          internal.SC_inmigr[i - 1 + shared->dim_SC_inmigr_1 * (j - 1) + shared->dim_SC_inmigr_12 * (k - 1)] = (internal.pSC_inmigr[shared->dim_pSC_inmigr_12 * (k - 1) + shared->dim_pSC_inmigr_1 * (j - 1) + i - 1] > 0 && internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1] - internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1] - internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1] - internal.selfcure_SC[shared->dim_selfcure_SC_12 * (k - 1) + shared->dim_selfcure_SC_1 * (j - 1) + i - 1] - internal.progress[shared->dim_progress_12 * (k - 1) + shared->dim_progress_1 * (j - 1) + i - 1] - internal.TBdeaths_SC[shared->dim_TBdeaths_SC_12 * (k - 1) + shared->dim_TBdeaths_SC_1 * (j - 1) + i - 1] > 0 ? dust::random::binomial<real_type>(rng_state, internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1] - internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1] - internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1] - internal.selfcure_SC[shared->dim_selfcure_SC_12 * (k - 1) + shared->dim_selfcure_SC_1 * (j - 1) + i - 1] - internal.progress[shared->dim_progress_12 * (k - 1) + shared->dim_progress_1 * (j - 1) + i - 1] - internal.TBdeaths_SC[shared->dim_TBdeaths_SC_12 * (k - 1) + shared->dim_TBdeaths_SC_1 * (j - 1) + i - 1], internal.pSC_inmigr[shared->dim_pSC_inmigr_12 * (k - 1) + shared->dim_pSC_inmigr_1 * (j - 1) + i - 1]) : 0);
        }
      }
    }
    for (int i = 1; i <= shared->dim_Udeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_Udeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_Udeaths_3; ++k) {
          internal.Udeaths[i - 1 + shared->dim_Udeaths_1 * (j - 1) + shared->dim_Udeaths_12 * (k - 1)] = internal.Nevents_U[shared->dim_Nevents_U_12 * (k - 1) + shared->dim_Nevents_U_1 * (j - 1) + i - 1] - internal.age_out_U[shared->dim_age_out_U_12 * (k - 1) + shared->dim_age_out_U_1 * (j - 1) + i - 1] - internal.HIV_out_U[shared->dim_HIV_out_U_12 * (k - 1) + shared->dim_HIV_out_U_1 * (j - 1) + i - 1] - internal.Uinfs[shared->dim_Uinfs_12 * (k - 1) + shared->dim_Uinfs_1 * (j - 1) + i - 1] - internal.U_inmigr[shared->dim_U_inmigr_12 * (k - 1) + shared->dim_U_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_incidence_1; ++i) {
      for (int j = 1; j <= shared->dim_incidence_2; ++j) {
        for (int k = 1; k <= shared->dim_incidence_3; ++k) {
          state_next[shared->offset_variable_incidence + i - 1 + shared->dim_incidence_1 * (j - 1) + shared->dim_incidence_12 * (k - 1)] = internal.progFast[shared->dim_progFast_12 * (k - 1) + shared->dim_progFast_1 * (j - 1) + i - 1] + internal.progSlow[shared->dim_progSlow_12 * (k - 1) + shared->dim_progSlow_1 * (j - 1) + i - 1] + internal.relapse[shared->dim_relapse_12 * (k - 1) + shared->dim_relapse_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_LR_1; ++i) {
      for (int j = 1; j <= shared->dim_LR_2; ++j) {
        for (int k = 1; k <= shared->dim_LR_3; ++k) {
          state_next[shared->offset_variable_LR + i - 1 + shared->dim_LR_1 * (j - 1) + shared->dim_LR_12 * (k - 1)] = LR[shared->dim_LR_12 * (k - 1) + shared->dim_LR_1 * (j - 1) + i - 1] + internal.age_in_LR[shared->dim_age_in_LR_12 * (k - 1) + shared->dim_age_in_LR_1 * (j - 1) + i - 1] + internal.HIV_in_LR[shared->dim_HIV_in_LR_12 * (k - 1) + shared->dim_HIV_in_LR_1 * (j - 1) + i - 1] + internal.Uinfs[shared->dim_Uinfs_12 * (k - 1) + shared->dim_Uinfs_1 * (j - 1) + i - 1] + internal.LLinfs[shared->dim_LLinfs_12 * (k - 1) + shared->dim_LLinfs_1 * (j - 1) + i - 1] + internal.Rinfs[shared->dim_Rinfs_12 * (k - 1) + shared->dim_Rinfs_1 * (j - 1) + i - 1] + internal.LR_inmigr[shared->dim_LR_inmigr_12 * (k - 1) + shared->dim_LR_inmigr_1 * (j - 1) + i - 1] - internal.age_out_LR[shared->dim_age_out_LR_12 * (k - 1) + shared->dim_age_out_LR_1 * (j - 1) + i - 1] - internal.HIV_out_LR[shared->dim_HIV_out_LR_12 * (k - 1) + shared->dim_HIV_out_LR_1 * (j - 1) + i - 1] - internal.LRdeaths[shared->dim_LRdeaths_12 * (k - 1) + shared->dim_LRdeaths_1 * (j - 1) + i - 1] - internal.progFast[shared->dim_progFast_12 * (k - 1) + shared->dim_progFast_1 * (j - 1) + i - 1] - internal.stabilisations[shared->dim_stabilisations_12 * (k - 1) + shared->dim_stabilisations_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_TB_deaths_1; ++i) {
      for (int j = 1; j <= shared->dim_TB_deaths_2; ++j) {
        for (int k = 1; k <= shared->dim_TB_deaths_3; ++k) {
          state_next[shared->offset_variable_TB_deaths + i - 1 + shared->dim_TB_deaths_1 * (j - 1) + shared->dim_TB_deaths_12 * (k - 1)] = internal.Trxdeaths[shared->dim_Trxdeaths_12 * (k - 1) + shared->dim_Trxdeaths_1 * (j - 1) + i - 1] + internal.TBdeaths[shared->dim_TBdeaths_12 * (k - 1) + shared->dim_TBdeaths_1 * (j - 1) + i - 1] + internal.TBdeaths_SC[shared->dim_TBdeaths_SC_12 * (k - 1) + shared->dim_TBdeaths_SC_1 * (j - 1) + i - 1];
        }
      }
    }
    state_next[0] = odin_sum3<real_type>(internal.progFast.data(), 0, shared->dim_progFast_1, 0, shared->dim_progFast_2, 0, shared->dim_progFast_3, shared->dim_progFast_1, shared->dim_progFast_12) + odin_sum3<real_type>(internal.progSlow.data(), 0, shared->dim_progSlow_1, 0, shared->dim_progSlow_2, 0, shared->dim_progSlow_3, shared->dim_progSlow_1, shared->dim_progSlow_12) + odin_sum3<real_type>(internal.relapse.data(), 0, shared->dim_relapse_1, 0, shared->dim_relapse_2, 0, shared->dim_relapse_3, shared->dim_relapse_1, shared->dim_relapse_12);
    for (int i = 1; i <= shared->dim_Tr_1; ++i) {
      for (int j = 1; j <= shared->dim_Tr_2; ++j) {
        for (int k = 1; k <= shared->dim_Tr_3; ++k) {
          state_next[shared->offset_variable_Tr + i - 1 + shared->dim_Tr_1 * (j - 1) + shared->dim_Tr_12 * (k - 1)] = Tr[shared->dim_Tr_12 * (k - 1) + shared->dim_Tr_1 * (j - 1) + i - 1] + internal.age_in_Tr[shared->dim_age_in_Tr_12 * (k - 1) + shared->dim_age_in_Tr_1 * (j - 1) + i - 1] + internal.HIV_in_Tr[shared->dim_HIV_in_Tr_12 * (k - 1) + shared->dim_HIV_in_Tr_1 * (j - 1) + i - 1] + internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] + internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1] + internal.Tr_inmigr[shared->dim_Tr_inmigr_12 * (k - 1) + shared->dim_Tr_inmigr_1 * (j - 1) + i - 1] - internal.age_out_Tr[shared->dim_age_out_Tr_12 * (k - 1) + shared->dim_age_out_Tr_1 * (j - 1) + i - 1] - internal.HIV_out_Tr[shared->dim_HIV_out_Tr_12 * (k - 1) + shared->dim_HIV_out_Tr_1 * (j - 1) + i - 1] - internal.Trdeaths[shared->dim_Trdeaths_12 * (k - 1) + shared->dim_Trdeaths_1 * (j - 1) + i - 1] - internal.Trsuccess[shared->dim_Trsuccess_12 * (k - 1) + shared->dim_Trsuccess_1 * (j - 1) + i - 1] - internal.Trxdeaths[shared->dim_Trxdeaths_12 * (k - 1) + shared->dim_Trxdeaths_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_Ddeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_Ddeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_Ddeaths_3; ++k) {
          internal.Ddeaths[i - 1 + shared->dim_Ddeaths_1 * (j - 1) + shared->dim_Ddeaths_12 * (k - 1)] = internal.Nevents_D[shared->dim_Nevents_D_12 * (k - 1) + shared->dim_Nevents_D_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1] - internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1] - internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] - internal.selfcure[shared->dim_selfcure_12 * (k - 1) + shared->dim_selfcure_1 * (j - 1) + i - 1] - internal.regress[shared->dim_regress_12 * (k - 1) + shared->dim_regress_1 * (j - 1) + i - 1] - internal.TBdeaths[shared->dim_TBdeaths_12 * (k - 1) + shared->dim_TBdeaths_1 * (j - 1) + i - 1] - internal.D_inmigr[shared->dim_D_inmigr_12 * (k - 1) + shared->dim_D_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_LLdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_LLdeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_LLdeaths_3; ++k) {
          internal.LLdeaths[i - 1 + shared->dim_LLdeaths_1 * (j - 1) + shared->dim_LLdeaths_12 * (k - 1)] = internal.Nevents_LL[shared->dim_Nevents_LL_12 * (k - 1) + shared->dim_Nevents_LL_1 * (j - 1) + i - 1] - internal.age_out_LL[shared->dim_age_out_LL_12 * (k - 1) + shared->dim_age_out_LL_1 * (j - 1) + i - 1] - internal.HIV_out_LL[shared->dim_HIV_out_LL_12 * (k - 1) + shared->dim_HIV_out_LL_1 * (j - 1) + i - 1] - internal.LLinfs[shared->dim_LLinfs_12 * (k - 1) + shared->dim_LLinfs_1 * (j - 1) + i - 1] - internal.progSlow[shared->dim_progSlow_12 * (k - 1) + shared->dim_progSlow_1 * (j - 1) + i - 1] - internal.LL_inmigr[shared->dim_LL_inmigr_12 * (k - 1) + shared->dim_LL_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_Rdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_Rdeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_Rdeaths_3; ++k) {
          internal.Rdeaths[i - 1 + shared->dim_Rdeaths_1 * (j - 1) + shared->dim_Rdeaths_12 * (k - 1)] = internal.Nevents_R[shared->dim_Nevents_R_12 * (k - 1) + shared->dim_Nevents_R_1 * (j - 1) + i - 1] - internal.age_out_R[shared->dim_age_out_R_12 * (k - 1) + shared->dim_age_out_R_1 * (j - 1) + i - 1] - internal.HIV_out_R[shared->dim_HIV_out_R_12 * (k - 1) + shared->dim_HIV_out_R_1 * (j - 1) + i - 1] - internal.Rinfs[shared->dim_Rinfs_12 * (k - 1) + shared->dim_Rinfs_1 * (j - 1) + i - 1] - internal.relapse[shared->dim_relapse_12 * (k - 1) + shared->dim_relapse_1 * (j - 1) + i - 1] - internal.R_inmigr[shared->dim_R_inmigr_12 * (k - 1) + shared->dim_R_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_SCdeaths_1; ++i) {
      for (int j = 1; j <= shared->dim_SCdeaths_2; ++j) {
        for (int k = 1; k <= shared->dim_SCdeaths_3; ++k) {
          internal.SCdeaths[i - 1 + shared->dim_SCdeaths_1 * (j - 1) + shared->dim_SCdeaths_12 * (k - 1)] = internal.Nevents_SC[shared->dim_Nevents_SC_12 * (k - 1) + shared->dim_Nevents_SC_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1] - internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1] - internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1] - internal.selfcure_SC[shared->dim_selfcure_SC_12 * (k - 1) + shared->dim_selfcure_SC_1 * (j - 1) + i - 1] - internal.progress[shared->dim_progress_12 * (k - 1) + shared->dim_progress_1 * (j - 1) + i - 1] - internal.TBdeaths_SC[shared->dim_TBdeaths_SC_12 * (k - 1) + shared->dim_TBdeaths_SC_1 * (j - 1) + i - 1] - internal.SC_inmigr[shared->dim_SC_inmigr_12 * (k - 1) + shared->dim_SC_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_cum_inf_flux_1; ++i) {
      for (int j = 1; j <= shared->dim_cum_inf_flux_2; ++j) {
        state_next[2 + i - 1 + shared->dim_cum_inf_flux_1 * (j - 1)] = cum_inf_flux[shared->dim_cum_inf_flux_1 * (j - 1) + i - 1] + internal.InfsByPatchPatch[shared->dim_InfsByPatchPatch_1 * (j - 1) + i - 1];
      }
    }
    for (int i = 1; i <= shared->dim_Tijk_1; ++i) {
      for (int j = 1; j <= shared->dim_Tijk_2; ++j) {
        for (int k = 1; k <= shared->dim_Tijk_3; ++k) {
          state_next[shared->offset_variable_Tijk + i - 1 + shared->dim_Tijk_1 * (j - 1) + shared->dim_Tijk_12 * (k - 1)] = dust::math::exp(- shared->zk[k - 1]) * Tijk[shared->dim_Tijk_12 * (k - 1) + shared->dim_Tijk_1 * (j - 1) + i - 1] + internal.InfsByPatchPatch[shared->dim_InfsByPatchPatch_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_U_1; ++i) {
      for (int j = 1; j <= shared->dim_U_2; ++j) {
        for (int k = 1; k <= shared->dim_U_3; ++k) {
          state_next[shared->offset_variable_U + i - 1 + shared->dim_U_1 * (j - 1) + shared->dim_U_12 * (k - 1)] = U[shared->dim_U_12 * (k - 1) + shared->dim_U_1 * (j - 1) + i - 1] + internal.births[shared->dim_births_12 * (k - 1) + shared->dim_births_1 * (j - 1) + i - 1] + internal.age_in_U[shared->dim_age_in_U_12 * (k - 1) + shared->dim_age_in_U_1 * (j - 1) + i - 1] + internal.HIV_in_U[shared->dim_HIV_in_U_12 * (k - 1) + shared->dim_HIV_in_U_1 * (j - 1) + i - 1] - internal.age_out_U[shared->dim_age_out_U_12 * (k - 1) + shared->dim_age_out_U_1 * (j - 1) + i - 1] - internal.HIV_out_U[shared->dim_HIV_out_U_12 * (k - 1) + shared->dim_HIV_out_U_1 * (j - 1) + i - 1] - internal.Udeaths[shared->dim_Udeaths_12 * (k - 1) + shared->dim_Udeaths_1 * (j - 1) + i - 1] - internal.Uinfs[shared->dim_Uinfs_12 * (k - 1) + shared->dim_Uinfs_1 * (j - 1) + i - 1] + internal.U_inmigr[shared->dim_U_inmigr_12 * (k - 1) + shared->dim_U_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_bg_deaths_1; ++i) {
      for (int j = 1; j <= shared->dim_bg_deaths_2; ++j) {
        for (int k = 1; k <= shared->dim_bg_deaths_3; ++k) {
          state_next[shared->offset_variable_bg_deaths + i - 1 + shared->dim_bg_deaths_1 * (j - 1) + shared->dim_bg_deaths_12 * (k - 1)] = internal.Udeaths[shared->dim_Udeaths_12 * (k - 1) + shared->dim_Udeaths_1 * (j - 1) + i - 1] + internal.LRdeaths[shared->dim_LRdeaths_12 * (k - 1) + shared->dim_LRdeaths_1 * (j - 1) + i - 1] + internal.LLdeaths[shared->dim_LLdeaths_12 * (k - 1) + shared->dim_LLdeaths_1 * (j - 1) + i - 1] + internal.Ddeaths[shared->dim_Ddeaths_12 * (k - 1) + shared->dim_Ddeaths_1 * (j - 1) + i - 1] + internal.SCdeaths[shared->dim_SCdeaths_12 * (k - 1) + shared->dim_SCdeaths_1 * (j - 1) + i - 1] + internal.Trdeaths[shared->dim_Trdeaths_12 * (k - 1) + shared->dim_Trdeaths_1 * (j - 1) + i - 1] + internal.Rdeaths[shared->dim_Rdeaths_12 * (k - 1) + shared->dim_Rdeaths_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_D_1; ++i) {
      for (int j = 1; j <= shared->dim_D_2; ++j) {
        for (int k = 1; k <= shared->dim_D_3; ++k) {
          state_next[shared->offset_variable_D + i - 1 + shared->dim_D_1 * (j - 1) + shared->dim_D_12 * (k - 1)] = D[shared->dim_D_12 * (k - 1) + shared->dim_D_1 * (j - 1) + i - 1] + internal.age_in_D[shared->dim_age_in_D_12 * (k - 1) + shared->dim_age_in_D_1 * (j - 1) + i - 1] + internal.HIV_in_D[shared->dim_HIV_in_D_12 * (k - 1) + shared->dim_HIV_in_D_1 * (j - 1) + i - 1] + internal.progress[shared->dim_progress_12 * (k - 1) + shared->dim_progress_1 * (j - 1) + i - 1] + internal.D_inmigr[shared->dim_D_inmigr_12 * (k - 1) + shared->dim_D_inmigr_1 * (j - 1) + i - 1] - internal.age_out_D[shared->dim_age_out_D_12 * (k - 1) + shared->dim_age_out_D_1 * (j - 1) + i - 1] - internal.HIV_out_D[shared->dim_HIV_out_D_12 * (k - 1) + shared->dim_HIV_out_D_1 * (j - 1) + i - 1] - internal.Ddeaths[shared->dim_Ddeaths_12 * (k - 1) + shared->dim_Ddeaths_1 * (j - 1) + i - 1] - internal.TBdeaths[shared->dim_TBdeaths_12 * (k - 1) + shared->dim_TBdeaths_1 * (j - 1) + i - 1] - internal.detection[shared->dim_detection_12 * (k - 1) + shared->dim_detection_1 * (j - 1) + i - 1] - internal.selfcure[shared->dim_selfcure_12 * (k - 1) + shared->dim_selfcure_1 * (j - 1) + i - 1] - internal.regress[shared->dim_regress_12 * (k - 1) + shared->dim_regress_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_LL_1; ++i) {
      for (int j = 1; j <= shared->dim_LL_2; ++j) {
        for (int k = 1; k <= shared->dim_LL_3; ++k) {
          state_next[shared->offset_variable_LL + i - 1 + shared->dim_LL_1 * (j - 1) + shared->dim_LL_12 * (k - 1)] = LL[shared->dim_LL_12 * (k - 1) + shared->dim_LL_1 * (j - 1) + i - 1] + internal.age_in_LL[shared->dim_age_in_LL_12 * (k - 1) + shared->dim_age_in_LL_1 * (j - 1) + i - 1] + internal.HIV_in_LL[shared->dim_HIV_in_LL_12 * (k - 1) + shared->dim_HIV_in_LL_1 * (j - 1) + i - 1] + internal.stabilisations[shared->dim_stabilisations_12 * (k - 1) + shared->dim_stabilisations_1 * (j - 1) + i - 1] + internal.selfcure[shared->dim_selfcure_12 * (k - 1) + shared->dim_selfcure_1 * (j - 1) + i - 1] + internal.selfcure_SC[shared->dim_selfcure_SC_12 * (k - 1) + shared->dim_selfcure_SC_1 * (j - 1) + i - 1] - internal.age_out_LL[shared->dim_age_out_LL_12 * (k - 1) + shared->dim_age_out_LL_1 * (j - 1) + i - 1] - internal.HIV_out_LL[shared->dim_HIV_out_LL_12 * (k - 1) + shared->dim_HIV_out_LL_1 * (j - 1) + i - 1] - internal.LLdeaths[shared->dim_LLdeaths_12 * (k - 1) + shared->dim_LLdeaths_1 * (j - 1) + i - 1] - internal.LLinfs[shared->dim_LLinfs_12 * (k - 1) + shared->dim_LLinfs_1 * (j - 1) + i - 1] - internal.progSlow[shared->dim_progSlow_12 * (k - 1) + shared->dim_progSlow_1 * (j - 1) + i - 1] + internal.LL_inmigr[shared->dim_LL_inmigr_12 * (k - 1) + shared->dim_LL_inmigr_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_R_1; ++i) {
      for (int j = 1; j <= shared->dim_R_2; ++j) {
        for (int k = 1; k <= shared->dim_R_3; ++k) {
          state_next[shared->offset_variable_R + i - 1 + shared->dim_R_1 * (j - 1) + shared->dim_R_12 * (k - 1)] = R[shared->dim_R_12 * (k - 1) + shared->dim_R_1 * (j - 1) + i - 1] + internal.age_in_R[shared->dim_age_in_R_12 * (k - 1) + shared->dim_age_in_R_1 * (j - 1) + i - 1] + internal.HIV_in_R[shared->dim_HIV_in_R_12 * (k - 1) + shared->dim_HIV_in_R_1 * (j - 1) + i - 1] + internal.Trsuccess[shared->dim_Trsuccess_12 * (k - 1) + shared->dim_Trsuccess_1 * (j - 1) + i - 1] + internal.R_inmigr[shared->dim_R_inmigr_12 * (k - 1) + shared->dim_R_inmigr_1 * (j - 1) + i - 1] - internal.age_out_R[shared->dim_age_out_R_12 * (k - 1) + shared->dim_age_out_R_1 * (j - 1) + i - 1] - internal.HIV_out_R[shared->dim_HIV_out_R_12 * (k - 1) + shared->dim_HIV_out_R_1 * (j - 1) + i - 1] - internal.Rdeaths[shared->dim_Rdeaths_12 * (k - 1) + shared->dim_Rdeaths_1 * (j - 1) + i - 1] - internal.Rinfs[shared->dim_Rinfs_12 * (k - 1) + shared->dim_Rinfs_1 * (j - 1) + i - 1] - internal.relapse[shared->dim_relapse_12 * (k - 1) + shared->dim_relapse_1 * (j - 1) + i - 1];
        }
      }
    }
    for (int i = 1; i <= shared->dim_SC_1; ++i) {
      for (int j = 1; j <= shared->dim_SC_2; ++j) {
        for (int k = 1; k <= shared->dim_SC_3; ++k) {
          state_next[shared->offset_variable_SC + i - 1 + shared->dim_SC_1 * (j - 1) + shared->dim_SC_12 * (k - 1)] = SC[shared->dim_SC_12 * (k - 1) + shared->dim_SC_1 * (j - 1) + i - 1] + internal.age_in_SC[shared->dim_age_in_SC_12 * (k - 1) + shared->dim_age_in_SC_1 * (j - 1) + i - 1] + internal.HIV_in_SC[shared->dim_HIV_in_SC_12 * (k - 1) + shared->dim_HIV_in_SC_1 * (j - 1) + i - 1] + internal.progFast[shared->dim_progFast_12 * (k - 1) + shared->dim_progFast_1 * (j - 1) + i - 1] + internal.progSlow[shared->dim_progSlow_12 * (k - 1) + shared->dim_progSlow_1 * (j - 1) + i - 1] + internal.relapse[shared->dim_relapse_12 * (k - 1) + shared->dim_relapse_1 * (j - 1) + i - 1] + internal.regress[shared->dim_regress_12 * (k - 1) + shared->dim_regress_1 * (j - 1) + i - 1] + internal.SC_inmigr[shared->dim_SC_inmigr_12 * (k - 1) + shared->dim_SC_inmigr_1 * (j - 1) + i - 1] - internal.age_out_SC[shared->dim_age_out_SC_12 * (k - 1) + shared->dim_age_out_SC_1 * (j - 1) + i - 1] - internal.HIV_out_SC[shared->dim_HIV_out_SC_12 * (k - 1) + shared->dim_HIV_out_SC_1 * (j - 1) + i - 1] - internal.SCdeaths[shared->dim_SCdeaths_12 * (k - 1) + shared->dim_SCdeaths_1 * (j - 1) + i - 1] - internal.TBdeaths_SC[shared->dim_TBdeaths_SC_12 * (k - 1) + shared->dim_TBdeaths_SC_1 * (j - 1) + i - 1] - internal.detection_SC[shared->dim_detection_SC_12 * (k - 1) + shared->dim_detection_SC_1 * (j - 1) + i - 1] - internal.selfcure_SC[shared->dim_selfcure_SC_12 * (k - 1) + shared->dim_selfcure_SC_1 * (j - 1) + i - 1] - internal.progress[shared->dim_progress_12 * (k - 1) + shared->dim_progress_1 * (j - 1) + i - 1];
        }
      }
    }
  }
private:
  std::shared_ptr<const shared_type> shared;
  internal_type internal;
};
template <typename real_type, typename container>
__host__ __device__ real_type odin_sum2(const container x, int from_i, int to_i, int from_j, int to_j, int dim_x_1) {
  real_type tot = 0.0;
  for (int j = from_j; j < to_j; ++j) {
    int jj = j * dim_x_1;
    for (int i = from_i; i < to_i; ++i) {
      tot += x[i + jj];
    }
  }
  return tot;
}
template <typename real_type, typename container>
__host__ __device__ real_type odin_sum3(const container x, int from_i, int to_i, int from_j, int to_j, int from_k, int to_k, int dim_x_1, int dim_x_12) {
  real_type tot = 0.0;
  for (int k = from_k; k < to_k; ++k) {
    int kk = k * dim_x_12;
    for (int j = from_j; j < to_j; ++j) {
      int jj = j * dim_x_1 + kk;
      for (int i = from_i; i < to_i; ++i) {
        tot += x[i + jj];
      }
    }
  }
  return tot;
}
#include <array>
#include <cpp11/R.hpp>
#include <cpp11/sexp.hpp>
#include <cpp11/doubles.hpp>
#include <cpp11/integers.hpp>
#include <cpp11/list.hpp>
#include <cpp11/strings.hpp>
#include <memory>
#include <vector>

template <typename T>
inline bool is_na(T x);

template <>
inline bool is_na(int x) {
  return x == NA_INTEGER;
}

template <>
inline bool is_na(double x) {
  return ISNA(x);
}

inline size_t object_length(cpp11::sexp x) {
  return ::Rf_xlength(x);
}

template <typename T>
void user_check_value(T value, const char *name, T min, T max) {
  if (is_na(value)) {
    cpp11::stop("'%s' must not be NA", name);
  }
  if (!is_na(min) && value < min) {
    cpp11::stop("Expected '%s' to be at least %g", name, (double) min);
  }
  if (!is_na(max) && value > max) {
    cpp11::stop("Expected '%s' to be at most %g", name, (double) max);
  }
}

template <typename T>
void user_check_array_value(const std::vector<T>& value, const char *name,
                            T min, T max) {
  for (auto& x : value) {
    user_check_value(x, name, min, max);
  }
}

inline size_t user_get_array_rank(cpp11::sexp x) {
  if (!::Rf_isArray(x)) {
    return 1;
  } else {
    cpp11::integers dim = cpp11::as_cpp<cpp11::integers>(x.attr("dim"));
    return dim.size();
  }
}

template <size_t N>
void user_check_array_rank(cpp11::sexp x, const char *name) {
  size_t rank = user_get_array_rank(x);
  if (rank != N) {
    if (N == 1) {
      cpp11::stop("Expected a vector for '%s'", name);
    } else if (N == 2) {
      cpp11::stop("Expected a matrix for '%s'", name);
    } else {
      cpp11::stop("Expected an array of rank %d for '%s'", N, name);
    }
  }
}

template <size_t N>
void user_check_array_dim(cpp11::sexp x, const char *name,
                          const std::array<int, N>& dim_expected) {
  cpp11::integers dim = cpp11::as_cpp<cpp11::integers>(x.attr("dim"));
  for (size_t i = 0; i < N; ++i) {
    if (dim[(int)i] != dim_expected[i]) {
      Rf_error("Incorrect size of dimension %zu of '%s' (expected %d)",
               i + 1, name, dim_expected[i]);
    }
  }
}

template <>
inline void user_check_array_dim<1>(cpp11::sexp x, const char *name,
                                    const std::array<int, 1>& dim_expected) {
  if ((int)object_length(x) != dim_expected[0]) {
    cpp11::stop("Expected length %d value for '%s'", dim_expected[0], name);
  }
}

template <size_t N>
void user_set_array_dim(cpp11::sexp x, const char *name,
                        std::array<int, N>& dim) {
  cpp11::integers dim_given = cpp11::as_cpp<cpp11::integers>(x.attr("dim"));
  std::copy(dim_given.begin(), dim_given.end(), dim.begin());
}

template <>
inline void user_set_array_dim<1>(cpp11::sexp x, const char *name,
                                  std::array<int, 1>& dim) {
  dim[0] = object_length(x);
}

template <typename T>
T user_get_scalar(cpp11::list user, const char *name,
                  const T previous, T min, T max) {
  T ret = previous;
  cpp11::sexp x = user[name];
  if (x != R_NilValue) {
    if (object_length(x) != 1) {
      cpp11::stop("Expected a scalar numeric for '%s'", name);
    }
    // TODO: when we're getting out an integer this is a bit too relaxed
    if (TYPEOF(x) == REALSXP) {
      ret = cpp11::as_cpp<T>(x);
    } else if (TYPEOF(x) == INTSXP) {
      ret = cpp11::as_cpp<T>(x);
    } else {
      cpp11::stop("Expected a numeric value for %s", name);
    }
  }

  if (is_na(ret)) {
    cpp11::stop("Expected a value for '%s'", name);
  }
  user_check_value<T>(ret, name, min, max);
  return ret;
}

template <>
inline float user_get_scalar<float>(cpp11::list user, const char *name,
                                    const float previous, float min, float max) {
  double value = user_get_scalar<double>(user, name, previous, min, max);
  return static_cast<float>(value);
}

template <typename T>
std::vector<T> user_get_array_value(cpp11::sexp x, const char * name,
                                    T min, T max) {
  std::vector<T> ret = cpp11::as_cpp<std::vector<T>>(x);
  user_check_array_value<T>(ret, name, min, max);
  return ret;
}

template <typename T, size_t N>
std::vector<T> user_get_array_fixed(cpp11::list user, const char *name,
                                    const std::vector<T> previous,
                                    const std::array<int, N>& dim,
                                    T min, T max) {
  cpp11::sexp x = user[name];
  if (x == R_NilValue) {
    if (previous.size() == 0) {
      cpp11::stop("Expected a value for '%s'", name);
    }
    return previous;
  }

  user_check_array_rank<N>(x, name);
  user_check_array_dim<N>(x, name, dim);

  return user_get_array_value<T>(x, name, min, max);
}

template <typename T, size_t N>
std::vector<T> user_get_array_variable(cpp11::list user, const char *name,
                                       std::vector<T> previous,
                                       std::array<int, N>& dim,
                                       T min, T max) {
  cpp11::sexp x = user[name];
  if (x == R_NilValue) {
    if (previous.size() == 0) {
      cpp11::stop("Expected a value for '%s'", name);
    }
    return previous;
  }

  user_check_array_rank<N>(x, name);
  user_set_array_dim<N>(x, name, dim);

  return user_get_array_value<T>(x, name, min, max);
}

template <>
inline std::vector<float> user_get_array_value(cpp11::sexp x, const char * name,
                                               float min, float max) {
  // NOTE: possible under/overflow here for min/max because we've
  // downcast this.
  std::vector<double> value = user_get_array_value<double>(x, name, min, max);
  std::vector<float> ret(value.size());
  std::copy(value.begin(), value.end(), ret.begin());
  return ret;
}

// This is sum with inclusive "from", exclusive "to", following the
// same function in odin
template <typename real_type, typename container>
__host__ __device__
real_type odin_sum1(const container x, size_t from, size_t to) {
  real_type tot = 0.0;
  for (size_t i = from; i < to; ++i) {
    tot += x[i];
  }
  return tot;
}

inline cpp11::writable::integers integer_sequence(size_t from, size_t len) {
  cpp11::writable::integers ret(len);
  int* data = INTEGER(ret);
  for (size_t i = 0, j = from; i < len; ++i, ++j) {
    data[i] = j;
  }
  return ret;
}
namespace dust {
template<>
dust::pars_type<stocm> dust_pars<stocm>(cpp11::list user) {
  using real_type = typename stocm::real_type;
  auto shared = std::make_shared<stocm::shared_type>();
  stocm::internal_type internal;
  shared->dim_A = 6;
  shared->dim_zk = 6;
  shared->initial_tot_incidence = 0;
  shared->tol = static_cast<real_type>(1e-10);
  shared->A = std::vector<real_type>(shared->dim_A);
  shared->zk = std::vector<real_type>(shared->dim_zk);
  shared->age_dims = NA_INTEGER;
  shared->ari0 = NA_REAL;
  shared->beta = NA_REAL;
  shared->cdr = NA_REAL;
  shared->cdr_SC = NA_REAL;
  shared->cfr = NA_REAL;
  shared->dt = NA_REAL;
  shared->dur = NA_REAL;
  shared->epsi = NA_REAL;
  shared->HIV_dims = NA_INTEGER;
  shared->patch_dims = NA_INTEGER;
  shared->pDf = NA_REAL;
  shared->pDr = NA_REAL;
  shared->pDs = NA_REAL;
  shared->Pi = NA_REAL;
  shared->pLL = NA_REAL;
  shared->progress_rate = NA_REAL;
  shared->regress_rate = NA_REAL;
  shared->sim_length = NA_INTEGER;
  shared->tfr = NA_REAL;
  shared->v = NA_REAL;
  shared->relinf = 1;
  shared->t_dur = static_cast<real_type>(0.5);
  shared->age_dims = user_get_scalar<int>(user, "age_dims", shared->age_dims, NA_INTEGER, NA_INTEGER);
  shared->ari0 = user_get_scalar<real_type>(user, "ari0", shared->ari0, NA_REAL, NA_REAL);
  std::array <int, 1> dim_ART_int;
  shared->ART_int = user_get_array_variable<real_type, 1>(user, "ART_int", shared->ART_int, dim_ART_int, NA_REAL, NA_REAL);
  shared->dim_ART_int = shared->ART_int.size();
  shared->beta = user_get_scalar<real_type>(user, "beta", shared->beta, NA_REAL, NA_REAL);
  std::array <int, 1> dim_births_int;
  shared->births_int = user_get_array_variable<real_type, 1>(user, "births_int", shared->births_int, dim_births_int, NA_REAL, NA_REAL);
  shared->dim_births_int = shared->births_int.size();
  shared->cdr = user_get_scalar<real_type>(user, "cdr", shared->cdr, NA_REAL, NA_REAL);
  shared->cdr_SC = user_get_scalar<real_type>(user, "cdr_SC", shared->cdr_SC, NA_REAL, NA_REAL);
  shared->cfr = user_get_scalar<real_type>(user, "cfr", shared->cfr, NA_REAL, NA_REAL);
  shared->dt = user_get_scalar<real_type>(user, "dt", shared->dt, NA_REAL, NA_REAL);
  shared->dur = user_get_scalar<real_type>(user, "dur", shared->dur, NA_REAL, NA_REAL);
  shared->epsi = user_get_scalar<real_type>(user, "epsi", shared->epsi, NA_REAL, NA_REAL);
  shared->HIV_dims = user_get_scalar<int>(user, "HIV_dims", shared->HIV_dims, NA_INTEGER, NA_INTEGER);
  std::array <int, 1> dim_HIV_int;
  shared->HIV_int = user_get_array_variable<real_type, 1>(user, "HIV_int", shared->HIV_int, dim_HIV_int, NA_REAL, NA_REAL);
  shared->dim_HIV_int = shared->HIV_int.size();
  std::array <int, 2> dim_m_in_int;
  shared->m_in_int = user_get_array_variable<real_type, 2>(user, "m_in_int", shared->m_in_int, dim_m_in_int, NA_REAL, NA_REAL);
  shared->dim_m_in_int = shared->m_in_int.size();
  shared->dim_m_in_int_1 = dim_m_in_int[0];
  shared->dim_m_in_int_2 = dim_m_in_int[1];
  std::array <int, 2> dim_mu_ART_int;
  shared->mu_ART_int = user_get_array_variable<real_type, 2>(user, "mu_ART_int", shared->mu_ART_int, dim_mu_ART_int, NA_REAL, NA_REAL);
  shared->dim_mu_ART_int = shared->mu_ART_int.size();
  shared->dim_mu_ART_int_1 = dim_mu_ART_int[0];
  shared->dim_mu_ART_int_2 = dim_mu_ART_int[1];
  std::array <int, 2> dim_mu_HIV_int;
  shared->mu_HIV_int = user_get_array_variable<real_type, 2>(user, "mu_HIV_int", shared->mu_HIV_int, dim_mu_HIV_int, NA_REAL, NA_REAL);
  shared->dim_mu_HIV_int = shared->mu_HIV_int.size();
  shared->dim_mu_HIV_int_1 = dim_mu_HIV_int[0];
  shared->dim_mu_HIV_int_2 = dim_mu_HIV_int[1];
  std::array <int, 2> dim_mu_noHIV_int;
  shared->mu_noHIV_int = user_get_array_variable<real_type, 2>(user, "mu_noHIV_int", shared->mu_noHIV_int, dim_mu_noHIV_int, NA_REAL, NA_REAL);
  shared->dim_mu_noHIV_int = shared->mu_noHIV_int.size();
  shared->dim_mu_noHIV_int_1 = dim_mu_noHIV_int[0];
  shared->dim_mu_noHIV_int_2 = dim_mu_noHIV_int[1];
  shared->patch_dims = user_get_scalar<int>(user, "patch_dims", shared->patch_dims, NA_INTEGER, NA_INTEGER);
  shared->pDf = user_get_scalar<real_type>(user, "pDf", shared->pDf, NA_REAL, NA_REAL);
  shared->pDr = user_get_scalar<real_type>(user, "pDr", shared->pDr, NA_REAL, NA_REAL);
  shared->pDs = user_get_scalar<real_type>(user, "pDs", shared->pDs, NA_REAL, NA_REAL);
  shared->Pi = user_get_scalar<real_type>(user, "Pi", shared->Pi, NA_REAL, NA_REAL);
  shared->pLL = user_get_scalar<real_type>(user, "pLL", shared->pLL, NA_REAL, NA_REAL);
  shared->progress_rate = user_get_scalar<real_type>(user, "progress_rate", shared->progress_rate, NA_REAL, NA_REAL);
  shared->regress_rate = user_get_scalar<real_type>(user, "regress_rate", shared->regress_rate, NA_REAL, NA_REAL);
  shared->relinf = user_get_scalar<real_type>(user, "relinf", shared->relinf, NA_REAL, NA_REAL);
  shared->sim_length = user_get_scalar<int>(user, "sim_length", shared->sim_length, NA_INTEGER, NA_INTEGER);
  shared->t_dur = user_get_scalar<real_type>(user, "t_dur", shared->t_dur, NA_REAL, NA_REAL);
  shared->tfr = user_get_scalar<real_type>(user, "tfr", shared->tfr, NA_REAL, NA_REAL);
  shared->v = user_get_scalar<real_type>(user, "v", shared->v, NA_REAL, NA_REAL);
  shared->dim_age_in_D_1 = shared->patch_dims;
  shared->dim_age_in_D_2 = shared->age_dims;
  shared->dim_age_in_D_3 = shared->HIV_dims;
  shared->dim_age_in_LL_1 = shared->patch_dims;
  shared->dim_age_in_LL_2 = shared->age_dims;
  shared->dim_age_in_LL_3 = shared->HIV_dims;
  shared->dim_age_in_LR_1 = shared->patch_dims;
  shared->dim_age_in_LR_2 = shared->age_dims;
  shared->dim_age_in_LR_3 = shared->HIV_dims;
  shared->dim_age_in_R_1 = shared->patch_dims;
  shared->dim_age_in_R_2 = shared->age_dims;
  shared->dim_age_in_R_3 = shared->HIV_dims;
  shared->dim_age_in_SC_1 = shared->patch_dims;
  shared->dim_age_in_SC_2 = shared->age_dims;
  shared->dim_age_in_SC_3 = shared->HIV_dims;
  shared->dim_age_in_Tr_1 = shared->patch_dims;
  shared->dim_age_in_Tr_2 = shared->age_dims;
  shared->dim_age_in_Tr_3 = shared->HIV_dims;
  shared->dim_age_in_U_1 = shared->patch_dims;
  shared->dim_age_in_U_2 = shared->age_dims;
  shared->dim_age_in_U_3 = shared->HIV_dims;
  shared->dim_age_out_D_1 = shared->patch_dims;
  shared->dim_age_out_D_2 = shared->age_dims;
  shared->dim_age_out_D_3 = shared->HIV_dims;
  shared->dim_age_out_LL_1 = shared->patch_dims;
  shared->dim_age_out_LL_2 = shared->age_dims;
  shared->dim_age_out_LL_3 = shared->HIV_dims;
  shared->dim_age_out_LR_1 = shared->patch_dims;
  shared->dim_age_out_LR_2 = shared->age_dims;
  shared->dim_age_out_LR_3 = shared->HIV_dims;
  shared->dim_age_out_R_1 = shared->patch_dims;
  shared->dim_age_out_R_2 = shared->age_dims;
  shared->dim_age_out_R_3 = shared->HIV_dims;
  shared->dim_age_out_SC_1 = shared->patch_dims;
  shared->dim_age_out_SC_2 = shared->age_dims;
  shared->dim_age_out_SC_3 = shared->HIV_dims;
  shared->dim_age_out_Tr_1 = shared->patch_dims;
  shared->dim_age_out_Tr_2 = shared->age_dims;
  shared->dim_age_out_Tr_3 = shared->HIV_dims;
  shared->dim_age_out_U_1 = shared->patch_dims;
  shared->dim_age_out_U_2 = shared->age_dims;
  shared->dim_age_out_U_3 = shared->HIV_dims;
  shared->dim_age_rate = shared->age_dims;
  shared->dim_agefracs = shared->age_dims;
  shared->dim_ageMids = shared->age_dims;
  shared->dim_ART_rate_yr = shared->age_dims;
  shared->dim_bg_deaths_1 = shared->patch_dims;
  shared->dim_bg_deaths_2 = shared->age_dims;
  shared->dim_bg_deaths_3 = shared->HIV_dims;
  shared->dim_births_1 = shared->patch_dims;
  shared->dim_births_2 = shared->age_dims;
  shared->dim_births_3 = shared->HIV_dims;
  shared->dim_cum_inf_flux_1 = shared->patch_dims;
  shared->dim_cum_inf_flux_2 = shared->patch_dims;
  shared->dim_cum_note_flux_1 = shared->patch_dims;
  shared->dim_cum_note_flux_2 = shared->patch_dims;
  shared->dim_D_1 = shared->patch_dims;
  shared->dim_D_2 = shared->age_dims;
  shared->dim_D_3 = shared->HIV_dims;
  shared->dim_D_inmigr_1 = shared->patch_dims;
  shared->dim_D_inmigr_2 = shared->age_dims;
  shared->dim_D_inmigr_3 = shared->HIV_dims;
  shared->dim_Ddeaths_1 = shared->patch_dims;
  shared->dim_Ddeaths_2 = shared->age_dims;
  shared->dim_Ddeaths_3 = shared->HIV_dims;
  shared->dim_detection_1 = shared->patch_dims;
  shared->dim_detection_2 = shared->age_dims;
  shared->dim_detection_3 = shared->HIV_dims;
  shared->dim_detection_SC_1 = shared->patch_dims;
  shared->dim_detection_SC_2 = shared->age_dims;
  shared->dim_detection_SC_3 = shared->HIV_dims;
  shared->dim_elli = shared->patch_dims;
  shared->dim_ellij_1 = shared->patch_dims;
  shared->dim_ellij_2 = shared->patch_dims;
  shared->dim_foi = shared->patch_dims;
  shared->dim_foitemp_1 = shared->patch_dims;
  shared->dim_foitemp_2 = shared->patch_dims;
  shared->dim_Hirr = shared->HIV_dims;
  shared->dim_HIV_in_D_1 = shared->patch_dims;
  shared->dim_HIV_in_D_2 = shared->age_dims;
  shared->dim_HIV_in_D_3 = shared->HIV_dims;
  shared->dim_HIV_in_LL_1 = shared->patch_dims;
  shared->dim_HIV_in_LL_2 = shared->age_dims;
  shared->dim_HIV_in_LL_3 = shared->HIV_dims;
  shared->dim_HIV_in_LR_1 = shared->patch_dims;
  shared->dim_HIV_in_LR_2 = shared->age_dims;
  shared->dim_HIV_in_LR_3 = shared->HIV_dims;
  shared->dim_HIV_in_R_1 = shared->patch_dims;
  shared->dim_HIV_in_R_2 = shared->age_dims;
  shared->dim_HIV_in_R_3 = shared->HIV_dims;
  shared->dim_HIV_in_SC_1 = shared->patch_dims;
  shared->dim_HIV_in_SC_2 = shared->age_dims;
  shared->dim_HIV_in_SC_3 = shared->HIV_dims;
  shared->dim_HIV_in_Tr_1 = shared->patch_dims;
  shared->dim_HIV_in_Tr_2 = shared->age_dims;
  shared->dim_HIV_in_Tr_3 = shared->HIV_dims;
  shared->dim_HIV_in_U_1 = shared->patch_dims;
  shared->dim_HIV_in_U_2 = shared->age_dims;
  shared->dim_HIV_in_U_3 = shared->HIV_dims;
  shared->dim_HIV_out_D_1 = shared->patch_dims;
  shared->dim_HIV_out_D_2 = shared->age_dims;
  shared->dim_HIV_out_D_3 = shared->HIV_dims;
  shared->dim_HIV_out_LL_1 = shared->patch_dims;
  shared->dim_HIV_out_LL_2 = shared->age_dims;
  shared->dim_HIV_out_LL_3 = shared->HIV_dims;
  shared->dim_HIV_out_LR_1 = shared->patch_dims;
  shared->dim_HIV_out_LR_2 = shared->age_dims;
  shared->dim_HIV_out_LR_3 = shared->HIV_dims;
  shared->dim_HIV_out_R_1 = shared->patch_dims;
  shared->dim_HIV_out_R_2 = shared->age_dims;
  shared->dim_HIV_out_R_3 = shared->HIV_dims;
  shared->dim_HIV_out_SC_1 = shared->patch_dims;
  shared->dim_HIV_out_SC_2 = shared->age_dims;
  shared->dim_HIV_out_SC_3 = shared->HIV_dims;
  shared->dim_HIV_out_Tr_1 = shared->patch_dims;
  shared->dim_HIV_out_Tr_2 = shared->age_dims;
  shared->dim_HIV_out_Tr_3 = shared->HIV_dims;
  shared->dim_HIV_out_U_1 = shared->patch_dims;
  shared->dim_HIV_out_U_2 = shared->age_dims;
  shared->dim_HIV_out_U_3 = shared->HIV_dims;
  shared->dim_HIV_rate_yr = shared->age_dims;
  shared->dim_incidence_1 = shared->patch_dims;
  shared->dim_incidence_2 = shared->age_dims;
  shared->dim_incidence_3 = shared->HIV_dims;
  shared->dim_InfsByPatch = shared->patch_dims;
  shared->dim_InfsByPatchPatch_1 = shared->patch_dims;
  shared->dim_InfsByPatchPatch_2 = shared->patch_dims;
  shared->dim_init_D_1 = shared->patch_dims;
  shared->dim_init_D_2 = shared->age_dims;
  shared->dim_init_LL_1 = shared->patch_dims;
  shared->dim_init_LL_2 = shared->age_dims;
  shared->dim_init_LR_1 = shared->patch_dims;
  shared->dim_init_LR_2 = shared->age_dims;
  shared->dim_init_R_1 = shared->patch_dims;
  shared->dim_init_R_2 = shared->age_dims;
  shared->dim_init_SC_1 = shared->patch_dims;
  shared->dim_init_SC_2 = shared->age_dims;
  shared->dim_init_Tr_1 = shared->patch_dims;
  shared->dim_init_Tr_2 = shared->age_dims;
  shared->dim_init_U_1 = shared->patch_dims;
  shared->dim_init_U_2 = shared->age_dims;
  shared->dim_initD_1 = shared->patch_dims;
  shared->dim_initD_2 = shared->age_dims;
  shared->dim_initDenom_1 = shared->patch_dims;
  shared->dim_initDenom_2 = shared->age_dims;
  shared->dim_initF_1 = shared->patch_dims;
  shared->dim_initF_2 = shared->age_dims;
  shared->dim_initLL_1 = shared->patch_dims;
  shared->dim_initLL_2 = shared->age_dims;
  shared->dim_initPrev_1 = shared->patch_dims;
  shared->dim_initPrev_2 = shared->age_dims;
  shared->dim_IRR = shared->patch_dims;
  shared->dim_LL_1 = shared->patch_dims;
  shared->dim_LL_2 = shared->age_dims;
  shared->dim_LL_3 = shared->HIV_dims;
  shared->dim_LL_inmigr_1 = shared->patch_dims;
  shared->dim_LL_inmigr_2 = shared->age_dims;
  shared->dim_LL_inmigr_3 = shared->HIV_dims;
  shared->dim_LLdeaths_1 = shared->patch_dims;
  shared->dim_LLdeaths_2 = shared->age_dims;
  shared->dim_LLdeaths_3 = shared->HIV_dims;
  shared->dim_LLinfs_1 = shared->patch_dims;
  shared->dim_LLinfs_2 = shared->age_dims;
  shared->dim_LLinfs_3 = shared->HIV_dims;
  shared->dim_LR_1 = shared->patch_dims;
  shared->dim_LR_2 = shared->age_dims;
  shared->dim_LR_3 = shared->HIV_dims;
  shared->dim_LR_inmigr_1 = shared->patch_dims;
  shared->dim_LR_inmigr_2 = shared->age_dims;
  shared->dim_LR_inmigr_3 = shared->HIV_dims;
  shared->dim_LRdeaths_1 = shared->patch_dims;
  shared->dim_LRdeaths_2 = shared->age_dims;
  shared->dim_LRdeaths_3 = shared->HIV_dims;
  shared->dim_m_in_t = shared->age_dims;
  shared->dim_MM_1 = shared->patch_dims;
  shared->dim_MM_2 = shared->patch_dims;
  shared->dim_mu_ART_t = shared->age_dims;
  shared->dim_mu_HIV_t = shared->age_dims;
  shared->dim_mu_noHIV_t = shared->age_dims;
  shared->dim_N_1 = shared->patch_dims;
  shared->dim_N_2 = shared->age_dims;
  shared->dim_N_3 = shared->HIV_dims;
  shared->dim_Nevents_D_1 = shared->patch_dims;
  shared->dim_Nevents_D_2 = shared->age_dims;
  shared->dim_Nevents_D_3 = shared->HIV_dims;
  shared->dim_Nevents_LL_1 = shared->patch_dims;
  shared->dim_Nevents_LL_2 = shared->age_dims;
  shared->dim_Nevents_LL_3 = shared->HIV_dims;
  shared->dim_Nevents_LR_1 = shared->patch_dims;
  shared->dim_Nevents_LR_2 = shared->age_dims;
  shared->dim_Nevents_LR_3 = shared->HIV_dims;
  shared->dim_Nevents_R_1 = shared->patch_dims;
  shared->dim_Nevents_R_2 = shared->age_dims;
  shared->dim_Nevents_R_3 = shared->HIV_dims;
  shared->dim_Nevents_SC_1 = shared->patch_dims;
  shared->dim_Nevents_SC_2 = shared->age_dims;
  shared->dim_Nevents_SC_3 = shared->HIV_dims;
  shared->dim_Nevents_Tr_1 = shared->patch_dims;
  shared->dim_Nevents_Tr_2 = shared->age_dims;
  shared->dim_Nevents_Tr_3 = shared->HIV_dims;
  shared->dim_Nevents_U_1 = shared->patch_dims;
  shared->dim_Nevents_U_2 = shared->age_dims;
  shared->dim_Nevents_U_3 = shared->HIV_dims;
  shared->dim_notes_1 = shared->patch_dims;
  shared->dim_notes_2 = shared->age_dims;
  shared->dim_notes_3 = shared->HIV_dims;
  shared->dim_NotesByPatch = shared->patch_dims;
  shared->dim_NotesByPatchPatch_1 = shared->patch_dims;
  shared->dim_NotesByPatchPatch_2 = shared->patch_dims;
  shared->dim_notifrate_1 = shared->patch_dims;
  shared->dim_notifrate_2 = shared->age_dims;
  shared->dim_notifrate_3 = shared->HIV_dims;
  shared->dim_p_Dage_1 = shared->patch_dims;
  shared->dim_p_Dage_2 = shared->age_dims;
  shared->dim_p_Dage_3 = shared->HIV_dims;
  shared->dim_p_detect_1 = shared->patch_dims;
  shared->dim_p_detect_2 = shared->age_dims;
  shared->dim_p_detect_3 = shared->HIV_dims;
  shared->dim_p_detect_SC_1 = shared->patch_dims;
  shared->dim_p_detect_SC_2 = shared->age_dims;
  shared->dim_p_detect_SC_3 = shared->HIV_dims;
  shared->dim_p_DHIV_1 = shared->patch_dims;
  shared->dim_p_DHIV_2 = shared->age_dims;
  shared->dim_p_DHIV_3 = shared->HIV_dims;
  shared->dim_p_LLage_1 = shared->patch_dims;
  shared->dim_p_LLage_2 = shared->age_dims;
  shared->dim_p_LLage_3 = shared->HIV_dims;
  shared->dim_p_LLHIV_1 = shared->patch_dims;
  shared->dim_p_LLHIV_2 = shared->age_dims;
  shared->dim_p_LLHIV_3 = shared->HIV_dims;
  shared->dim_p_LLinfs_1 = shared->patch_dims;
  shared->dim_p_LLinfs_2 = shared->age_dims;
  shared->dim_p_LLinfs_3 = shared->HIV_dims;
  shared->dim_p_LRage_1 = shared->patch_dims;
  shared->dim_p_LRage_2 = shared->age_dims;
  shared->dim_p_LRage_3 = shared->HIV_dims;
  shared->dim_p_LRHIV_1 = shared->patch_dims;
  shared->dim_p_LRHIV_2 = shared->age_dims;
  shared->dim_p_LRHIV_3 = shared->HIV_dims;
  shared->dim_p_progFast_1 = shared->patch_dims;
  shared->dim_p_progFast_2 = shared->age_dims;
  shared->dim_p_progFast_3 = shared->HIV_dims;
  shared->dim_p_progress_1 = shared->patch_dims;
  shared->dim_p_progress_2 = shared->age_dims;
  shared->dim_p_progress_3 = shared->HIV_dims;
  shared->dim_p_progSlow_1 = shared->patch_dims;
  shared->dim_p_progSlow_2 = shared->age_dims;
  shared->dim_p_progSlow_3 = shared->HIV_dims;
  shared->dim_p_Rage_1 = shared->patch_dims;
  shared->dim_p_Rage_2 = shared->age_dims;
  shared->dim_p_Rage_3 = shared->HIV_dims;
  shared->dim_p_regress_1 = shared->patch_dims;
  shared->dim_p_regress_2 = shared->age_dims;
  shared->dim_p_regress_3 = shared->HIV_dims;
  shared->dim_p_relapse_1 = shared->patch_dims;
  shared->dim_p_relapse_2 = shared->age_dims;
  shared->dim_p_relapse_3 = shared->HIV_dims;
  shared->dim_p_RHIV_1 = shared->patch_dims;
  shared->dim_p_RHIV_2 = shared->age_dims;
  shared->dim_p_RHIV_3 = shared->HIV_dims;
  shared->dim_p_Rinfs_1 = shared->patch_dims;
  shared->dim_p_Rinfs_2 = shared->age_dims;
  shared->dim_p_Rinfs_3 = shared->HIV_dims;
  shared->dim_p_SCage_1 = shared->patch_dims;
  shared->dim_p_SCage_2 = shared->age_dims;
  shared->dim_p_SCage_3 = shared->HIV_dims;
  shared->dim_p_SCHIV_1 = shared->patch_dims;
  shared->dim_p_SCHIV_2 = shared->age_dims;
  shared->dim_p_SCHIV_3 = shared->HIV_dims;
  shared->dim_p_selfcr_1 = shared->patch_dims;
  shared->dim_p_selfcr_2 = shared->age_dims;
  shared->dim_p_selfcr_3 = shared->HIV_dims;
  shared->dim_p_selfcr_SC_1 = shared->patch_dims;
  shared->dim_p_selfcr_SC_2 = shared->age_dims;
  shared->dim_p_selfcr_SC_3 = shared->HIV_dims;
  shared->dim_p_stabilise_1 = shared->patch_dims;
  shared->dim_p_stabilise_2 = shared->age_dims;
  shared->dim_p_stabilise_3 = shared->HIV_dims;
  shared->dim_p_TBdeaths_1 = shared->patch_dims;
  shared->dim_p_TBdeaths_2 = shared->age_dims;
  shared->dim_p_TBdeaths_3 = shared->HIV_dims;
  shared->dim_p_TBdeaths_SC_1 = shared->patch_dims;
  shared->dim_p_TBdeaths_SC_2 = shared->age_dims;
  shared->dim_p_TBdeaths_SC_3 = shared->HIV_dims;
  shared->dim_p_Trage_1 = shared->patch_dims;
  shared->dim_p_Trage_2 = shared->age_dims;
  shared->dim_p_Trage_3 = shared->HIV_dims;
  shared->dim_p_TrHIV_1 = shared->patch_dims;
  shared->dim_p_TrHIV_2 = shared->age_dims;
  shared->dim_p_TrHIV_3 = shared->HIV_dims;
  shared->dim_p_Trsuccess_1 = shared->patch_dims;
  shared->dim_p_Trsuccess_2 = shared->age_dims;
  shared->dim_p_Trsuccess_3 = shared->HIV_dims;
  shared->dim_p_Trxdeaths_1 = shared->patch_dims;
  shared->dim_p_Trxdeaths_2 = shared->age_dims;
  shared->dim_p_Trxdeaths_3 = shared->HIV_dims;
  shared->dim_p_Uage_1 = shared->patch_dims;
  shared->dim_p_Uage_2 = shared->age_dims;
  shared->dim_p_Uage_3 = shared->HIV_dims;
  shared->dim_p_UHIV_1 = shared->patch_dims;
  shared->dim_p_UHIV_2 = shared->age_dims;
  shared->dim_p_UHIV_3 = shared->HIV_dims;
  shared->dim_p_Uinf_1 = shared->patch_dims;
  shared->dim_p_Uinf_2 = shared->age_dims;
  shared->dim_p_Uinf_3 = shared->HIV_dims;
  shared->dim_pD_inmigr_1 = shared->patch_dims;
  shared->dim_pD_inmigr_2 = shared->age_dims;
  shared->dim_pD_inmigr_3 = shared->HIV_dims;
  shared->dim_Pellij_1 = shared->patch_dims;
  shared->dim_Pellij_2 = shared->patch_dims;
  shared->dim_pLL_inmigr_1 = shared->patch_dims;
  shared->dim_pLL_inmigr_2 = shared->age_dims;
  shared->dim_pLL_inmigr_3 = shared->HIV_dims;
  shared->dim_pLR_inmigr_1 = shared->patch_dims;
  shared->dim_pLR_inmigr_2 = shared->age_dims;
  shared->dim_pLR_inmigr_3 = shared->HIV_dims;
  shared->dim_popinit = shared->patch_dims;
  shared->dim_popinit_byage_1 = shared->patch_dims;
  shared->dim_popinit_byage_2 = shared->age_dims;
  shared->dim_pR_inmigr_1 = shared->patch_dims;
  shared->dim_pR_inmigr_2 = shared->age_dims;
  shared->dim_pR_inmigr_3 = shared->HIV_dims;
  shared->dim_progFast_1 = shared->patch_dims;
  shared->dim_progFast_2 = shared->age_dims;
  shared->dim_progFast_3 = shared->HIV_dims;
  shared->dim_progress_1 = shared->patch_dims;
  shared->dim_progress_2 = shared->age_dims;
  shared->dim_progress_3 = shared->HIV_dims;
  shared->dim_progSlow_1 = shared->patch_dims;
  shared->dim_progSlow_2 = shared->age_dims;
  shared->dim_progSlow_3 = shared->HIV_dims;
  shared->dim_pSC_inmigr_1 = shared->patch_dims;
  shared->dim_pSC_inmigr_2 = shared->age_dims;
  shared->dim_pSC_inmigr_3 = shared->HIV_dims;
  shared->dim_pTr_inmigr_1 = shared->patch_dims;
  shared->dim_pTr_inmigr_2 = shared->age_dims;
  shared->dim_pTr_inmigr_3 = shared->HIV_dims;
  shared->dim_pU_inmigr_1 = shared->patch_dims;
  shared->dim_pU_inmigr_2 = shared->age_dims;
  shared->dim_pU_inmigr_3 = shared->HIV_dims;
  shared->dim_R_1 = shared->patch_dims;
  shared->dim_R_2 = shared->age_dims;
  shared->dim_R_3 = shared->HIV_dims;
  shared->dim_R_inmigr_1 = shared->patch_dims;
  shared->dim_R_inmigr_2 = shared->age_dims;
  shared->dim_R_inmigr_3 = shared->HIV_dims;
  shared->dim_rate_D_1 = shared->patch_dims;
  shared->dim_rate_D_2 = shared->age_dims;
  shared->dim_rate_D_3 = shared->HIV_dims;
  shared->dim_rate_LL_1 = shared->patch_dims;
  shared->dim_rate_LL_2 = shared->age_dims;
  shared->dim_rate_LL_3 = shared->HIV_dims;
  shared->dim_rate_LR_1 = shared->patch_dims;
  shared->dim_rate_LR_2 = shared->age_dims;
  shared->dim_rate_LR_3 = shared->HIV_dims;
  shared->dim_rate_R_1 = shared->patch_dims;
  shared->dim_rate_R_2 = shared->age_dims;
  shared->dim_rate_R_3 = shared->HIV_dims;
  shared->dim_rate_SC_1 = shared->patch_dims;
  shared->dim_rate_SC_2 = shared->age_dims;
  shared->dim_rate_SC_3 = shared->HIV_dims;
  shared->dim_rate_Tr_1 = shared->patch_dims;
  shared->dim_rate_Tr_2 = shared->age_dims;
  shared->dim_rate_Tr_3 = shared->HIV_dims;
  shared->dim_rate_U_1 = shared->patch_dims;
  shared->dim_rate_U_2 = shared->age_dims;
  shared->dim_rate_U_3 = shared->HIV_dims;
  shared->dim_Rdeaths_1 = shared->patch_dims;
  shared->dim_Rdeaths_2 = shared->age_dims;
  shared->dim_Rdeaths_3 = shared->HIV_dims;
  shared->dim_regress_1 = shared->patch_dims;
  shared->dim_regress_2 = shared->age_dims;
  shared->dim_regress_3 = shared->HIV_dims;
  shared->dim_relapse_1 = shared->patch_dims;
  shared->dim_relapse_2 = shared->age_dims;
  shared->dim_relapse_3 = shared->HIV_dims;
  shared->dim_Rinfs_1 = shared->patch_dims;
  shared->dim_Rinfs_2 = shared->age_dims;
  shared->dim_Rinfs_3 = shared->HIV_dims;
  shared->dim_SC_1 = shared->patch_dims;
  shared->dim_SC_2 = shared->age_dims;
  shared->dim_SC_3 = shared->HIV_dims;
  shared->dim_SC_inmigr_1 = shared->patch_dims;
  shared->dim_SC_inmigr_2 = shared->age_dims;
  shared->dim_SC_inmigr_3 = shared->HIV_dims;
  shared->dim_SCdeaths_1 = shared->patch_dims;
  shared->dim_SCdeaths_2 = shared->age_dims;
  shared->dim_SCdeaths_3 = shared->HIV_dims;
  shared->dim_selfcure_1 = shared->patch_dims;
  shared->dim_selfcure_2 = shared->age_dims;
  shared->dim_selfcure_3 = shared->HIV_dims;
  shared->dim_selfcure_SC_1 = shared->patch_dims;
  shared->dim_selfcure_SC_2 = shared->age_dims;
  shared->dim_selfcure_SC_3 = shared->HIV_dims;
  shared->dim_Sij_1 = shared->patch_dims;
  shared->dim_Sij_2 = shared->patch_dims;
  shared->dim_stabilisations_1 = shared->patch_dims;
  shared->dim_stabilisations_2 = shared->age_dims;
  shared->dim_stabilisations_3 = shared->HIV_dims;
  shared->dim_TB_deaths_1 = shared->patch_dims;
  shared->dim_TB_deaths_2 = shared->age_dims;
  shared->dim_TB_deaths_3 = shared->HIV_dims;
  shared->dim_TB_HIV_mod = shared->HIV_dims;
  shared->dim_TBdeaths_1 = shared->patch_dims;
  shared->dim_TBdeaths_2 = shared->age_dims;
  shared->dim_TBdeaths_3 = shared->HIV_dims;
  shared->dim_TBdeaths_SC_1 = shared->patch_dims;
  shared->dim_TBdeaths_SC_2 = shared->age_dims;
  shared->dim_TBdeaths_SC_3 = shared->HIV_dims;
  shared->dim_tbi_D_1 = shared->patch_dims;
  shared->dim_tbi_D_2 = shared->age_dims;
  shared->dim_tbi_LL_1 = shared->patch_dims;
  shared->dim_tbi_LL_2 = shared->age_dims;
  shared->dim_tbi_LR_1 = shared->patch_dims;
  shared->dim_tbi_LR_2 = shared->age_dims;
  shared->dim_tbi_R_1 = shared->patch_dims;
  shared->dim_tbi_R_2 = shared->age_dims;
  shared->dim_tbi_SC_1 = shared->patch_dims;
  shared->dim_tbi_SC_2 = shared->age_dims;
  shared->dim_tbi_Tr_1 = shared->patch_dims;
  shared->dim_tbi_Tr_2 = shared->age_dims;
  shared->dim_tbi_U_1 = shared->patch_dims;
  shared->dim_tbi_U_2 = shared->age_dims;
  shared->dim_Tijk_1 = shared->patch_dims;
  shared->dim_Tijk_2 = shared->patch_dims;
  shared->dim_Tijk_3 = 6;
  shared->dim_Tr_1 = shared->patch_dims;
  shared->dim_Tr_2 = shared->age_dims;
  shared->dim_Tr_3 = shared->HIV_dims;
  shared->dim_Tr_inmigr_1 = shared->patch_dims;
  shared->dim_Tr_inmigr_2 = shared->age_dims;
  shared->dim_Tr_inmigr_3 = shared->HIV_dims;
  shared->dim_Trdeaths_1 = shared->patch_dims;
  shared->dim_Trdeaths_2 = shared->age_dims;
  shared->dim_Trdeaths_3 = shared->HIV_dims;
  shared->dim_Trsuccess_1 = shared->patch_dims;
  shared->dim_Trsuccess_2 = shared->age_dims;
  shared->dim_Trsuccess_3 = shared->HIV_dims;
  shared->dim_Trxdeaths_1 = shared->patch_dims;
  shared->dim_Trxdeaths_2 = shared->age_dims;
  shared->dim_Trxdeaths_3 = shared->HIV_dims;
  shared->dim_tt = shared->sim_length;
  shared->dim_U_1 = shared->patch_dims;
  shared->dim_U_2 = shared->age_dims;
  shared->dim_U_3 = shared->HIV_dims;
  shared->dim_U_inmigr_1 = shared->patch_dims;
  shared->dim_U_inmigr_2 = shared->age_dims;
  shared->dim_U_inmigr_3 = shared->HIV_dims;
  shared->dim_Udeaths_1 = shared->patch_dims;
  shared->dim_Udeaths_2 = shared->age_dims;
  shared->dim_Udeaths_3 = shared->HIV_dims;
  shared->dim_Uinfs_1 = shared->patch_dims;
  shared->dim_Uinfs_2 = shared->age_dims;
  shared->dim_Uinfs_3 = shared->HIV_dims;
  shared->dtct_rate = shared->cdr / (real_type) (shared->dur * (1 - shared->cdr));
  shared->dtct_rate_SC = shared->cdr_SC / (real_type) (shared->dur * (1 - shared->cdr_SC));
  shared->initial_beta_test = shared->beta;
  shared->Palpha = shared->pDf;
  shared->Pepsilon = shared->pDs;
  shared->Pgamma = shared->progress_rate - shared->regress_rate;
  shared->Pmu = shared->mu_noHIV_int[shared->dim_mu_noHIV_int_1 * 0 + 1];
  shared->Pomega = 1 / (real_type) shared->dur;
  shared->Prho = shared->pDr;
  shared->Psigma = shared->pLL;
  shared->Ptau = 1 / (real_type) shared->t_dur;
  shared->slfcr_rate = (1 - shared->cfr) / (real_type) shared->dur;
  shared->TBd_rate = shared->cfr / (real_type) shared->dur;
  shared->Trsucc_rate = (1 - shared->tfr) / (real_type) shared->t_dur;
  shared->Trxd_rate = shared->tfr / (real_type) shared->t_dur;
  shared->age_rate = user_get_array_fixed<real_type, 1>(user, "age_rate", shared->age_rate, {shared->dim_age_rate}, NA_REAL, NA_REAL);
  shared->agefracs = user_get_array_fixed<real_type, 1>(user, "agefracs", shared->agefracs, {shared->dim_agefracs}, NA_REAL, NA_REAL);
  shared->ageMids = user_get_array_fixed<real_type, 1>(user, "ageMids", shared->ageMids, {shared->dim_ageMids}, NA_REAL, NA_REAL);
  internal.ART_rate_yr = std::vector<real_type>(shared->dim_ART_rate_yr);
  internal.elli = std::vector<real_type>(shared->dim_elli);
  internal.foi = std::vector<real_type>(shared->dim_foi);
  internal.HIV_rate_yr = std::vector<real_type>(shared->dim_HIV_rate_yr);
  internal.InfsByPatch = std::vector<real_type>(shared->dim_InfsByPatch);
  internal.m_in_t = std::vector<real_type>(shared->dim_m_in_t);
  internal.mu_ART_t = std::vector<real_type>(shared->dim_mu_ART_t);
  internal.mu_HIV_t = std::vector<real_type>(shared->dim_mu_HIV_t);
  internal.mu_noHIV_t = std::vector<real_type>(shared->dim_mu_noHIV_t);
  internal.NotesByPatch = std::vector<real_type>(shared->dim_NotesByPatch);
  shared->dim_age_in_D = shared->dim_age_in_D_1 * shared->dim_age_in_D_2 * shared->dim_age_in_D_3;
  shared->dim_age_in_D_12 = shared->dim_age_in_D_1 * shared->dim_age_in_D_2;
  shared->dim_age_in_LL = shared->dim_age_in_LL_1 * shared->dim_age_in_LL_2 * shared->dim_age_in_LL_3;
  shared->dim_age_in_LL_12 = shared->dim_age_in_LL_1 * shared->dim_age_in_LL_2;
  shared->dim_age_in_LR = shared->dim_age_in_LR_1 * shared->dim_age_in_LR_2 * shared->dim_age_in_LR_3;
  shared->dim_age_in_LR_12 = shared->dim_age_in_LR_1 * shared->dim_age_in_LR_2;
  shared->dim_age_in_R = shared->dim_age_in_R_1 * shared->dim_age_in_R_2 * shared->dim_age_in_R_3;
  shared->dim_age_in_R_12 = shared->dim_age_in_R_1 * shared->dim_age_in_R_2;
  shared->dim_age_in_SC = shared->dim_age_in_SC_1 * shared->dim_age_in_SC_2 * shared->dim_age_in_SC_3;
  shared->dim_age_in_SC_12 = shared->dim_age_in_SC_1 * shared->dim_age_in_SC_2;
  shared->dim_age_in_Tr = shared->dim_age_in_Tr_1 * shared->dim_age_in_Tr_2 * shared->dim_age_in_Tr_3;
  shared->dim_age_in_Tr_12 = shared->dim_age_in_Tr_1 * shared->dim_age_in_Tr_2;
  shared->dim_age_in_U = shared->dim_age_in_U_1 * shared->dim_age_in_U_2 * shared->dim_age_in_U_3;
  shared->dim_age_in_U_12 = shared->dim_age_in_U_1 * shared->dim_age_in_U_2;
  shared->dim_age_out_D = shared->dim_age_out_D_1 * shared->dim_age_out_D_2 * shared->dim_age_out_D_3;
  shared->dim_age_out_D_12 = shared->dim_age_out_D_1 * shared->dim_age_out_D_2;
  shared->dim_age_out_LL = shared->dim_age_out_LL_1 * shared->dim_age_out_LL_2 * shared->dim_age_out_LL_3;
  shared->dim_age_out_LL_12 = shared->dim_age_out_LL_1 * shared->dim_age_out_LL_2;
  shared->dim_age_out_LR = shared->dim_age_out_LR_1 * shared->dim_age_out_LR_2 * shared->dim_age_out_LR_3;
  shared->dim_age_out_LR_12 = shared->dim_age_out_LR_1 * shared->dim_age_out_LR_2;
  shared->dim_age_out_R = shared->dim_age_out_R_1 * shared->dim_age_out_R_2 * shared->dim_age_out_R_3;
  shared->dim_age_out_R_12 = shared->dim_age_out_R_1 * shared->dim_age_out_R_2;
  shared->dim_age_out_SC = shared->dim_age_out_SC_1 * shared->dim_age_out_SC_2 * shared->dim_age_out_SC_3;
  shared->dim_age_out_SC_12 = shared->dim_age_out_SC_1 * shared->dim_age_out_SC_2;
  shared->dim_age_out_Tr = shared->dim_age_out_Tr_1 * shared->dim_age_out_Tr_2 * shared->dim_age_out_Tr_3;
  shared->dim_age_out_Tr_12 = shared->dim_age_out_Tr_1 * shared->dim_age_out_Tr_2;
  shared->dim_age_out_U = shared->dim_age_out_U_1 * shared->dim_age_out_U_2 * shared->dim_age_out_U_3;
  shared->dim_age_out_U_12 = shared->dim_age_out_U_1 * shared->dim_age_out_U_2;
  shared->dim_bg_deaths = shared->dim_bg_deaths_1 * shared->dim_bg_deaths_2 * shared->dim_bg_deaths_3;
  shared->dim_bg_deaths_12 = shared->dim_bg_deaths_1 * shared->dim_bg_deaths_2;
  shared->dim_births = shared->dim_births_1 * shared->dim_births_2 * shared->dim_births_3;
  shared->dim_births_12 = shared->dim_births_1 * shared->dim_births_2;
  shared->dim_cum_inf_flux = shared->dim_cum_inf_flux_1 * shared->dim_cum_inf_flux_2;
  shared->dim_cum_note_flux = shared->dim_cum_note_flux_1 * shared->dim_cum_note_flux_2;
  shared->dim_D = shared->dim_D_1 * shared->dim_D_2 * shared->dim_D_3;
  shared->dim_D_12 = shared->dim_D_1 * shared->dim_D_2;
  shared->dim_D_inmigr = shared->dim_D_inmigr_1 * shared->dim_D_inmigr_2 * shared->dim_D_inmigr_3;
  shared->dim_D_inmigr_12 = shared->dim_D_inmigr_1 * shared->dim_D_inmigr_2;
  shared->dim_Ddeaths = shared->dim_Ddeaths_1 * shared->dim_Ddeaths_2 * shared->dim_Ddeaths_3;
  shared->dim_Ddeaths_12 = shared->dim_Ddeaths_1 * shared->dim_Ddeaths_2;
  shared->dim_detection = shared->dim_detection_1 * shared->dim_detection_2 * shared->dim_detection_3;
  shared->dim_detection_12 = shared->dim_detection_1 * shared->dim_detection_2;
  shared->dim_detection_SC = shared->dim_detection_SC_1 * shared->dim_detection_SC_2 * shared->dim_detection_SC_3;
  shared->dim_detection_SC_12 = shared->dim_detection_SC_1 * shared->dim_detection_SC_2;
  shared->dim_ellij = shared->dim_ellij_1 * shared->dim_ellij_2;
  shared->dim_foitemp = shared->dim_foitemp_1 * shared->dim_foitemp_2;
  shared->dim_HIV_in_D = shared->dim_HIV_in_D_1 * shared->dim_HIV_in_D_2 * shared->dim_HIV_in_D_3;
  shared->dim_HIV_in_D_12 = shared->dim_HIV_in_D_1 * shared->dim_HIV_in_D_2;
  shared->dim_HIV_in_LL = shared->dim_HIV_in_LL_1 * shared->dim_HIV_in_LL_2 * shared->dim_HIV_in_LL_3;
  shared->dim_HIV_in_LL_12 = shared->dim_HIV_in_LL_1 * shared->dim_HIV_in_LL_2;
  shared->dim_HIV_in_LR = shared->dim_HIV_in_LR_1 * shared->dim_HIV_in_LR_2 * shared->dim_HIV_in_LR_3;
  shared->dim_HIV_in_LR_12 = shared->dim_HIV_in_LR_1 * shared->dim_HIV_in_LR_2;
  shared->dim_HIV_in_R = shared->dim_HIV_in_R_1 * shared->dim_HIV_in_R_2 * shared->dim_HIV_in_R_3;
  shared->dim_HIV_in_R_12 = shared->dim_HIV_in_R_1 * shared->dim_HIV_in_R_2;
  shared->dim_HIV_in_SC = shared->dim_HIV_in_SC_1 * shared->dim_HIV_in_SC_2 * shared->dim_HIV_in_SC_3;
  shared->dim_HIV_in_SC_12 = shared->dim_HIV_in_SC_1 * shared->dim_HIV_in_SC_2;
  shared->dim_HIV_in_Tr = shared->dim_HIV_in_Tr_1 * shared->dim_HIV_in_Tr_2 * shared->dim_HIV_in_Tr_3;
  shared->dim_HIV_in_Tr_12 = shared->dim_HIV_in_Tr_1 * shared->dim_HIV_in_Tr_2;
  shared->dim_HIV_in_U = shared->dim_HIV_in_U_1 * shared->dim_HIV_in_U_2 * shared->dim_HIV_in_U_3;
  shared->dim_HIV_in_U_12 = shared->dim_HIV_in_U_1 * shared->dim_HIV_in_U_2;
  shared->dim_HIV_out_D = shared->dim_HIV_out_D_1 * shared->dim_HIV_out_D_2 * shared->dim_HIV_out_D_3;
  shared->dim_HIV_out_D_12 = shared->dim_HIV_out_D_1 * shared->dim_HIV_out_D_2;
  shared->dim_HIV_out_LL = shared->dim_HIV_out_LL_1 * shared->dim_HIV_out_LL_2 * shared->dim_HIV_out_LL_3;
  shared->dim_HIV_out_LL_12 = shared->dim_HIV_out_LL_1 * shared->dim_HIV_out_LL_2;
  shared->dim_HIV_out_LR = shared->dim_HIV_out_LR_1 * shared->dim_HIV_out_LR_2 * shared->dim_HIV_out_LR_3;
  shared->dim_HIV_out_LR_12 = shared->dim_HIV_out_LR_1 * shared->dim_HIV_out_LR_2;
  shared->dim_HIV_out_R = shared->dim_HIV_out_R_1 * shared->dim_HIV_out_R_2 * shared->dim_HIV_out_R_3;
  shared->dim_HIV_out_R_12 = shared->dim_HIV_out_R_1 * shared->dim_HIV_out_R_2;
  shared->dim_HIV_out_SC = shared->dim_HIV_out_SC_1 * shared->dim_HIV_out_SC_2 * shared->dim_HIV_out_SC_3;
  shared->dim_HIV_out_SC_12 = shared->dim_HIV_out_SC_1 * shared->dim_HIV_out_SC_2;
  shared->dim_HIV_out_Tr = shared->dim_HIV_out_Tr_1 * shared->dim_HIV_out_Tr_2 * shared->dim_HIV_out_Tr_3;
  shared->dim_HIV_out_Tr_12 = shared->dim_HIV_out_Tr_1 * shared->dim_HIV_out_Tr_2;
  shared->dim_HIV_out_U = shared->dim_HIV_out_U_1 * shared->dim_HIV_out_U_2 * shared->dim_HIV_out_U_3;
  shared->dim_HIV_out_U_12 = shared->dim_HIV_out_U_1 * shared->dim_HIV_out_U_2;
  shared->dim_incidence = shared->dim_incidence_1 * shared->dim_incidence_2 * shared->dim_incidence_3;
  shared->dim_incidence_12 = shared->dim_incidence_1 * shared->dim_incidence_2;
  shared->dim_InfsByPatchPatch = shared->dim_InfsByPatchPatch_1 * shared->dim_InfsByPatchPatch_2;
  shared->dim_init_D = shared->dim_init_D_1 * shared->dim_init_D_2;
  shared->dim_init_LL = shared->dim_init_LL_1 * shared->dim_init_LL_2;
  shared->dim_init_LR = shared->dim_init_LR_1 * shared->dim_init_LR_2;
  shared->dim_init_R = shared->dim_init_R_1 * shared->dim_init_R_2;
  shared->dim_init_SC = shared->dim_init_SC_1 * shared->dim_init_SC_2;
  shared->dim_init_Tr = shared->dim_init_Tr_1 * shared->dim_init_Tr_2;
  shared->dim_init_U = shared->dim_init_U_1 * shared->dim_init_U_2;
  shared->dim_initD = shared->dim_initD_1 * shared->dim_initD_2;
  shared->dim_initDenom = shared->dim_initDenom_1 * shared->dim_initDenom_2;
  shared->dim_initF = shared->dim_initF_1 * shared->dim_initF_2;
  shared->dim_initLL = shared->dim_initLL_1 * shared->dim_initLL_2;
  shared->dim_initPrev = shared->dim_initPrev_1 * shared->dim_initPrev_2;
  shared->dim_LL = shared->dim_LL_1 * shared->dim_LL_2 * shared->dim_LL_3;
  shared->dim_LL_12 = shared->dim_LL_1 * shared->dim_LL_2;
  shared->dim_LL_inmigr = shared->dim_LL_inmigr_1 * shared->dim_LL_inmigr_2 * shared->dim_LL_inmigr_3;
  shared->dim_LL_inmigr_12 = shared->dim_LL_inmigr_1 * shared->dim_LL_inmigr_2;
  shared->dim_LLdeaths = shared->dim_LLdeaths_1 * shared->dim_LLdeaths_2 * shared->dim_LLdeaths_3;
  shared->dim_LLdeaths_12 = shared->dim_LLdeaths_1 * shared->dim_LLdeaths_2;
  shared->dim_LLinfs = shared->dim_LLinfs_1 * shared->dim_LLinfs_2 * shared->dim_LLinfs_3;
  shared->dim_LLinfs_12 = shared->dim_LLinfs_1 * shared->dim_LLinfs_2;
  shared->dim_LR = shared->dim_LR_1 * shared->dim_LR_2 * shared->dim_LR_3;
  shared->dim_LR_12 = shared->dim_LR_1 * shared->dim_LR_2;
  shared->dim_LR_inmigr = shared->dim_LR_inmigr_1 * shared->dim_LR_inmigr_2 * shared->dim_LR_inmigr_3;
  shared->dim_LR_inmigr_12 = shared->dim_LR_inmigr_1 * shared->dim_LR_inmigr_2;
  shared->dim_LRdeaths = shared->dim_LRdeaths_1 * shared->dim_LRdeaths_2 * shared->dim_LRdeaths_3;
  shared->dim_LRdeaths_12 = shared->dim_LRdeaths_1 * shared->dim_LRdeaths_2;
  shared->dim_MM = shared->dim_MM_1 * shared->dim_MM_2;
  shared->dim_N = shared->dim_N_1 * shared->dim_N_2 * shared->dim_N_3;
  shared->dim_N_12 = shared->dim_N_1 * shared->dim_N_2;
  shared->dim_Nevents_D = shared->dim_Nevents_D_1 * shared->dim_Nevents_D_2 * shared->dim_Nevents_D_3;
  shared->dim_Nevents_D_12 = shared->dim_Nevents_D_1 * shared->dim_Nevents_D_2;
  shared->dim_Nevents_LL = shared->dim_Nevents_LL_1 * shared->dim_Nevents_LL_2 * shared->dim_Nevents_LL_3;
  shared->dim_Nevents_LL_12 = shared->dim_Nevents_LL_1 * shared->dim_Nevents_LL_2;
  shared->dim_Nevents_LR = shared->dim_Nevents_LR_1 * shared->dim_Nevents_LR_2 * shared->dim_Nevents_LR_3;
  shared->dim_Nevents_LR_12 = shared->dim_Nevents_LR_1 * shared->dim_Nevents_LR_2;
  shared->dim_Nevents_R = shared->dim_Nevents_R_1 * shared->dim_Nevents_R_2 * shared->dim_Nevents_R_3;
  shared->dim_Nevents_R_12 = shared->dim_Nevents_R_1 * shared->dim_Nevents_R_2;
  shared->dim_Nevents_SC = shared->dim_Nevents_SC_1 * shared->dim_Nevents_SC_2 * shared->dim_Nevents_SC_3;
  shared->dim_Nevents_SC_12 = shared->dim_Nevents_SC_1 * shared->dim_Nevents_SC_2;
  shared->dim_Nevents_Tr = shared->dim_Nevents_Tr_1 * shared->dim_Nevents_Tr_2 * shared->dim_Nevents_Tr_3;
  shared->dim_Nevents_Tr_12 = shared->dim_Nevents_Tr_1 * shared->dim_Nevents_Tr_2;
  shared->dim_Nevents_U = shared->dim_Nevents_U_1 * shared->dim_Nevents_U_2 * shared->dim_Nevents_U_3;
  shared->dim_Nevents_U_12 = shared->dim_Nevents_U_1 * shared->dim_Nevents_U_2;
  shared->dim_notes = shared->dim_notes_1 * shared->dim_notes_2 * shared->dim_notes_3;
  shared->dim_notes_12 = shared->dim_notes_1 * shared->dim_notes_2;
  shared->dim_NotesByPatchPatch = shared->dim_NotesByPatchPatch_1 * shared->dim_NotesByPatchPatch_2;
  shared->dim_notifrate = shared->dim_notifrate_1 * shared->dim_notifrate_2 * shared->dim_notifrate_3;
  shared->dim_notifrate_12 = shared->dim_notifrate_1 * shared->dim_notifrate_2;
  shared->dim_p_Dage = shared->dim_p_Dage_1 * shared->dim_p_Dage_2 * shared->dim_p_Dage_3;
  shared->dim_p_Dage_12 = shared->dim_p_Dage_1 * shared->dim_p_Dage_2;
  shared->dim_p_detect = shared->dim_p_detect_1 * shared->dim_p_detect_2 * shared->dim_p_detect_3;
  shared->dim_p_detect_12 = shared->dim_p_detect_1 * shared->dim_p_detect_2;
  shared->dim_p_detect_SC = shared->dim_p_detect_SC_1 * shared->dim_p_detect_SC_2 * shared->dim_p_detect_SC_3;
  shared->dim_p_detect_SC_12 = shared->dim_p_detect_SC_1 * shared->dim_p_detect_SC_2;
  shared->dim_p_DHIV = shared->dim_p_DHIV_1 * shared->dim_p_DHIV_2 * shared->dim_p_DHIV_3;
  shared->dim_p_DHIV_12 = shared->dim_p_DHIV_1 * shared->dim_p_DHIV_2;
  shared->dim_p_LLage = shared->dim_p_LLage_1 * shared->dim_p_LLage_2 * shared->dim_p_LLage_3;
  shared->dim_p_LLage_12 = shared->dim_p_LLage_1 * shared->dim_p_LLage_2;
  shared->dim_p_LLHIV = shared->dim_p_LLHIV_1 * shared->dim_p_LLHIV_2 * shared->dim_p_LLHIV_3;
  shared->dim_p_LLHIV_12 = shared->dim_p_LLHIV_1 * shared->dim_p_LLHIV_2;
  shared->dim_p_LLinfs = shared->dim_p_LLinfs_1 * shared->dim_p_LLinfs_2 * shared->dim_p_LLinfs_3;
  shared->dim_p_LLinfs_12 = shared->dim_p_LLinfs_1 * shared->dim_p_LLinfs_2;
  shared->dim_p_LRage = shared->dim_p_LRage_1 * shared->dim_p_LRage_2 * shared->dim_p_LRage_3;
  shared->dim_p_LRage_12 = shared->dim_p_LRage_1 * shared->dim_p_LRage_2;
  shared->dim_p_LRHIV = shared->dim_p_LRHIV_1 * shared->dim_p_LRHIV_2 * shared->dim_p_LRHIV_3;
  shared->dim_p_LRHIV_12 = shared->dim_p_LRHIV_1 * shared->dim_p_LRHIV_2;
  shared->dim_p_progFast = shared->dim_p_progFast_1 * shared->dim_p_progFast_2 * shared->dim_p_progFast_3;
  shared->dim_p_progFast_12 = shared->dim_p_progFast_1 * shared->dim_p_progFast_2;
  shared->dim_p_progress = shared->dim_p_progress_1 * shared->dim_p_progress_2 * shared->dim_p_progress_3;
  shared->dim_p_progress_12 = shared->dim_p_progress_1 * shared->dim_p_progress_2;
  shared->dim_p_progSlow = shared->dim_p_progSlow_1 * shared->dim_p_progSlow_2 * shared->dim_p_progSlow_3;
  shared->dim_p_progSlow_12 = shared->dim_p_progSlow_1 * shared->dim_p_progSlow_2;
  shared->dim_p_Rage = shared->dim_p_Rage_1 * shared->dim_p_Rage_2 * shared->dim_p_Rage_3;
  shared->dim_p_Rage_12 = shared->dim_p_Rage_1 * shared->dim_p_Rage_2;
  shared->dim_p_regress = shared->dim_p_regress_1 * shared->dim_p_regress_2 * shared->dim_p_regress_3;
  shared->dim_p_regress_12 = shared->dim_p_regress_1 * shared->dim_p_regress_2;
  shared->dim_p_relapse = shared->dim_p_relapse_1 * shared->dim_p_relapse_2 * shared->dim_p_relapse_3;
  shared->dim_p_relapse_12 = shared->dim_p_relapse_1 * shared->dim_p_relapse_2;
  shared->dim_p_RHIV = shared->dim_p_RHIV_1 * shared->dim_p_RHIV_2 * shared->dim_p_RHIV_3;
  shared->dim_p_RHIV_12 = shared->dim_p_RHIV_1 * shared->dim_p_RHIV_2;
  shared->dim_p_Rinfs = shared->dim_p_Rinfs_1 * shared->dim_p_Rinfs_2 * shared->dim_p_Rinfs_3;
  shared->dim_p_Rinfs_12 = shared->dim_p_Rinfs_1 * shared->dim_p_Rinfs_2;
  shared->dim_p_SCage = shared->dim_p_SCage_1 * shared->dim_p_SCage_2 * shared->dim_p_SCage_3;
  shared->dim_p_SCage_12 = shared->dim_p_SCage_1 * shared->dim_p_SCage_2;
  shared->dim_p_SCHIV = shared->dim_p_SCHIV_1 * shared->dim_p_SCHIV_2 * shared->dim_p_SCHIV_3;
  shared->dim_p_SCHIV_12 = shared->dim_p_SCHIV_1 * shared->dim_p_SCHIV_2;
  shared->dim_p_selfcr = shared->dim_p_selfcr_1 * shared->dim_p_selfcr_2 * shared->dim_p_selfcr_3;
  shared->dim_p_selfcr_12 = shared->dim_p_selfcr_1 * shared->dim_p_selfcr_2;
  shared->dim_p_selfcr_SC = shared->dim_p_selfcr_SC_1 * shared->dim_p_selfcr_SC_2 * shared->dim_p_selfcr_SC_3;
  shared->dim_p_selfcr_SC_12 = shared->dim_p_selfcr_SC_1 * shared->dim_p_selfcr_SC_2;
  shared->dim_p_stabilise = shared->dim_p_stabilise_1 * shared->dim_p_stabilise_2 * shared->dim_p_stabilise_3;
  shared->dim_p_stabilise_12 = shared->dim_p_stabilise_1 * shared->dim_p_stabilise_2;
  shared->dim_p_TBdeaths = shared->dim_p_TBdeaths_1 * shared->dim_p_TBdeaths_2 * shared->dim_p_TBdeaths_3;
  shared->dim_p_TBdeaths_12 = shared->dim_p_TBdeaths_1 * shared->dim_p_TBdeaths_2;
  shared->dim_p_TBdeaths_SC = shared->dim_p_TBdeaths_SC_1 * shared->dim_p_TBdeaths_SC_2 * shared->dim_p_TBdeaths_SC_3;
  shared->dim_p_TBdeaths_SC_12 = shared->dim_p_TBdeaths_SC_1 * shared->dim_p_TBdeaths_SC_2;
  shared->dim_p_Trage = shared->dim_p_Trage_1 * shared->dim_p_Trage_2 * shared->dim_p_Trage_3;
  shared->dim_p_Trage_12 = shared->dim_p_Trage_1 * shared->dim_p_Trage_2;
  shared->dim_p_TrHIV = shared->dim_p_TrHIV_1 * shared->dim_p_TrHIV_2 * shared->dim_p_TrHIV_3;
  shared->dim_p_TrHIV_12 = shared->dim_p_TrHIV_1 * shared->dim_p_TrHIV_2;
  shared->dim_p_Trsuccess = shared->dim_p_Trsuccess_1 * shared->dim_p_Trsuccess_2 * shared->dim_p_Trsuccess_3;
  shared->dim_p_Trsuccess_12 = shared->dim_p_Trsuccess_1 * shared->dim_p_Trsuccess_2;
  shared->dim_p_Trxdeaths = shared->dim_p_Trxdeaths_1 * shared->dim_p_Trxdeaths_2 * shared->dim_p_Trxdeaths_3;
  shared->dim_p_Trxdeaths_12 = shared->dim_p_Trxdeaths_1 * shared->dim_p_Trxdeaths_2;
  shared->dim_p_Uage = shared->dim_p_Uage_1 * shared->dim_p_Uage_2 * shared->dim_p_Uage_3;
  shared->dim_p_Uage_12 = shared->dim_p_Uage_1 * shared->dim_p_Uage_2;
  shared->dim_p_UHIV = shared->dim_p_UHIV_1 * shared->dim_p_UHIV_2 * shared->dim_p_UHIV_3;
  shared->dim_p_UHIV_12 = shared->dim_p_UHIV_1 * shared->dim_p_UHIV_2;
  shared->dim_p_Uinf = shared->dim_p_Uinf_1 * shared->dim_p_Uinf_2 * shared->dim_p_Uinf_3;
  shared->dim_p_Uinf_12 = shared->dim_p_Uinf_1 * shared->dim_p_Uinf_2;
  shared->dim_pD_inmigr = shared->dim_pD_inmigr_1 * shared->dim_pD_inmigr_2 * shared->dim_pD_inmigr_3;
  shared->dim_pD_inmigr_12 = shared->dim_pD_inmigr_1 * shared->dim_pD_inmigr_2;
  shared->dim_Pellij = shared->dim_Pellij_1 * shared->dim_Pellij_2;
  shared->dim_pLL_inmigr = shared->dim_pLL_inmigr_1 * shared->dim_pLL_inmigr_2 * shared->dim_pLL_inmigr_3;
  shared->dim_pLL_inmigr_12 = shared->dim_pLL_inmigr_1 * shared->dim_pLL_inmigr_2;
  shared->dim_pLR_inmigr = shared->dim_pLR_inmigr_1 * shared->dim_pLR_inmigr_2 * shared->dim_pLR_inmigr_3;
  shared->dim_pLR_inmigr_12 = shared->dim_pLR_inmigr_1 * shared->dim_pLR_inmigr_2;
  shared->dim_popinit_byage = shared->dim_popinit_byage_1 * shared->dim_popinit_byage_2;
  shared->dim_pR_inmigr = shared->dim_pR_inmigr_1 * shared->dim_pR_inmigr_2 * shared->dim_pR_inmigr_3;
  shared->dim_pR_inmigr_12 = shared->dim_pR_inmigr_1 * shared->dim_pR_inmigr_2;
  shared->dim_progFast = shared->dim_progFast_1 * shared->dim_progFast_2 * shared->dim_progFast_3;
  shared->dim_progFast_12 = shared->dim_progFast_1 * shared->dim_progFast_2;
  shared->dim_progress = shared->dim_progress_1 * shared->dim_progress_2 * shared->dim_progress_3;
  shared->dim_progress_12 = shared->dim_progress_1 * shared->dim_progress_2;
  shared->dim_progSlow = shared->dim_progSlow_1 * shared->dim_progSlow_2 * shared->dim_progSlow_3;
  shared->dim_progSlow_12 = shared->dim_progSlow_1 * shared->dim_progSlow_2;
  shared->dim_pSC_inmigr = shared->dim_pSC_inmigr_1 * shared->dim_pSC_inmigr_2 * shared->dim_pSC_inmigr_3;
  shared->dim_pSC_inmigr_12 = shared->dim_pSC_inmigr_1 * shared->dim_pSC_inmigr_2;
  shared->dim_pTr_inmigr = shared->dim_pTr_inmigr_1 * shared->dim_pTr_inmigr_2 * shared->dim_pTr_inmigr_3;
  shared->dim_pTr_inmigr_12 = shared->dim_pTr_inmigr_1 * shared->dim_pTr_inmigr_2;
  shared->dim_pU_inmigr = shared->dim_pU_inmigr_1 * shared->dim_pU_inmigr_2 * shared->dim_pU_inmigr_3;
  shared->dim_pU_inmigr_12 = shared->dim_pU_inmigr_1 * shared->dim_pU_inmigr_2;
  shared->dim_R = shared->dim_R_1 * shared->dim_R_2 * shared->dim_R_3;
  shared->dim_R_12 = shared->dim_R_1 * shared->dim_R_2;
  shared->dim_R_inmigr = shared->dim_R_inmigr_1 * shared->dim_R_inmigr_2 * shared->dim_R_inmigr_3;
  shared->dim_R_inmigr_12 = shared->dim_R_inmigr_1 * shared->dim_R_inmigr_2;
  shared->dim_rate_D = shared->dim_rate_D_1 * shared->dim_rate_D_2 * shared->dim_rate_D_3;
  shared->dim_rate_D_12 = shared->dim_rate_D_1 * shared->dim_rate_D_2;
  shared->dim_rate_LL = shared->dim_rate_LL_1 * shared->dim_rate_LL_2 * shared->dim_rate_LL_3;
  shared->dim_rate_LL_12 = shared->dim_rate_LL_1 * shared->dim_rate_LL_2;
  shared->dim_rate_LR = shared->dim_rate_LR_1 * shared->dim_rate_LR_2 * shared->dim_rate_LR_3;
  shared->dim_rate_LR_12 = shared->dim_rate_LR_1 * shared->dim_rate_LR_2;
  shared->dim_rate_R = shared->dim_rate_R_1 * shared->dim_rate_R_2 * shared->dim_rate_R_3;
  shared->dim_rate_R_12 = shared->dim_rate_R_1 * shared->dim_rate_R_2;
  shared->dim_rate_SC = shared->dim_rate_SC_1 * shared->dim_rate_SC_2 * shared->dim_rate_SC_3;
  shared->dim_rate_SC_12 = shared->dim_rate_SC_1 * shared->dim_rate_SC_2;
  shared->dim_rate_Tr = shared->dim_rate_Tr_1 * shared->dim_rate_Tr_2 * shared->dim_rate_Tr_3;
  shared->dim_rate_Tr_12 = shared->dim_rate_Tr_1 * shared->dim_rate_Tr_2;
  shared->dim_rate_U = shared->dim_rate_U_1 * shared->dim_rate_U_2 * shared->dim_rate_U_3;
  shared->dim_rate_U_12 = shared->dim_rate_U_1 * shared->dim_rate_U_2;
  shared->dim_Rdeaths = shared->dim_Rdeaths_1 * shared->dim_Rdeaths_2 * shared->dim_Rdeaths_3;
  shared->dim_Rdeaths_12 = shared->dim_Rdeaths_1 * shared->dim_Rdeaths_2;
  shared->dim_regress = shared->dim_regress_1 * shared->dim_regress_2 * shared->dim_regress_3;
  shared->dim_regress_12 = shared->dim_regress_1 * shared->dim_regress_2;
  shared->dim_relapse = shared->dim_relapse_1 * shared->dim_relapse_2 * shared->dim_relapse_3;
  shared->dim_relapse_12 = shared->dim_relapse_1 * shared->dim_relapse_2;
  shared->dim_Rinfs = shared->dim_Rinfs_1 * shared->dim_Rinfs_2 * shared->dim_Rinfs_3;
  shared->dim_Rinfs_12 = shared->dim_Rinfs_1 * shared->dim_Rinfs_2;
  shared->dim_SC = shared->dim_SC_1 * shared->dim_SC_2 * shared->dim_SC_3;
  shared->dim_SC_12 = shared->dim_SC_1 * shared->dim_SC_2;
  shared->dim_SC_inmigr = shared->dim_SC_inmigr_1 * shared->dim_SC_inmigr_2 * shared->dim_SC_inmigr_3;
  shared->dim_SC_inmigr_12 = shared->dim_SC_inmigr_1 * shared->dim_SC_inmigr_2;
  shared->dim_SCdeaths = shared->dim_SCdeaths_1 * shared->dim_SCdeaths_2 * shared->dim_SCdeaths_3;
  shared->dim_SCdeaths_12 = shared->dim_SCdeaths_1 * shared->dim_SCdeaths_2;
  shared->dim_selfcure = shared->dim_selfcure_1 * shared->dim_selfcure_2 * shared->dim_selfcure_3;
  shared->dim_selfcure_12 = shared->dim_selfcure_1 * shared->dim_selfcure_2;
  shared->dim_selfcure_SC = shared->dim_selfcure_SC_1 * shared->dim_selfcure_SC_2 * shared->dim_selfcure_SC_3;
  shared->dim_selfcure_SC_12 = shared->dim_selfcure_SC_1 * shared->dim_selfcure_SC_2;
  shared->dim_Sij = shared->dim_Sij_1 * shared->dim_Sij_2;
  shared->dim_stabilisations = shared->dim_stabilisations_1 * shared->dim_stabilisations_2 * shared->dim_stabilisations_3;
  shared->dim_stabilisations_12 = shared->dim_stabilisations_1 * shared->dim_stabilisations_2;
  shared->dim_TB_deaths = shared->dim_TB_deaths_1 * shared->dim_TB_deaths_2 * shared->dim_TB_deaths_3;
  shared->dim_TB_deaths_12 = shared->dim_TB_deaths_1 * shared->dim_TB_deaths_2;
  shared->dim_TBdeaths = shared->dim_TBdeaths_1 * shared->dim_TBdeaths_2 * shared->dim_TBdeaths_3;
  shared->dim_TBdeaths_12 = shared->dim_TBdeaths_1 * shared->dim_TBdeaths_2;
  shared->dim_TBdeaths_SC = shared->dim_TBdeaths_SC_1 * shared->dim_TBdeaths_SC_2 * shared->dim_TBdeaths_SC_3;
  shared->dim_TBdeaths_SC_12 = shared->dim_TBdeaths_SC_1 * shared->dim_TBdeaths_SC_2;
  shared->dim_tbi_D = shared->dim_tbi_D_1 * shared->dim_tbi_D_2;
  shared->dim_tbi_LL = shared->dim_tbi_LL_1 * shared->dim_tbi_LL_2;
  shared->dim_tbi_LR = shared->dim_tbi_LR_1 * shared->dim_tbi_LR_2;
  shared->dim_tbi_R = shared->dim_tbi_R_1 * shared->dim_tbi_R_2;
  shared->dim_tbi_SC = shared->dim_tbi_SC_1 * shared->dim_tbi_SC_2;
  shared->dim_tbi_Tr = shared->dim_tbi_Tr_1 * shared->dim_tbi_Tr_2;
  shared->dim_tbi_U = shared->dim_tbi_U_1 * shared->dim_tbi_U_2;
  shared->dim_Tijk = shared->dim_Tijk_1 * shared->dim_Tijk_2 * shared->dim_Tijk_3;
  shared->dim_Tijk_12 = shared->dim_Tijk_1 * shared->dim_Tijk_2;
  shared->dim_Tr = shared->dim_Tr_1 * shared->dim_Tr_2 * shared->dim_Tr_3;
  shared->dim_Tr_12 = shared->dim_Tr_1 * shared->dim_Tr_2;
  shared->dim_Tr_inmigr = shared->dim_Tr_inmigr_1 * shared->dim_Tr_inmigr_2 * shared->dim_Tr_inmigr_3;
  shared->dim_Tr_inmigr_12 = shared->dim_Tr_inmigr_1 * shared->dim_Tr_inmigr_2;
  shared->dim_Trdeaths = shared->dim_Trdeaths_1 * shared->dim_Trdeaths_2 * shared->dim_Trdeaths_3;
  shared->dim_Trdeaths_12 = shared->dim_Trdeaths_1 * shared->dim_Trdeaths_2;
  shared->dim_Trsuccess = shared->dim_Trsuccess_1 * shared->dim_Trsuccess_2 * shared->dim_Trsuccess_3;
  shared->dim_Trsuccess_12 = shared->dim_Trsuccess_1 * shared->dim_Trsuccess_2;
  shared->dim_Trxdeaths = shared->dim_Trxdeaths_1 * shared->dim_Trxdeaths_2 * shared->dim_Trxdeaths_3;
  shared->dim_Trxdeaths_12 = shared->dim_Trxdeaths_1 * shared->dim_Trxdeaths_2;
  shared->dim_U = shared->dim_U_1 * shared->dim_U_2 * shared->dim_U_3;
  shared->dim_U_12 = shared->dim_U_1 * shared->dim_U_2;
  shared->dim_U_inmigr = shared->dim_U_inmigr_1 * shared->dim_U_inmigr_2 * shared->dim_U_inmigr_3;
  shared->dim_U_inmigr_12 = shared->dim_U_inmigr_1 * shared->dim_U_inmigr_2;
  shared->dim_Udeaths = shared->dim_Udeaths_1 * shared->dim_Udeaths_2 * shared->dim_Udeaths_3;
  shared->dim_Udeaths_12 = shared->dim_Udeaths_1 * shared->dim_Udeaths_2;
  shared->dim_Uinfs = shared->dim_Uinfs_1 * shared->dim_Uinfs_2 * shared->dim_Uinfs_3;
  shared->dim_Uinfs_12 = shared->dim_Uinfs_1 * shared->dim_Uinfs_2;
  shared->Hirr = user_get_array_fixed<real_type, 1>(user, "Hirr", shared->Hirr, {shared->dim_Hirr}, NA_REAL, NA_REAL);
  shared->IRR = user_get_array_fixed<real_type, 1>(user, "IRR", shared->IRR, {shared->dim_IRR}, NA_REAL, NA_REAL);
  shared->Pdelta = shared->dtct_rate;
  shared->popinit = user_get_array_fixed<real_type, 1>(user, "popinit", shared->popinit, {shared->dim_popinit}, NA_REAL, NA_REAL);
  shared->ppB = shared->Pepsilon * shared->Psigma / (real_type) (shared->Pepsilon - shared->Psigma - shared->Palpha);
  shared->TB_HIV_mod = user_get_array_fixed<real_type, 1>(user, "TB_HIV_mod", shared->TB_HIV_mod, {shared->dim_TB_HIV_mod}, NA_REAL, NA_REAL);
  shared->tt = user_get_array_fixed<real_type, 1>(user, "tt", shared->tt, {shared->dim_tt}, NA_REAL, NA_REAL);
  internal.age_in_D = std::vector<real_type>(shared->dim_age_in_D);
  internal.age_in_LL = std::vector<real_type>(shared->dim_age_in_LL);
  internal.age_in_LR = std::vector<real_type>(shared->dim_age_in_LR);
  internal.age_in_R = std::vector<real_type>(shared->dim_age_in_R);
  internal.age_in_SC = std::vector<real_type>(shared->dim_age_in_SC);
  internal.age_in_Tr = std::vector<real_type>(shared->dim_age_in_Tr);
  internal.age_in_U = std::vector<real_type>(shared->dim_age_in_U);
  internal.age_out_D = std::vector<real_type>(shared->dim_age_out_D);
  internal.age_out_LL = std::vector<real_type>(shared->dim_age_out_LL);
  internal.age_out_LR = std::vector<real_type>(shared->dim_age_out_LR);
  internal.age_out_R = std::vector<real_type>(shared->dim_age_out_R);
  internal.age_out_SC = std::vector<real_type>(shared->dim_age_out_SC);
  internal.age_out_Tr = std::vector<real_type>(shared->dim_age_out_Tr);
  internal.age_out_U = std::vector<real_type>(shared->dim_age_out_U);
  internal.births = std::vector<real_type>(shared->dim_births);
  internal.D_inmigr = std::vector<real_type>(shared->dim_D_inmigr);
  internal.Ddeaths = std::vector<real_type>(shared->dim_Ddeaths);
  internal.detection = std::vector<real_type>(shared->dim_detection);
  internal.detection_SC = std::vector<real_type>(shared->dim_detection_SC);
  internal.ellij = std::vector<real_type>(shared->dim_ellij);
  internal.foitemp = std::vector<real_type>(shared->dim_foitemp);
  internal.HIV_in_D = std::vector<real_type>(shared->dim_HIV_in_D);
  internal.HIV_in_LL = std::vector<real_type>(shared->dim_HIV_in_LL);
  internal.HIV_in_LR = std::vector<real_type>(shared->dim_HIV_in_LR);
  internal.HIV_in_R = std::vector<real_type>(shared->dim_HIV_in_R);
  internal.HIV_in_SC = std::vector<real_type>(shared->dim_HIV_in_SC);
  internal.HIV_in_Tr = std::vector<real_type>(shared->dim_HIV_in_Tr);
  internal.HIV_in_U = std::vector<real_type>(shared->dim_HIV_in_U);
  internal.HIV_out_D = std::vector<real_type>(shared->dim_HIV_out_D);
  internal.HIV_out_LL = std::vector<real_type>(shared->dim_HIV_out_LL);
  internal.HIV_out_LR = std::vector<real_type>(shared->dim_HIV_out_LR);
  internal.HIV_out_R = std::vector<real_type>(shared->dim_HIV_out_R);
  internal.HIV_out_SC = std::vector<real_type>(shared->dim_HIV_out_SC);
  internal.HIV_out_Tr = std::vector<real_type>(shared->dim_HIV_out_Tr);
  internal.HIV_out_U = std::vector<real_type>(shared->dim_HIV_out_U);
  internal.InfsByPatchPatch = std::vector<real_type>(shared->dim_InfsByPatchPatch);
  internal.init_D = std::vector<real_type>(shared->dim_init_D);
  internal.init_LL = std::vector<real_type>(shared->dim_init_LL);
  internal.init_LR = std::vector<real_type>(shared->dim_init_LR);
  internal.init_R = std::vector<real_type>(shared->dim_init_R);
  internal.init_SC = std::vector<real_type>(shared->dim_init_SC);
  internal.init_Tr = std::vector<real_type>(shared->dim_init_Tr);
  internal.init_U = std::vector<real_type>(shared->dim_init_U);
  shared->initDenom = std::vector<real_type>(shared->dim_initDenom);
  shared->initF = std::vector<real_type>(shared->dim_initF);
  shared->initial_bg_deaths = std::vector<real_type>(shared->dim_bg_deaths);
  shared->initial_cum_inf_flux = std::vector<real_type>(shared->dim_cum_inf_flux);
  shared->initial_cum_note_flux = std::vector<real_type>(shared->dim_cum_note_flux);
  internal.initial_D = std::vector<real_type>(shared->dim_D);
  shared->initial_incidence = std::vector<real_type>(shared->dim_incidence);
  internal.initial_LL = std::vector<real_type>(shared->dim_LL);
  internal.initial_LR = std::vector<real_type>(shared->dim_LR);
  internal.initial_N = std::vector<real_type>(shared->dim_N);
  shared->initial_notes = std::vector<real_type>(shared->dim_notes);
  shared->initial_notifrate = std::vector<real_type>(shared->dim_notifrate);
  internal.initial_R = std::vector<real_type>(shared->dim_R);
  internal.initial_SC = std::vector<real_type>(shared->dim_SC);
  shared->initial_Sij = std::vector<real_type>(shared->dim_Sij);
  shared->initial_TB_deaths = std::vector<real_type>(shared->dim_TB_deaths);
  shared->initial_Tijk = std::vector<real_type>(shared->dim_Tijk);
  internal.initial_Tr = std::vector<real_type>(shared->dim_Tr);
  internal.initial_U = std::vector<real_type>(shared->dim_U);
  shared->initLL = std::vector<real_type>(shared->dim_initLL);
  shared->initPrev = std::vector<real_type>(shared->dim_initPrev);
  internal.LL_inmigr = std::vector<real_type>(shared->dim_LL_inmigr);
  internal.LLdeaths = std::vector<real_type>(shared->dim_LLdeaths);
  internal.LLinfs = std::vector<real_type>(shared->dim_LLinfs);
  internal.LR_inmigr = std::vector<real_type>(shared->dim_LR_inmigr);
  internal.LRdeaths = std::vector<real_type>(shared->dim_LRdeaths);
  internal.Nevents_D = std::vector<real_type>(shared->dim_Nevents_D);
  internal.Nevents_LL = std::vector<real_type>(shared->dim_Nevents_LL);
  internal.Nevents_LR = std::vector<real_type>(shared->dim_Nevents_LR);
  internal.Nevents_R = std::vector<real_type>(shared->dim_Nevents_R);
  internal.Nevents_SC = std::vector<real_type>(shared->dim_Nevents_SC);
  internal.Nevents_Tr = std::vector<real_type>(shared->dim_Nevents_Tr);
  internal.Nevents_U = std::vector<real_type>(shared->dim_Nevents_U);
  internal.NotesByPatchPatch = std::vector<real_type>(shared->dim_NotesByPatchPatch);
  internal.p_Dage = std::vector<real_type>(shared->dim_p_Dage);
  internal.p_detect = std::vector<real_type>(shared->dim_p_detect);
  internal.p_detect_SC = std::vector<real_type>(shared->dim_p_detect_SC);
  internal.p_DHIV = std::vector<real_type>(shared->dim_p_DHIV);
  internal.p_LLage = std::vector<real_type>(shared->dim_p_LLage);
  internal.p_LLHIV = std::vector<real_type>(shared->dim_p_LLHIV);
  internal.p_LLinfs = std::vector<real_type>(shared->dim_p_LLinfs);
  internal.p_LRage = std::vector<real_type>(shared->dim_p_LRage);
  internal.p_LRHIV = std::vector<real_type>(shared->dim_p_LRHIV);
  internal.p_progFast = std::vector<real_type>(shared->dim_p_progFast);
  internal.p_progress = std::vector<real_type>(shared->dim_p_progress);
  internal.p_progSlow = std::vector<real_type>(shared->dim_p_progSlow);
  internal.p_Rage = std::vector<real_type>(shared->dim_p_Rage);
  internal.p_regress = std::vector<real_type>(shared->dim_p_regress);
  internal.p_relapse = std::vector<real_type>(shared->dim_p_relapse);
  internal.p_RHIV = std::vector<real_type>(shared->dim_p_RHIV);
  internal.p_Rinfs = std::vector<real_type>(shared->dim_p_Rinfs);
  internal.p_SCage = std::vector<real_type>(shared->dim_p_SCage);
  internal.p_SCHIV = std::vector<real_type>(shared->dim_p_SCHIV);
  internal.p_selfcr = std::vector<real_type>(shared->dim_p_selfcr);
  internal.p_selfcr_SC = std::vector<real_type>(shared->dim_p_selfcr_SC);
  internal.p_stabilise = std::vector<real_type>(shared->dim_p_stabilise);
  internal.p_TBdeaths = std::vector<real_type>(shared->dim_p_TBdeaths);
  internal.p_TBdeaths_SC = std::vector<real_type>(shared->dim_p_TBdeaths_SC);
  internal.p_Trage = std::vector<real_type>(shared->dim_p_Trage);
  internal.p_TrHIV = std::vector<real_type>(shared->dim_p_TrHIV);
  internal.p_Trsuccess = std::vector<real_type>(shared->dim_p_Trsuccess);
  internal.p_Trxdeaths = std::vector<real_type>(shared->dim_p_Trxdeaths);
  internal.p_Uage = std::vector<real_type>(shared->dim_p_Uage);
  internal.p_UHIV = std::vector<real_type>(shared->dim_p_UHIV);
  internal.p_Uinf = std::vector<real_type>(shared->dim_p_Uinf);
  internal.pD_inmigr = std::vector<real_type>(shared->dim_pD_inmigr);
  internal.Pellij = std::vector<real_type>(shared->dim_Pellij);
  internal.pLL_inmigr = std::vector<real_type>(shared->dim_pLL_inmigr);
  internal.pLR_inmigr = std::vector<real_type>(shared->dim_pLR_inmigr);
  internal.popinit_byage = std::vector<real_type>(shared->dim_popinit_byage);
  internal.pR_inmigr = std::vector<real_type>(shared->dim_pR_inmigr);
  internal.progFast = std::vector<real_type>(shared->dim_progFast);
  internal.progress = std::vector<real_type>(shared->dim_progress);
  internal.progSlow = std::vector<real_type>(shared->dim_progSlow);
  internal.pSC_inmigr = std::vector<real_type>(shared->dim_pSC_inmigr);
  internal.pTr_inmigr = std::vector<real_type>(shared->dim_pTr_inmigr);
  internal.pU_inmigr = std::vector<real_type>(shared->dim_pU_inmigr);
  internal.R_inmigr = std::vector<real_type>(shared->dim_R_inmigr);
  internal.rate_D = std::vector<real_type>(shared->dim_rate_D);
  internal.rate_LL = std::vector<real_type>(shared->dim_rate_LL);
  internal.rate_LR = std::vector<real_type>(shared->dim_rate_LR);
  internal.rate_R = std::vector<real_type>(shared->dim_rate_R);
  internal.rate_SC = std::vector<real_type>(shared->dim_rate_SC);
  internal.rate_Tr = std::vector<real_type>(shared->dim_rate_Tr);
  internal.rate_U = std::vector<real_type>(shared->dim_rate_U);
  internal.Rdeaths = std::vector<real_type>(shared->dim_Rdeaths);
  internal.regress = std::vector<real_type>(shared->dim_regress);
  internal.relapse = std::vector<real_type>(shared->dim_relapse);
  internal.Rinfs = std::vector<real_type>(shared->dim_Rinfs);
  internal.SC_inmigr = std::vector<real_type>(shared->dim_SC_inmigr);
  internal.SCdeaths = std::vector<real_type>(shared->dim_SCdeaths);
  internal.selfcure = std::vector<real_type>(shared->dim_selfcure);
  internal.selfcure_SC = std::vector<real_type>(shared->dim_selfcure_SC);
  internal.stabilisations = std::vector<real_type>(shared->dim_stabilisations);
  internal.TBdeaths = std::vector<real_type>(shared->dim_TBdeaths);
  internal.TBdeaths_SC = std::vector<real_type>(shared->dim_TBdeaths_SC);
  shared->tbi_D = std::vector<real_type>(shared->dim_tbi_D);
  shared->tbi_LL = std::vector<real_type>(shared->dim_tbi_LL);
  shared->tbi_LR = std::vector<real_type>(shared->dim_tbi_LR);
  shared->tbi_R = std::vector<real_type>(shared->dim_tbi_R);
  shared->tbi_SC = std::vector<real_type>(shared->dim_tbi_SC);
  shared->tbi_Tr = std::vector<real_type>(shared->dim_tbi_Tr);
  shared->tbi_U = std::vector<real_type>(shared->dim_tbi_U);
  internal.Tr_inmigr = std::vector<real_type>(shared->dim_Tr_inmigr);
  internal.Trdeaths = std::vector<real_type>(shared->dim_Trdeaths);
  internal.Trsuccess = std::vector<real_type>(shared->dim_Trsuccess);
  internal.Trxdeaths = std::vector<real_type>(shared->dim_Trxdeaths);
  internal.U_inmigr = std::vector<real_type>(shared->dim_U_inmigr);
  internal.Udeaths = std::vector<real_type>(shared->dim_Udeaths);
  internal.Uinfs = std::vector<real_type>(shared->dim_Uinfs);
  shared->initD = user_get_array_fixed<real_type, 2>(user, "initD", shared->initD, {shared->dim_initD_1, shared->dim_initD_2}, NA_REAL, NA_REAL);
  for (int i = 1; i <= shared->dim_bg_deaths_1; ++i) {
    for (int j = 1; j <= shared->dim_bg_deaths_2; ++j) {
      for (int k = 1; k <= shared->dim_bg_deaths_3; ++k) {
        shared->initial_bg_deaths[i - 1 + shared->dim_bg_deaths_1 * (j - 1) + shared->dim_bg_deaths_12 * (k - 1)] = 0;
      }
    }
  }
  for (int i = 1; i <= shared->dim_cum_inf_flux_1; ++i) {
    for (int j = 1; j <= shared->dim_cum_inf_flux_2; ++j) {
      shared->initial_cum_inf_flux[i - 1 + shared->dim_cum_inf_flux_1 * (j - 1)] = 0;
    }
  }
  for (int i = 1; i <= shared->dim_cum_note_flux_1; ++i) {
    for (int j = 1; j <= shared->dim_cum_note_flux_2; ++j) {
      shared->initial_cum_note_flux[i - 1 + shared->dim_cum_note_flux_1 * (j - 1)] = 0;
    }
  }
  for (int i = 1; i <= shared->dim_incidence_1; ++i) {
    for (int j = 1; j <= shared->dim_incidence_2; ++j) {
      for (int k = 1; k <= shared->dim_incidence_3; ++k) {
        shared->initial_incidence[i - 1 + shared->dim_incidence_1 * (j - 1) + shared->dim_incidence_12 * (k - 1)] = 0;
      }
    }
  }
  for (int i = 1; i <= shared->dim_notes_1; ++i) {
    for (int j = 1; j <= shared->dim_notes_2; ++j) {
      for (int k = 1; k <= shared->dim_notes_3; ++k) {
        shared->initial_notes[i - 1 + shared->dim_notes_1 * (j - 1) + shared->dim_notes_12 * (k - 1)] = 0;
      }
    }
  }
  for (int i = 1; i <= shared->dim_notifrate_1; ++i) {
    for (int j = 1; j <= shared->dim_notifrate_2; ++j) {
      for (int k = 1; k <= shared->dim_notifrate_3; ++k) {
        shared->initial_notifrate[i - 1 + shared->dim_notifrate_1 * (j - 1) + shared->dim_notifrate_12 * (k - 1)] = 0;
      }
    }
  }
  for (int i = 1; i <= shared->dim_Sij_1; ++i) {
    for (int j = 1; j <= shared->dim_Sij_2; ++j) {
      shared->initial_Sij[i - 1 + shared->dim_Sij_1 * (j - 1)] = 0;
    }
  }
  for (int i = 1; i <= shared->dim_TB_deaths_1; ++i) {
    for (int j = 1; j <= shared->dim_TB_deaths_2; ++j) {
      for (int k = 1; k <= shared->dim_TB_deaths_3; ++k) {
        shared->initial_TB_deaths[i - 1 + shared->dim_TB_deaths_1 * (j - 1) + shared->dim_TB_deaths_12 * (k - 1)] = 0;
      }
    }
  }
  for (int i = 1; i <= shared->dim_Tijk_1; ++i) {
    for (int j = 1; j <= shared->dim_Tijk_2; ++j) {
      for (int k = 1; k <= shared->dim_Tijk_3; ++k) {
        shared->initial_Tijk[i - 1 + shared->dim_Tijk_1 * (j - 1) + shared->dim_Tijk_12 * (k - 1)] = 0;
      }
    }
  }
  shared->MM = user_get_array_fixed<real_type, 2>(user, "MM", shared->MM, {shared->dim_MM_1, shared->dim_MM_2}, NA_REAL, NA_REAL);
  shared->offset_variable_bg_deaths = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_N + shared->dim_notes + shared->dim_notifrate + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_TB_deaths + shared->dim_Tr + shared->dim_U + 2;
  shared->offset_variable_cum_note_flux = shared->dim_cum_inf_flux + 2;
  shared->offset_variable_D = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_LL + shared->dim_LR + shared->dim_Sij + shared->dim_U + 2;
  shared->offset_variable_incidence = shared->dim_bg_deaths + shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_N + shared->dim_notes + shared->dim_notifrate + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_TB_deaths + shared->dim_Tr + shared->dim_U + 2;
  shared->offset_variable_LL = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_LR + shared->dim_Sij + shared->dim_U + 2;
  shared->offset_variable_LR = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_Sij + shared->dim_U + 2;
  shared->offset_variable_N = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_Tr + shared->dim_U + 2;
  shared->offset_variable_notes = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_N + shared->dim_notifrate + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_TB_deaths + shared->dim_Tr + shared->dim_U + 2;
  shared->offset_variable_notifrate = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_N + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_TB_deaths + shared->dim_Tr + shared->dim_U + 2;
  shared->offset_variable_R = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_SC + shared->dim_Sij + shared->dim_Tr + shared->dim_U + 2;
  shared->offset_variable_SC = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_Sij + shared->dim_U + 2;
  shared->offset_variable_Sij = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + 2;
  shared->offset_variable_TB_deaths = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_N + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_Tr + shared->dim_U + 2;
  shared->offset_variable_Tijk = shared->dim_bg_deaths + shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_incidence + shared->dim_LL + shared->dim_LR + shared->dim_N + shared->dim_notes + shared->dim_notifrate + shared->dim_R + shared->dim_SC + shared->dim_Sij + shared->dim_TB_deaths + shared->dim_Tr + shared->dim_U + 2;
  shared->offset_variable_Tr = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_D + shared->dim_LL + shared->dim_LR + shared->dim_SC + shared->dim_Sij + shared->dim_U + 2;
  shared->offset_variable_U = shared->dim_cum_inf_flux + shared->dim_cum_note_flux + shared->dim_Sij + 2;
  shared->ppC = shared->ppB + shared->Palpha;
  shared->ppG = - shared->Pdelta * shared->Pgamma * shared->ppB / (real_type) ((shared->Pgamma - shared->Pepsilon) * (shared->Pomega + shared->Pdelta - shared->Pepsilon));
  {
     int i = 1;
     shared->zk[i - 1] = shared->Pomega + shared->Pdelta + shared->Pmu;
  }
  {
     int i = 2;
     shared->zk[i - 1] = shared->Psigma + shared->Palpha + shared->Pmu;
  }
  {
     int i = 3;
     shared->zk[i - 1] = shared->Pepsilon + shared->Pmu;
  }
  {
     int i = 4;
     shared->zk[i - 1] = shared->Pgamma + shared->Pmu;
  }
  {
     int i = 5;
     shared->zk[i - 1] = shared->Prho + shared->Pmu;
  }
  {
     int i = 6;
     shared->zk[i - 1] = shared->Ptau + shared->Pmu;
  }
  for (int i = 1; i <= shared->dim_initPrev_1; ++i) {
    for (int j = 1; j <= shared->dim_initPrev_2; ++j) {
      shared->initPrev[i - 1 + shared->dim_initPrev_1 * (j - 1)] = dust::math::exp(- shared->ari0 * shared->ageMids[j - 1]) * (1 - 5 * shared->initD[shared->dim_initD_1 * (j - 1) + i - 1] / (real_type) 2);
    }
  }
  shared->ppF = shared->Pdelta * shared->Pgamma * shared->ppC / (real_type) ((shared->Pgamma - shared->Psigma - shared->Palpha) * (shared->Pomega + shared->Pdelta - shared->Psigma - shared->Palpha));
  shared->ppH = shared->Pdelta * shared->Pgamma * (shared->ppB / (real_type) (shared->Pgamma - shared->Pepsilon) - shared->ppC / (real_type) (shared->Pgamma - shared->Psigma - shared->Palpha)) / (real_type) (shared->Pomega + shared->Pdelta - shared->Pgamma);
  shared->ppJ = shared->Pdelta * shared->Pgamma * (shared->ppC * (1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Pgamma) - 1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Psigma - shared->Palpha)) / (real_type) (shared->Pgamma - shared->Psigma - shared->Palpha) + shared->ppB * (1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Pepsilon) - 1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Pgamma)) / (real_type) (shared->Pgamma - shared->Pepsilon));
  shared->A0 = shared->Prho * shared->Ptau * (shared->ppJ / (real_type) ((shared->Prho - shared->Pomega - shared->Pdelta) * (shared->Ptau - shared->Pomega - shared->Pdelta)));
  for (int i = 1; i <= shared->dim_initF_1; ++i) {
    for (int j = 1; j <= shared->dim_initF_2; ++j) {
      shared->initF[i - 1 + shared->dim_initF_1 * (j - 1)] = (1 - shared->initPrev[shared->dim_initPrev_1 * (j - 1) + i - 1]) * (1 - dust::math::exp(- 2 * shared->ari0)) * (1 - 5 * shared->initD[shared->dim_initD_1 * (j - 1) + i - 1] / (real_type) 2);
    }
  }
  for (int i = 1; i <= shared->dim_initLL_1; ++i) {
    for (int j = 1; j <= shared->dim_initLL_2; ++j) {
      shared->initLL[i - 1 + shared->dim_initLL_1 * (j - 1)] = (1 - shared->initPrev[shared->dim_initPrev_1 * (j - 1) + i - 1]) * dust::math::exp(- 2 * shared->ari0) * (1 - 5 * shared->initD[shared->dim_initD_1 * (j - 1) + i - 1] / (real_type) 2);
    }
  }
  shared->ppK = - shared->ppF / (real_type) (shared->Ptau - shared->Psigma - shared->Palpha) - shared->ppG / (real_type) (shared->Ptau - shared->Pepsilon) - shared->ppH / (real_type) (shared->Ptau - shared->Pgamma) - shared->ppJ / (real_type) (shared->Ptau - shared->Pomega - shared->Pdelta);
  {
     int i = 1;
     shared->A[i - 1] = - shared->Pgamma * shared->ppC / (real_type) ((shared->Pgamma - shared->Psigma - shared->Palpha) * (shared->Pomega + shared->Pdelta - shared->Psigma - shared->Palpha)) + shared->Pgamma * shared->ppB / (real_type) ((shared->Pgamma - shared->Pepsilon) * (shared->Pomega + shared->Pdelta - shared->Pepsilon)) - shared->Pgamma * (shared->ppB / (real_type) (shared->Pgamma - shared->Pepsilon) - shared->ppC / (real_type) (shared->Pgamma - shared->Psigma - shared->Palpha)) / (real_type) (shared->Pomega + shared->Pdelta - shared->Pgamma) - shared->Prho * shared->Ptau * (shared->ppF * (1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Psigma - shared->Palpha) - 1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Prho)) / (real_type) ((shared->Prho - shared->Psigma - shared->Palpha) * (shared->Ptau - shared->Psigma - shared->Palpha)) + shared->ppG * (1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Pepsilon) - 1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Prho)) / (real_type) ((shared->Prho - shared->Pepsilon) * (shared->Ptau - shared->Pepsilon)) + shared->ppH * (1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Pgamma) - 1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Prho)) / (real_type) ((shared->Prho - shared->Pgamma) * (shared->Ptau - shared->Pgamma)) + shared->ppJ * (- 1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Prho)) / (real_type) ((shared->Prho - shared->Pomega - shared->Pdelta) * (shared->Ptau - shared->Pomega - shared->Pdelta)) + shared->ppK * (1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Ptau) - 1 / (real_type) (shared->Pomega + shared->Pdelta - shared->Prho)) / (real_type) (shared->Prho - shared->Ptau));
  }
  {
     int i = 2;
     shared->A[i - 1] = shared->Pgamma * shared->ppC / (real_type) ((shared->Pgamma - shared->Psigma - shared->Palpha) * (shared->Pomega + shared->Pdelta - shared->Psigma - shared->Palpha)) + shared->Prho * shared->Ptau * (shared->ppF / (real_type) (shared->Pomega + shared->Pdelta - shared->Psigma - shared->Palpha)) / (real_type) ((shared->Prho - shared->Psigma - shared->Palpha) * (shared->Ptau - shared->Psigma - shared->Palpha));
  }
  {
     int i = 3;
     shared->A[i - 1] = - shared->Pgamma * shared->ppB / (real_type) ((shared->Pgamma - shared->Pepsilon) * (shared->Pomega + shared->Pdelta - shared->Pepsilon)) + shared->Prho * shared->Ptau * (shared->ppG / (real_type) (shared->Pomega + shared->Pdelta - shared->Pepsilon)) / (real_type) ((shared->Prho - shared->Pepsilon) * (shared->Ptau - shared->Pepsilon));
  }
  {
     int i = 4;
     shared->A[i - 1] = shared->Pgamma * (shared->ppB / (real_type) (shared->Pgamma - shared->Pepsilon) - shared->ppC / (real_type) (shared->Pgamma - shared->Psigma - shared->Palpha)) / (real_type) (shared->Pomega + shared->Pdelta - shared->Pgamma) + shared->Prho * shared->Ptau * (shared->ppH / (real_type) (shared->Pomega + shared->Pdelta - shared->Pgamma)) / (real_type) ((shared->Prho - shared->Pgamma) * (shared->Ptau - shared->Pgamma));
  }
  {
     int i = 5;
     shared->A[i - 1] = - shared->Prho * shared->Ptau * (shared->ppF / (real_type) ((shared->Prho - shared->Psigma - shared->Palpha) * (shared->Ptau - shared->Psigma - shared->Palpha)) + shared->ppG / (real_type) ((shared->Prho - shared->Pepsilon) * (shared->Ptau - shared->Pepsilon)) + shared->ppH / (real_type) ((shared->Prho - shared->Pgamma) * (shared->Ptau - shared->Pgamma)) + shared->ppJ / (real_type) ((shared->Prho - shared->Pomega - shared->Pdelta) * (shared->Ptau - shared->Pomega - shared->Pdelta)) + shared->ppK / (real_type) (shared->Prho - shared->Ptau)) / (real_type) (shared->Pomega + shared->Pdelta - shared->Prho);
  }
  {
     int i = 6;
     shared->A[i - 1] = shared->Prho * shared->Ptau * ((shared->ppK / (real_type) (shared->Pomega + shared->Pdelta - shared->Ptau)) / (real_type) (shared->Prho - shared->Ptau));
  }
  for (int i = 1; i <= shared->dim_initDenom_1; ++i) {
    for (int j = 1; j <= shared->dim_initDenom_2; ++j) {
      shared->initDenom[i - 1 + shared->dim_initDenom_1 * (j - 1)] = shared->initPrev[shared->dim_initPrev_1 * (j - 1) + i - 1] + shared->initF[shared->dim_initF_1 * (j - 1) + i - 1] + shared->initLL[shared->dim_initLL_1 * (j - 1) + i - 1] + 5 * shared->initD[shared->dim_initD_1 * (j - 1) + i - 1] / (real_type) 2;
    }
  }
  for (int i = 1; i <= shared->dim_tbi_D_1; ++i) {
    for (int j = 1; j <= shared->dim_tbi_D_2; ++j) {
      shared->tbi_D[i - 1 + shared->dim_tbi_D_1 * (j - 1)] = (shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] > shared->tol ? (shared->initD[shared->dim_initD_1 * (j - 1) + i - 1] / (real_type) 2) / (real_type) shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] : 0);
    }
  }
  for (int i = 1; i <= shared->dim_tbi_LL_1; ++i) {
    for (int j = 1; j <= shared->dim_tbi_LL_2; ++j) {
      shared->tbi_LL[i - 1 + shared->dim_tbi_LL_1 * (j - 1)] = (shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] > shared->tol ? (shared->initLL[shared->dim_initLL_1 * (j - 1) + i - 1]) / (real_type) shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] : 0);
    }
  }
  for (int i = 1; i <= shared->dim_tbi_LR_1; ++i) {
    for (int j = 1; j <= shared->dim_tbi_LR_2; ++j) {
      shared->tbi_LR[i - 1 + shared->dim_tbi_LR_1 * (j - 1)] = (shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] > shared->tol ? (shared->initF[shared->dim_initF_1 * (j - 1) + i - 1]) / (real_type) shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] : 0);
    }
  }
  for (int i = 1; i <= shared->dim_tbi_R_1; ++i) {
    for (int j = 1; j <= shared->dim_tbi_R_2; ++j) {
      shared->tbi_R[i - 1 + shared->dim_tbi_R_1 * (j - 1)] = (shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] > shared->tol ? (shared->initD[shared->dim_initD_1 * (j - 1) + i - 1]) / (real_type) shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] : 0);
    }
  }
  for (int i = 1; i <= shared->dim_tbi_SC_1; ++i) {
    for (int j = 1; j <= shared->dim_tbi_SC_2; ++j) {
      shared->tbi_SC[i - 1 + shared->dim_tbi_SC_1 * (j - 1)] = (shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] > shared->tol ? (shared->initD[shared->dim_initD_1 * (j - 1) + i - 1] / (real_type) 2) / (real_type) shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] : 0);
    }
  }
  for (int i = 1; i <= shared->dim_tbi_Tr_1; ++i) {
    for (int j = 1; j <= shared->dim_tbi_Tr_2; ++j) {
      shared->tbi_Tr[i - 1 + shared->dim_tbi_Tr_1 * (j - 1)] = (shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] > shared->tol ? (shared->initD[shared->dim_initD_1 * (j - 1) + i - 1] / (real_type) 2) / (real_type) shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] : 0);
    }
  }
  for (int i = 1; i <= shared->dim_tbi_U_1; ++i) {
    for (int j = 1; j <= shared->dim_tbi_U_2; ++j) {
      shared->tbi_U[i - 1 + shared->dim_tbi_U_1 * (j - 1)] = (shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] > shared->tol ? (shared->initPrev[shared->dim_initPrev_1 * (j - 1) + i - 1]) / (real_type) shared->initDenom[shared->dim_initDenom_1 * (j - 1) + i - 1] : 0);
    }
  }
  return dust::pars_type<stocm>(shared, internal);
}
template <>
cpp11::sexp dust_info<stocm>(const dust::pars_type<stocm>& pars) {
  const std::shared_ptr<const stocm::shared_type> shared = pars.shared;
  cpp11::writable::strings nms({"tot_incidence", "beta_test", "cum_inf_flux", "cum_note_flux", "Sij", "U", "LR", "LL", "D", "SC", "Tr", "R", "N", "TB_deaths", "notifrate", "notes", "bg_deaths", "incidence", "Tijk"});
  cpp11::writable::list dim(19);
  dim[0] = cpp11::writable::integers({1});
  dim[1] = cpp11::writable::integers({1});
  dim[2] = cpp11::writable::integers({shared->dim_cum_inf_flux_1, shared->dim_cum_inf_flux_2});
  dim[3] = cpp11::writable::integers({shared->dim_cum_note_flux_1, shared->dim_cum_note_flux_2});
  dim[4] = cpp11::writable::integers({shared->dim_Sij_1, shared->dim_Sij_2});
  dim[5] = cpp11::writable::integers({shared->dim_U_1, shared->dim_U_2, shared->dim_U_3});
  dim[6] = cpp11::writable::integers({shared->dim_LR_1, shared->dim_LR_2, shared->dim_LR_3});
  dim[7] = cpp11::writable::integers({shared->dim_LL_1, shared->dim_LL_2, shared->dim_LL_3});
  dim[8] = cpp11::writable::integers({shared->dim_D_1, shared->dim_D_2, shared->dim_D_3});
  dim[9] = cpp11::writable::integers({shared->dim_SC_1, shared->dim_SC_2, shared->dim_SC_3});
  dim[10] = cpp11::writable::integers({shared->dim_Tr_1, shared->dim_Tr_2, shared->dim_Tr_3});
  dim[11] = cpp11::writable::integers({shared->dim_R_1, shared->dim_R_2, shared->dim_R_3});
  dim[12] = cpp11::writable::integers({shared->dim_N_1, shared->dim_N_2, shared->dim_N_3});
  dim[13] = cpp11::writable::integers({shared->dim_TB_deaths_1, shared->dim_TB_deaths_2, shared->dim_TB_deaths_3});
  dim[14] = cpp11::writable::integers({shared->dim_notifrate_1, shared->dim_notifrate_2, shared->dim_notifrate_3});
  dim[15] = cpp11::writable::integers({shared->dim_notes_1, shared->dim_notes_2, shared->dim_notes_3});
  dim[16] = cpp11::writable::integers({shared->dim_bg_deaths_1, shared->dim_bg_deaths_2, shared->dim_bg_deaths_3});
  dim[17] = cpp11::writable::integers({shared->dim_incidence_1, shared->dim_incidence_2, shared->dim_incidence_3});
  dim[18] = cpp11::writable::integers({shared->dim_Tijk_1, shared->dim_Tijk_2, shared->dim_Tijk_3});
  dim.names() = nms;
  cpp11::writable::list index(19);
  index[0] = cpp11::writable::integers({1});
  index[1] = cpp11::writable::integers({2});
  index[2] = integer_sequence(3, shared->dim_cum_inf_flux);
  index[3] = integer_sequence(shared->offset_variable_cum_note_flux + 1, shared->dim_cum_note_flux);
  index[4] = integer_sequence(shared->offset_variable_Sij + 1, shared->dim_Sij);
  index[5] = integer_sequence(shared->offset_variable_U + 1, shared->dim_U);
  index[6] = integer_sequence(shared->offset_variable_LR + 1, shared->dim_LR);
  index[7] = integer_sequence(shared->offset_variable_LL + 1, shared->dim_LL);
  index[8] = integer_sequence(shared->offset_variable_D + 1, shared->dim_D);
  index[9] = integer_sequence(shared->offset_variable_SC + 1, shared->dim_SC);
  index[10] = integer_sequence(shared->offset_variable_Tr + 1, shared->dim_Tr);
  index[11] = integer_sequence(shared->offset_variable_R + 1, shared->dim_R);
  index[12] = integer_sequence(shared->offset_variable_N + 1, shared->dim_N);
  index[13] = integer_sequence(shared->offset_variable_TB_deaths + 1, shared->dim_TB_deaths);
  index[14] = integer_sequence(shared->offset_variable_notifrate + 1, shared->dim_notifrate);
  index[15] = integer_sequence(shared->offset_variable_notes + 1, shared->dim_notes);
  index[16] = integer_sequence(shared->offset_variable_bg_deaths + 1, shared->dim_bg_deaths);
  index[17] = integer_sequence(shared->offset_variable_incidence + 1, shared->dim_incidence);
  index[18] = integer_sequence(shared->offset_variable_Tijk + 1, shared->dim_Tijk);
  index.names() = nms;
  size_t len = shared->offset_variable_Tijk + shared->dim_Tijk;
  using namespace cpp11::literals;
  return cpp11::writable::list({
           "dim"_nm = dim,
           "len"_nm = len,
           "index"_nm = index});
}
}

cpp11::sexp dust_stocm_gpu_info() {
  return dust::gpu::r::gpu_info();
}
using model_cpu = dust::dust_cpu<stocm>;

cpp11::sexp dust_cpu_stocm_capabilities() {
  return dust::r::dust_capabilities<model_cpu>();
}

SEXP dust_cpu_stocm_alloc(cpp11::list r_pars, bool pars_multi, cpp11::sexp r_time,
                             cpp11::sexp r_n_particles, int n_threads,
                             cpp11::sexp r_seed, bool deterministic,
                             cpp11::sexp gpu_config, cpp11::sexp ode_control) {
  return dust::r::dust_cpu_alloc<stocm>(r_pars, pars_multi, r_time, r_n_particles,
                                        n_threads, r_seed, deterministic,
                                        gpu_config, ode_control);
}

SEXP dust_cpu_stocm_run(SEXP ptr, cpp11::sexp r_time_end) {
  return dust::r::dust_run<model_cpu>(ptr, r_time_end);
}

SEXP dust_cpu_stocm_simulate(SEXP ptr, cpp11::sexp r_time_end) {
  return dust::r::dust_simulate<model_cpu>(ptr, r_time_end);
}

SEXP dust_cpu_stocm_run_adjoint(SEXP ptr) {
  return dust::r::dust_run_adjoint<model_cpu>(ptr);
}

SEXP dust_cpu_stocm_set_index(SEXP ptr, cpp11::sexp r_index) {
  dust::r::dust_set_index<model_cpu>(ptr, r_index);
  return R_NilValue;
}

SEXP dust_cpu_stocm_update_state(SEXP ptr, SEXP r_pars, SEXP r_state,
                                           SEXP r_time, SEXP r_set_initial_state, SEXP index, SEXP reset_step_size) {
  return dust::r::dust_update_state<model_cpu>(ptr, r_pars, r_state, r_time,
                                                      r_set_initial_state, index, reset_step_size);
}

SEXP dust_cpu_stocm_state(SEXP ptr, SEXP r_index) {
  return dust::r::dust_state<model_cpu>(ptr, r_index);
}

SEXP dust_cpu_stocm_time(SEXP ptr) {
  return dust::r::dust_time<model_cpu>(ptr);
}

void dust_cpu_stocm_reorder(SEXP ptr, cpp11::sexp r_index) {
  return dust::r::dust_reorder<model_cpu>(ptr, r_index);
}

SEXP dust_cpu_stocm_resample(SEXP ptr, cpp11::doubles r_weights) {
  return dust::r::dust_resample<model_cpu>(ptr, r_weights);
}

SEXP dust_cpu_stocm_rng_state(SEXP ptr, bool first_only, bool last_only) {
  return dust::r::dust_rng_state<model_cpu>(ptr, first_only, last_only);
}

SEXP dust_cpu_stocm_set_rng_state(SEXP ptr, cpp11::raws rng_state) {
  dust::r::dust_set_rng_state<model_cpu>(ptr, rng_state);
  return R_NilValue;
}

SEXP dust_cpu_stocm_set_data(SEXP ptr, cpp11::list data,
                                       bool shared) {
  dust::r::dust_set_data<model_cpu>(ptr, data, shared);
  return R_NilValue;
}

SEXP dust_cpu_stocm_compare_data(SEXP ptr) {
  return dust::r::dust_compare_data<model_cpu>(ptr);
}

SEXP dust_cpu_stocm_filter(SEXP ptr, SEXP time_end,
                                     bool save_trajectories,
                                     cpp11::sexp time_snapshot,
                                     cpp11::sexp min_log_likelihood) {
  return dust::r::dust_filter<model_cpu>(ptr, time_end,
                                                save_trajectories,
                                                time_snapshot,
                                                min_log_likelihood);
}

void dust_cpu_stocm_set_n_threads(SEXP ptr, int n_threads) {
  return dust::r::dust_set_n_threads<model_cpu>(ptr, n_threads);
}

int dust_cpu_stocm_n_state(SEXP ptr) {
  return dust::r::dust_n_state<model_cpu>(ptr);
}

void dust_cpu_stocm_set_stochastic_schedule(SEXP ptr, SEXP time) {
  dust::r::dust_set_stochastic_schedule<model_cpu>(ptr, time);
}

SEXP dust_cpu_stocm_ode_statistics(SEXP ptr) {
  return dust::r::dust_ode_statistics<model_cpu>(ptr);
}
